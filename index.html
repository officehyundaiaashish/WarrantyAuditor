<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warranty Self Auditor</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --bg-base: #f8fafc; --surface: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --primary: #0f172a; --primary-hover: #334155; --primary-text: #ffffff;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --accent: #3b82f6;
            --radius: 8px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); --modal-overlay: rgba(15, 23, 42, 0.6);
        }

        [data-theme="dark"] {
            --bg-base: #09090b; --surface: #18181b; --text-main: #f4f4f5; --text-muted: #a1a1aa;
            --border: #27272a; --primary: #ffffff; --primary-hover: #e4e4e7; --primary-text: #000000;
            --modal-overlay: rgba(0, 0, 0, 0.85);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-base); color: var(--text-main); min-height: 100vh; padding: 12px; font-size: 14px; -webkit-tap-highlight-color: transparent; }
        
        .card { background-color: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px; }
        
        /* Pleasing Header */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .app-title { font-size: 1.4rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(90deg, var(--accent), var(--success)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin:0; }
        
        h2, h3 { font-weight: 600; margin-bottom: 6px; letter-spacing: -0.3px; }
        p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; background-color: var(--surface); color: var(--text-main);
            border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; width: 100%; margin-bottom: 8px; transition: 0.15s;
        }
        .btn:active { transform: scale(0.97); }
        .btn.primary { background-color: var(--primary); color: var(--primary-text); border-color: var(--primary); }
        .btn.danger { color: var(--danger); border-color: var(--border); }

        .input, .select {
            width: 100%; background-color: var(--bg-base); color: var(--text-main); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 10px; font-size: 0.9rem; margin-bottom: 12px; transition: 0.2s;
        }
        .input:focus, .select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .screen { display: none; } .screen.active { display: block; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .grid-2 { display: grid; grid-template-columns: 1fr; gap: 8px; } @media (min-width: 500px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* Compact Table */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); -webkit-overflow-scrolling: touch; width: 100%; }
        table { width: max-content; min-width: 100%; border-collapse: collapse; text-align: left; font-size: 0.75rem; table-layout: auto; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { background-color: var(--bg-base); font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; }
        tr:hover td { background-color: var(--bg-base); cursor: pointer; }
        
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 2; border-right: 1px solid var(--border); font-weight: 600; }
        th:first-child { background-color: var(--bg-base); } td:first-child { background-color: var(--surface); }

        .status-clear { color: var(--success); font-weight: 600; }
        .status-unclear { color: var(--warning); font-weight: 600; }
        .status-pending { color: var(--text-muted); font-weight: 500;}

        /* Modals */
        .modal-backdrop { position: fixed; inset: 0; background-color: var(--modal-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.2s; backdrop-filter: blur(2px); }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-dialog { width: 100%; max-width: 420px; max-height: 90vh; display: flex; flex-direction: column; margin: 16px; background: var(--surface); border-radius: 12px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .modal-header { padding: 16px; border-bottom: 1px solid var(--border); background: var(--bg-base); }
        .modal-body { padding: 16px; overflow-y: auto; flex: 1; }
        
        .all-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: var(--bg-base); padding: 12px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 16px; }
        .detail-item span { display: block; } .detail-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; } .detail-val { font-size: 0.8rem; font-weight: 500; word-break: break-word; white-space: normal; }

        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .pagination .btn { width: auto; margin: 0; padding: 6px 12px; }

        #loader { position: fixed; inset: 0; background: var(--surface); z-index: 2000; display: none; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; color: var(--primary); }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; background: var(--bg-base); border: 1px solid var(--border); }
    </style>
</head>
<body>

    <div id="loader">Processing...</div>

    <div id="app-dialog" class="modal-backdrop">
        <div class="modal-dialog" style="max-width: 320px;">
            <div class="modal-body" style="text-align:center; padding: 24px;">
                <h3 id="dialog-msg" style="margin-bottom:16px; font-size:1rem; line-height: 1.4;"></h3>
                <input type="password" id="dialog-input" class="input" style="display:none; text-align:center; letter-spacing: 3px;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div style="display:flex; gap:10px; justify-content:center; margin-top: 20px;">
                    <button class="btn primary" id="dialog-btn-yes" style="margin:0;">Confirm</button>
                    <button class="btn" id="dialog-btn-no" style="margin:0; display:none;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-header">
        <h1 class="app-title">‚úß Warranty Auditor</h1>
        <button class="btn" style="width: auto; margin:0; padding: 6px 10px; font-size:0.75rem;" onclick="toggleTheme()">üåì Theme</button>
    </div>

    <div id="screen-menu" class="screen active">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <button class="btn primary" onclick="showScreen('screen-new-audit')">üìù New Audit Session</button>
            <button class="btn" onclick="openArchive(false)">‚è≥ Drafts (In Progress)</button>
            <button class="btn" onclick="openArchive(true)">üìÅ Previous Audits</button>
            <hr style="border:none; border-top:1px solid var(--border); margin: 16px 0;">
            <button class="btn" onclick="openReportingMenu()">üìä Reporting & Export</button>
            <hr style="border:none; border-top:1px solid var(--border); margin: 16px 0;">
            <button class="btn" onclick="showScreen('screen-security')">üîí Security Settings</button>
        </div>
    </div>

    <div id="screen-security" class="screen">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <h3>Security Settings</h3>
            <p>Protect finalized Previous Audits.</p>
            <div id="sec-status" style="margin-bottom: 16px; font-weight: 600; font-size: 0.9rem;">Status: <span style="color:var(--danger)">OFF</span></div>
            <button class="btn primary" id="btn-toggle-sec" onclick="toggleSecurity()">Enable Protection</button>
            <button class="btn" id="btn-change-pass" onclick="changePassword()" style="display:none;">Change Password</button>
            <button class="btn" onclick="showScreen('screen-menu')">Back</button>
        </div>
    </div>

    <div id="screen-new-audit" class="screen">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <h3>Setup Audit</h3>
            <div class="grid-2">
                <div>
                    <label>Month</label>
                    <select id="audit-month" class="select">
                        <option value="January">Jan</option><option value="February">Feb</option><option value="March">Mar</option><option value="April">Apr</option>
                        <option value="May">May</option><option value="June">Jun</option><option value="July">Jul</option><option value="August">Aug</option>
                        <option value="September">Sep</option><option value="October">Oct</option><option value="November">Nov</option><option value="December">Dec</option>
                    </select>
                </div>
                <div>
                    <label>Year</label>
                    <input type="number" id="audit-year" class="input" value="2026">
                </div>
            </div>
            <label>Source Excel File</label>
            <input type="file" id="audit-file" class="input" accept=".xlsx, .xls">
            <div class="grid-2" style="margin-top: 8px;">
                <button class="btn primary" style="margin:0;" onclick="startNewAudit()">Load Data</button>
                <button class="btn" style="margin:0;" onclick="showScreen('screen-menu')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="screen-workspace" class="screen">
        <div class="flex-between" style="margin-bottom: 12px;">
            <h3 id="workspace-title" style="margin:0; font-size:1.1rem;">Workspace</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn primary" style="width: auto; margin:0; padding: 6px 12px; font-size:0.75rem;" onclick="finalizeAuditFlow()">Finalize</button>
                <button class="btn danger" style="width: auto; margin:0; padding: 6px 12px; font-size:0.75rem;" onclick="requestExitWorkspace()">Menu</button>
            </div>
        </div>

        <div id="workspace-stats" style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;"></div>
        <input type="text" id="search-claim" class="input" placeholder="üîç Search Claim No..." oninput="handleSearch()" style="margin-bottom:12px;">

        <div class="table-wrap">
            <table id="claims-table">
                <thead>
                    <tr><th>Claim No</th><th>Status</th><th>R/O No</th><th>Type</th><th>Causal Part</th><th>Amount</th><th>Findings</th></tr>
                </thead>
                <tbody id="claims-tbody"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn" onclick="changePage(-1)" id="btn-prev">Prev</button>
            <span id="page-indicator" style="font-size: 0.8rem; color: var(--text-muted); font-weight: 600;">Page 1</span>
            <button class="btn" onclick="changePage(1)" id="btn-next">Next</button>
        </div>
    </div>

    <div id="screen-archive" class="screen">
        <h3 id="archive-title">Archive</h3>
        <div class="table-wrap" style="margin-bottom: 16px;">
            <table>
                <thead><tr><th>Period</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="archive-tbody"></tbody>
            </table>
        </div>
        <button class="btn" style="max-width: 150px;" onclick="showScreen('screen-menu')">Back</button>
    </div>

    <div id="screen-reports" class="screen">
        <div class="card" style="max-width: 400px; margin: 0 auto;">
            <h3>Reporting & Export Engine</h3>
            <p>Download your finalized audits securely.</p>
            <label>Select Audit Scope</label>
            <select id="report-scope" class="select"><option value="master">Master Report (All Months)</option></select>
            
            <div class="grid-2" style="margin-top: 16px;">
                <button class="btn primary" style="margin:0;" onclick="executeExport('excel')">üì• Export Excel</button>
                <button class="btn danger" style="margin:0; border-color: var(--danger); color: var(--danger);" onclick="executeExport('pdf')">üìÑ Export PDF</button>
            </div>
            <button class="btn" style="margin-top: 12px;" onclick="showScreen('screen-menu')">Back to Menu</button>
        </div>
    </div>

    <div id="audit-modal" class="modal-backdrop">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="modal-claim-no" style="margin:0; font-size: 1.1rem;">Claim No</h3>
            </div>
            <div class="modal-body">
                <div id="modal-all-details" class="all-details-grid"></div>

                <label>Discrepancy Status</label>
                <select id="modal-discrepancy" class="select">
                    <option value="0">Part is Clean (None Found)</option>
                    <option value="1">Part is clean (Sent HMIL Suspense)</option>
                    <option value="3">Part is Missing</option>
                    <option value="4">Part Batch Code Mismatch</option>
                    <option value="5">Part Not Tagged</option>
                    <option value="6">Part Packing Missing</option>
                    <option value="7">Related Part Missing to Causal or Affected Part Missing</option>
                    <option value="8">Part is Not Defective</option>
                </select>

                <div id="modal-extra-inputs" style="display: none;">
                    <label id="modal-extra-label">Additional Details</label>
                    <input type="text" id="modal-extra-text" class="input" placeholder="...">
                </div>

                <div class="grid-2" style="margin-top: 12px;">
                    <button class="btn primary" style="margin:0;" onclick="saveClaimAudit()">Save Claim</button>
                    <button class="btn" style="margin:0;" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- APP DIALOG SYSTEM (Replaces alert, confirm, prompt) ---
    let dialogCallback = null;
    function closeDialog() { document.getElementById('app-dialog').classList.remove('active'); document.getElementById('dialog-input').value = ''; }
    
    function showAppAlert(msg) {
        document.getElementById('dialog-msg').innerText = msg;
        document.getElementById('dialog-input').style.display = 'none';
        document.getElementById('dialog-btn-no').style.display = 'none';
        document.getElementById('dialog-btn-yes').onclick = closeDialog;
        document.getElementById('app-dialog').classList.add('active');
    }

    function showAppConfirm(msg, onYes) {
        document.getElementById('dialog-msg').innerText = msg;
        document.getElementById('dialog-input').style.display = 'none';
        document.getElementById('dialog-btn-no').style.display = 'block';
        
        document.getElementById('dialog-btn-yes').onclick = () => { closeDialog(); if(onYes) onYes(); };
        document.getElementById('dialog-btn-no').onclick = closeDialog;
        document.getElementById('app-dialog').classList.add('active');
    }

    function showAppPrompt(msg, isPassword, onConfirm) {
        document.getElementById('dialog-msg').innerText = msg;
        const input = document.getElementById('dialog-input');
        input.type = isPassword ? 'password' : 'text';
        input.style.display = 'block'; input.value = '';
        document.getElementById('dialog-btn-no').style.display = 'block';
        
        document.getElementById('dialog-btn-yes').onclick = () => {
            const val = input.value; closeDialog(); if(onConfirm) onConfirm(val);
        };
        document.getElementById('dialog-btn-no').onclick = closeDialog;
        document.getElementById('app-dialog').classList.add('active');
        setTimeout(() => input.focus(), 100);
    }

    // --- THEME ---
    function toggleTheme() {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') body.removeAttribute('data-theme');
        else body.setAttribute('data-theme', 'dark');
    }

    // --- SECURITY MODULE ---
    let secConfig = JSON.parse(localStorage.getItem('auditor_sec')) || { enabled: false, hash: '' };

    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function updateSecurityUI() {
        const statusSpan = document.getElementById('sec-status');
        const btnToggle = document.getElementById('btn-toggle-sec');
        const btnChange = document.getElementById('btn-change-pass');
        
        if (secConfig.enabled) {
            statusSpan.innerHTML = '<span style="color:var(--success)">ON</span>';
            btnToggle.innerText = "Disable Protection"; btnToggle.classList.replace('primary', 'danger');
            btnChange.style.display = 'block';
        } else {
            statusSpan.innerHTML = '<span style="color:var(--danger)">OFF</span>';
            btnToggle.innerText = "Enable Protection"; btnToggle.classList.replace('danger', 'primary');
            btnChange.style.display = 'none';
        }
    }

    function verifyPasswordFlow(onSuccess) {
        if (!secConfig.enabled) return onSuccess();
        showAppPrompt("Enter Security Password:", true, async (attempt) => {
            if (!attempt) return;
            if (await sha256(attempt) === secConfig.hash) onSuccess();
            else showAppAlert("Incorrect Password.");
        });
    }

    function toggleSecurity() {
        if (secConfig.enabled) {
            verifyPasswordFlow(() => {
                secConfig.enabled = false; secConfig.hash = '';
                localStorage.setItem('auditor_sec', JSON.stringify(secConfig)); updateSecurityUI();
                showAppAlert("Protection Disabled.");
            });
        } else {
            showAppPrompt("Create NEW Password:", true, (p1) => {
                if(!p1) return;
                showAppPrompt("Confirm NEW Password:", true, async (p2) => {
                    if (p1 !== p2) return showAppAlert("Passwords do not match.");
                    secConfig.hash = await sha256(p1); secConfig.enabled = true;
                    localStorage.setItem('auditor_sec', JSON.stringify(secConfig)); updateSecurityUI();
                    showAppAlert("Protection Enabled.");
                });
            });
        }
    }

    function changePassword() {
        verifyPasswordFlow(() => {
            showAppPrompt("Enter NEW Password:", true, (p1) => {
                if(!p1) return;
                showAppPrompt("Confirm NEW Password:", true, async (p2) => {
                    if (p1 !== p2) return showAppAlert("Passwords do not match.");
                    secConfig.hash = await sha256(p1); localStorage.setItem('auditor_sec', JSON.stringify(secConfig));
                    showAppAlert("Password changed successfully.");
                });
            });
        });
    }

    // --- STATE ---
    localforage.config({ name: 'AutoPuncherDB', storeName: 'audits' });
    let dbIndex = {}; let currentSessionKey = null; let currentData = []; let currentFilteredData = []; let currentAuditData = {}; let colMap = {};
    let currentPage = 1; const pageSize = 50; let activeClaimRowIndex = null; 

    const DISCREPANCY_TYPES = {
        "0": "None Found", "1": "Part is clean (Sent HMIL Suspense)", "3": "Part is Missing",
        "4": "Part Batch Code Mismatch", "5": "Part Not Tagged", "6": "Part Packing Missing",
        "7": "Related Part Missing to Causal or Affected Part Missing", "8": "Part is Not Defective"
    };

    // LOGIC FIX: Check if a claim is clean based on original python logic + HMIL suspense
    function isClaimClean(findings) {
        if (!findings || findings.length === 0) return true;
        return findings[0].includes("None Found") || findings[0].includes("Sent HMIL Suspense");
    }

    localforage.getItem('db_index').then(val => { if(val) { dbIndex = val; updateSecurityUI(); } });

    async function saveSessionToDB(sessionData) {
        dbIndex[currentSessionKey] = { month: sessionData.month, year: sessionData.year, finalized: sessionData.finalized || false, last_saved: sessionData.last_saved };
        await localforage.setItem('db_index', dbIndex); await localforage.setItem(currentSessionKey, sessionData); 
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

    // --- DATA HANDLING ---
    function detectColumns(headers) {
        const map = {}; const lowerHeaders = headers.map(h => h.toString().toLowerCase().replace(/[\s_]/g, ''));
        const fuzzy = {
            "claim_no": ["claimno","claimnumber","clmno"], "ro_no": ["rono","r/ono","repairorderno"],
            "claim_type": ["claimtype","clmtype"], "causal_part": ["causalpart","partno","partnumber"],
            "part_desc": ["partdesc","partdescription","partname"], "amount": ["totalamt","totalamount","claimamount","amount"]
        };
        for (const [key, terms] of Object.entries(fuzzy)) {
            const idx = lowerHeaders.findIndex(h => terms.some(t => h.includes(t)));
            if (idx !== -1) map[key] = headers[idx];
        }
        return map;
    }

    function startNewAudit() {
        const fileInput = document.getElementById('audit-file');
        const month = document.getElementById('audit-month').value; const year = document.getElementById('audit-year').value;
        if (!fileInput.files.length) return showAppAlert("Select an Excel file.");
        showLoader(true);

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});
                if(jsonData.length === 0) throw new Error("File empty.");

                colMap = detectColumns(Object.keys(jsonData[0]));
                if(!colMap.claim_no) throw new Error("Could not detect Claim No column.");

                currentData = jsonData.filter(row => {
                    const type = String(row[colMap.claim_type] || "").toUpperCase(); const amt = parseFloat(row[colMap.amount]) || 0;
                    const desc = String(row[colMap.part_desc] || "").toUpperCase();
                    if (type.includes("FREE SERVICE") || type.includes("FSC")) return false;
                    if (type.includes("CAMPAIGN") && amt < 300 && !desc.includes("POWER WINDOW") && !desc.includes("FUEL PUMP")) return false;
                    return true;
                });

                currentSessionKey = `audit_${month}_${year}_${Date.now()}`; currentAuditData = {}; currentFilteredData = [...currentData]; currentPage = 1;

                await saveSessionToDB({ month, year, last_saved: new Date().toLocaleString(), finalized: false, col_map: colMap, audit_data: currentAuditData, raw_data: currentData });

                document.getElementById('workspace-title').innerText = `${month} ${year}`;
                showScreen('screen-workspace'); updateStats(); renderTablePage();
            } catch(err) { showAppAlert(err.message); } finally { showLoader(false); }
        };
        setTimeout(() => reader.readAsArrayBuffer(fileInput.files[0]), 50);
    }

    // --- WORKSPACE ---
    function requestExitWorkspace() {
        showAppConfirm("Return to menu?\nYour progress is auto-saved as a Draft.", () => { showScreen('screen-menu'); });
    }

    function handleSearch() {
        const q = document.getElementById('search-claim').value.toUpperCase();
        currentFilteredData = q ? currentData.filter(row => String(row[colMap.claim_no]).toUpperCase().includes(q)) : [...currentData];
        currentPage = 1; renderTablePage();
    }

    function changePage(dir) {
        const maxPage = Math.ceil(currentFilteredData.length / pageSize) || 1;
        currentPage = Math.max(1, Math.min(currentPage + dir, maxPage)); renderTablePage();
    }

    function updateStats() {
        let audited = 0; let clear = 0;
        currentData.forEach(row => {
            const entry = currentAuditData[row[colMap.claim_no]];
            if(entry && entry.audited) { audited++; if(isClaimClean(entry.findings)) clear++; }
        });
        document.getElementById('workspace-stats').innerHTML = `
            <span class="badge">T: ${currentData.length}</span><span class="badge status-clear">C: ${clear}</span>
            <span class="badge status-unclear">U: ${audited - clear}</span><span class="badge">P: ${currentData.length - audited}</span>
        `;
    }

    function renderTablePage() {
        const tbody = document.getElementById('claims-tbody'); tbody.innerHTML = '';
        const start = (currentPage - 1) * pageSize; const pageData = currentFilteredData.slice(start, start + pageSize);
        const frag = document.createDocumentFragment();

        pageData.forEach((row, i) => {
            const claimNo = row[colMap.claim_no]; const entry = currentAuditData[claimNo] || {};
            const isClear = entry.audited && isClaimClean(entry.findings);

            let statusHtml = '<span class="status-pending">Pen</span>';
            if (isClear) statusHtml = '<span class="status-clear">Cln</span>';
            else if (entry.audited) statusHtml = `<span class="status-unclear">Unc</span>`;

            const tr = document.createElement('tr'); tr.onclick = () => openAuditModal(start + i);
            tr.innerHTML = `<td>${claimNo}</td><td>${statusHtml}</td><td>${row[colMap.ro_no] || '-'}</td><td>${row[colMap.claim_type] || '-'}</td><td>${row[colMap.causal_part] || '-'}</td><td>${row[colMap.amount] || '-'}</td><td style="color:var(--text-muted);">${(entry.findings||[]).join('; ')}</td>`;
            frag.appendChild(tr);
        });
        tbody.appendChild(frag);

        const maxPage = Math.ceil(currentFilteredData.length / pageSize) || 1;
        document.getElementById('page-indicator').innerText = `${currentPage} / ${maxPage}`;
        document.getElementById('btn-prev').disabled = currentPage === 1; document.getElementById('btn-next').disabled = currentPage === maxPage;
    }

    // --- MODAL ---
    document.getElementById('modal-discrepancy').addEventListener('change', (e) => {
        const val = e.target.value; const extraBox = document.getElementById('modal-extra-inputs');
        const label = document.getElementById('modal-extra-label'); const input = document.getElementById('modal-extra-text');
        if(val === '1') { extraBox.style.display = 'block'; label.innerText = "POD Number (Optional)"; input.placeholder = "Enter POD..."; }
        else if(val === '7') { extraBox.style.display = 'block'; label.innerText = "Missing Part Name (Required)"; input.placeholder = "Enter Part..."; }
        else { extraBox.style.display = 'none'; input.value = ''; }
    });

    function closeModal() { document.getElementById('audit-modal').classList.remove('active'); }

    function openAuditModal(filteredIndex) {
        activeClaimRowIndex = filteredIndex; const row = currentFilteredData[filteredIndex];
        const claimNo = row[colMap.claim_no]; document.getElementById('modal-claim-no').innerText = claimNo;
        
        const displayKeys = ["ro_no", "claim_type", "causal_part", "part_desc", "amount"]; let detailsHtml = '';
        displayKeys.forEach(k => {
            if(colMap[k]) { let val = row[colMap[k]] || "-"; let lbl = colMap[k].replace(/_/g, " "); detailsHtml += `<div class="detail-item"><span class="detail-lbl">${lbl}</span><span class="detail-val">${val}</span></div>`; }
        });
        document.getElementById('modal-all-details').innerHTML = detailsHtml;

        const entry = currentAuditData[claimNo];
        document.getElementById('modal-extra-inputs').style.display = 'none'; document.getElementById('modal-extra-text').value = '';
        
        if(entry && entry.audited) {
            const f = entry.findings[0]; const select = document.getElementById('modal-discrepancy'); select.value = "0"; 
            for(let key in DISCREPANCY_TYPES) {
                if(f.includes(DISCREPANCY_TYPES[key])) {
                    select.value = key;
                    if(key === '1') { document.getElementById('modal-extra-inputs').style.display = 'block'; document.getElementById('modal-extra-label').innerText = "POD Number (Optional)"; document.getElementById('modal-extra-text').value = entry.pod_number || ''; }
                    if(key === '7') { document.getElementById('modal-extra-inputs').style.display = 'block'; document.getElementById('modal-extra-label').innerText = "Missing Part Name (Required)"; document.getElementById('modal-extra-text').value = entry.missing_part_name || ''; }
                    break;
                }
            }
        } else { document.getElementById('modal-discrepancy').value = "0"; }
        document.getElementById('audit-modal').classList.add('active');
    }

    async function saveClaimAudit() {
        const claimNo = currentFilteredData[activeClaimRowIndex][colMap.claim_no];
        const discCode = document.getElementById('modal-discrepancy').value;
        const extraText = document.getElementById('modal-extra-text').value.trim();

        let finding = DISCREPANCY_TYPES[discCode];
        let entry = { audited: true, timestamp: new Date().toISOString() };

        // LOGIC RESTORED: Background assignments for Suspense & Couriers
        if(discCode === '1') { 
            entry.pod_number = extraText;
            entry.remarks = "Sent to Hmil Suspense (P)";
            entry.courier_provider = "Track-On Couriers";
            finding += extraText ? ` [POD: ${extraText}]` : ""; 
        } else if (discCode === '7') { 
            if(!extraText) return showAppAlert("Part Name is required for Code 7."); 
            entry.missing_part_name = extraText; finding += ` (${extraText})`; 
        }

        entry.findings = [finding]; currentAuditData[claimNo] = entry;

        closeModal(); updateStats();
        localforage.getItem(currentSessionKey).then(session => { if(session) { session.audit_data = currentAuditData; session.last_saved = new Date().toLocaleString(); saveSessionToDB(session); } });
        const nextInput = document.getElementById('search-claim');
        if(nextInput.value) { nextInput.value = ''; handleSearch(); nextInput.focus(); } else { renderTablePage(); } 
    }

    async function finalizeAuditFlow() {
        if(!currentData || currentData.length === 0) return;
        let audited = 0; let clear = 0;
        currentData.forEach(row => { const entry = currentAuditData[row[colMap.claim_no]]; if(entry && entry.audited) { audited++; if(isClaimClean(entry.findings)) clear++; } });

        const pending = currentData.length - audited; const unclear = audited - clear;

        const processFinalize = async () => {
            showLoader(true);
            const session = await localforage.getItem(currentSessionKey);
            session.finalized = true; await saveSessionToDB(session);
            showLoader(false);
            showAppAlert("Audit Finalized & Saved to Previous Audits.");
            showScreen('screen-menu');
        };

        if (pending > 0 || unclear > 0) {
            showAppConfirm(`You have ${unclear} Unclear and ${pending} Pending claims.\n\nFinalize audit anyway?`, processFinalize);
        } else {
            showAppConfirm("All claims are clean.\nDo you want to Finalize this audit?", processFinalize);
        }
    }

    // --- ARCHIVE ---
    async function openArchive(showFinalized) {
        showLoader(true); const tbody = document.getElementById('archive-tbody'); tbody.innerHTML = '';
        document.getElementById('archive-title').innerText = showFinalized ? "Previous Audits" : "Drafts";
        let found = false;
        for (const [key, meta] of Object.entries(dbIndex)) {
            if (meta.finalized === showFinalized) {
                found = true; const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:500;">${meta.month} ${meta.year}<br><span style="font-size:0.7rem; color:var(--text-muted); font-weight:normal;">${meta.last_saved}</span></td>
                    <td><span class="badge ${meta.finalized ? 'status-clear' : 'status-unclear'}">${meta.finalized ? 'Fin' : 'Drf'}</span></td>
                    <td><div style="display:flex; gap:4px;"><button class="btn primary" style="padding:6px; width:auto; margin:0;" onclick="resumeSession('${key}', ${meta.finalized})">Open</button><button class="btn danger" style="padding:6px; width:auto; margin:0;" onclick="deleteSession('${key}', ${meta.finalized})">Del</button></div></td>
                `; tbody.appendChild(tr);
            }
        }
        if(!found) tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--text-muted);">No records found.</td></tr>`;
        showLoader(false); showScreen('screen-archive');
    }

    async function resumeSession(key, isFinalized) {
        if (isFinalized) { verifyPasswordFlow(() => loadSession(key)); } else { loadSession(key); }
    }
    async function loadSession(key) {
        showLoader(true); const session = await localforage.getItem(key);
        if(!session) { showLoader(false); return showAppAlert("Error loading session."); }
        currentSessionKey = key; currentData = session.raw_data; currentFilteredData = [...currentData]; 
        currentAuditData = session.audit_data; colMap = session.col_map; currentPage = 1;
        document.getElementById('workspace-title').innerText = `${session.month} ${session.year}`; document.getElementById('search-claim').value = '';
        updateStats(); renderTablePage(); showLoader(false); showScreen('screen-workspace');
    }

    async function deleteSession(key, isFinalized) {
        const delOp = async () => {
            delete dbIndex[key]; await localforage.setItem('db_index', dbIndex); await localforage.removeItem(key);
            openArchive(document.getElementById('archive-title').innerText.includes('Previous'));
        };
        if (isFinalized) {
            verifyPasswordFlow(() => showAppConfirm("Permanently delete this audit?", delOp));
        } else {
            showAppConfirm("Permanently delete this draft?", delOp);
        }
    }

    // --- REPORTING & EXPORT ENGINE ---
    function openReportingMenu() {
        const select = document.getElementById('report-scope'); select.innerHTML = '<option value="master">Master Report (All Months)</option>';
        for (const [key, meta] of Object.entries(dbIndex)) {
            const opt = document.createElement('option'); opt.value = key; opt.text = `${meta.month} ${meta.year} ${meta.finalized ? '(Fin)' : '(Drf)'}`; select.appendChild(opt);
        }
        showScreen('screen-reports');
    }

    function formatRowForExport(row, auditEntry, colMapping) {
        let expRow = {};
        for(let key in colMapping) expRow[colMapping[key]] = row[colMapping[key]];
        expRow["Audit Status"] = auditEntry.audited ? "‚úî Audited" : "‚óã Pending";
        expRow["Discrepancy Found"] = (!isClaimClean(auditEntry.findings) && auditEntry.audited) ? "Yes" : "No";
        expRow["Discrepancy Details"] = auditEntry.findings ? auditEntry.findings.join("; ") : "";
        expRow["Audit Time"] = auditEntry.timestamp || "";
        expRow["Remarks"] = auditEntry.remarks || ""; // Uses restored logic
        expRow["POD Number"] = auditEntry.pod_number || "";
        expRow["Courier Provider"] = auditEntry.courier_provider || ""; // Uses restored logic
        expRow["Missing Part Name"] = auditEntry.missing_part_name || "";
        expRow["Auditor"] = "Aashish Giri H";
        return expRow;
    }

    function generateExportData(sessionData) {
        let clearRows = []; let unclearRows = [];
        sessionData.raw_data.forEach(row => {
            const entry = sessionData.audit_data[row[sessionData.col_map.claim_no]] || {};
            const isClear = entry.audited && isClaimClean(entry.findings);
            let fRow = formatRowForExport(row, entry, sessionData.col_map);
            if(isClear) clearRows.push(fRow); else unclearRows.push(fRow);
        });
        return { clearRows, unclearRows, monthYear: `${sessionData.month} ${sessionData.year}` };
    }

    async function executeExport(format) {
        const scope = document.getElementById('report-scope').value; showLoader(true);
        try {
            let combinedClear = []; let combinedUnclear = [];
            if (scope === 'master') {
                for (const key of Object.keys(dbIndex)) {
                    const session = await localforage.getItem(key);
                    if (session && session.raw_data) {
                        const data = generateExportData(session);
                        combinedClear = combinedClear.concat(data.clearRows); combinedUnclear = combinedUnclear.concat(data.unclearRows);
                    }
                }
            } else {
                const session = await localforage.getItem(scope);
                if (session && session.raw_data) {
                    const data = generateExportData(session);
                    combinedClear = data.clearRows; combinedUnclear = data.unclearRows;
                }
            }

            if (combinedClear.length === 0 && combinedUnclear.length === 0) return showAppAlert("No data to export.");

            const fileName = scope === 'master' ? `Master_Audit_${Date.now()}` : `Audit_${scope}`;

            if(format === 'excel') {
                let aoa = []; let headers = combinedClear.length > 0 ? Object.keys(combinedClear[0]) : Object.keys(combinedUnclear[0]);
                if (combinedClear.length > 0) { aoa.push([`‚úî CLEAR CLAIMS`]); aoa.push(headers); combinedClear.forEach(r => aoa.push(Object.values(r))); }
                if (combinedUnclear.length > 0) { if(combinedClear.length > 0) aoa.push([]); aoa.push([`‚ö† UNCLEAR / PENDING CLAIMS`]); aoa.push(headers); combinedUnclear.forEach(r => aoa.push(Object.values(r))); }
                const ws = XLSX.utils.aoa_to_sheet(aoa); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Audit Report"); XLSX.writeFile(wb, fileName + ".xlsx");
            } 
            else if (format === 'pdf') {
                const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
                doc.setFontSize(14); doc.text(`Warranty Audit Report - ${scope === 'master' ? 'Master' : fileName}`, 14, 15);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()} | Auditor: Aashish Giri H`, 14, 22);

                let startY = 30;
                let headers = combinedClear.length > 0 ? Object.keys(combinedClear[0]) : Object.keys(combinedUnclear[0]);
                // Truncate headers for PDF fit
                let pdfHeaders = headers.map(h => h.length > 15 ? h.substring(0,12)+'...' : h);

                if(combinedClear.length > 0) {
                    doc.setFontSize(12); doc.setTextColor(0, 150, 0); doc.text("‚úî CLEAR CLAIMS", 14, startY);
                    doc.autoTable({
                        startY: startY + 5, head: [pdfHeaders], body: combinedClear.map(r => Object.values(r)),
                        styles: { fontSize: 6, cellPadding: 1 }, headStyles: { fillColor: [34, 139, 34] } // Green Header
                    });
                    startY = doc.lastAutoTable.finalY + 15;
                }
                if(combinedUnclear.length > 0) {
                    doc.setFontSize(12); doc.setTextColor(200, 0, 0); doc.text("‚ö† UNCLEAR / PENDING CLAIMS", 14, startY);
                    doc.autoTable({
                        startY: startY + 5, head: [pdfHeaders], body: combinedUnclear.map(r => Object.values(r)),
                        styles: { fontSize: 6, cellPadding: 1 }, headStyles: { fillColor: [204, 0, 0] } // Red Header
                    });
                }
                doc.save(fileName + ".pdf");
            }
        } catch (e) { showAppAlert("Failed: " + e.message); } finally { showLoader(false); }
    }
</script>
</body>
</html>
