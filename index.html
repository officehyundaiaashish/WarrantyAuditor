<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warranty Auditor</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* --- THEME VARIABLES & COLOR SCHEMES --- */
        :root {
            --bg-base: #f8fafc; --surface: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --primary: #0f172a; --primary-hover: #334155; --primary-text: #ffffff;
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; --accent: #3b82f6;
            --radius: 12px; --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); --modal-overlay: rgba(15, 23, 42, 0.6);
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg-base: #09090b; --surface: #18181b; --text-main: #f4f4f5; --text-muted: #a1a1aa;
            --border: #27272a; --primary: #ffffff; --primary-hover: #e4e4e7; --primary-text: #000000;
            --modal-overlay: rgba(0, 0, 0, 0.85);
            color-scheme: dark;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-base); color: var(--text-main); min-height: 100vh; padding: 16px; font-size: 14px; -webkit-tap-highlight-color: transparent; display: flex; flex-direction: column; transition: background-color 0.4s ease, color 0.4s ease; overflow-x: hidden; }
        
        .card { background-color: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; margin-bottom: 16px; transition: all 0.3s ease; }
        
        /* Header & Typography */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .app-title {
            margin: 0; display: inline-flex; align-items: center;
        }
        .app-title-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 36px;
            padding: 0 12px 0 10px;
            position: relative;
            box-shadow: none;
            transition: box-shadow 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
            overflow: hidden;
        }
        .app-title-badge::after {
            content: none;
        }
        .app-title-badge:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 12px rgba(59,130,246,0.1);
            transform: translateY(-1px);
        }
        [data-theme="dark"] .app-title-badge {
            background: var(--surface);
            border-color: var(--border);
            box-shadow: none;
        }
        .app-title-icon {
            height: 18px; width: auto; flex-shrink: 0;
            display: block;
            filter: none;
            mix-blend-mode: multiply;
            transition: filter 0.3s ease;
            animation: logoBreath 3.5s ease-in-out infinite;
        }
        [data-theme="dark"] .app-title-icon {
            filter: invert(1);
            mix-blend-mode: screen;
        }
        @keyframes logoBreath {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.82; transform: scale(0.96); }
        }
        .app-title-text {
            font-size: 0.92rem; font-weight: 800;
            letter-spacing: 0.5px; white-space: nowrap;
            color: var(--text-main);
            -webkit-text-fill-color: var(--text-main);
            background: none;
        }

        /* Header action buttons */
        .header-action-btn {
            display: inline-flex; align-items: center; gap: 5px;
            height: 36px; padding: 0 11px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.7rem; font-weight: 700;
            letter-spacing: 0.3px;
            transition: all 0.18s ease;
            white-space: nowrap;
        }
        .header-action-btn svg {
            width: 13px; height: 13px;
            stroke: currentColor; stroke-width: 2;
            fill: none; stroke-linecap: round; stroke-linejoin: round;
            flex-shrink: 0;
        }
        .header-action-btn:hover {
            color: var(--text-main);
            border-color: var(--text-muted);
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.07);
        }
        .header-action-btn.upload-shortcut:hover { color: var(--success); border-color: rgba(16,185,129,0.5); background: rgba(16,185,129,0.05); }
        .header-action-btn.restore-shortcut:hover { color: var(--accent); border-color: rgba(59,130,246,0.5); background: rgba(59,130,246,0.05); }
        .btn-label { display: none; }
        @media (min-width: 440px) { .btn-label { display: inline; } }
        @keyframes arrow-up { 0%,100%{transform:translateY(0);opacity:1} 40%{transform:translateY(-3px);opacity:0.4} 70%{transform:translateY(1px);opacity:1} }
        @keyframes arrow-down { 0%,100%{transform:translateY(0);opacity:1} 40%{transform:translateY(3px);opacity:0.4} 70%{transform:translateY(-1px);opacity:1} }
        @keyframes btn-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.04)} }
        .header-action-btn.syncing svg { animation: arrow-up 0.8s ease-in-out infinite; }
        .header-action-btn.syncing { color: var(--success); border-color: rgba(16,185,129,0.4); }
        .header-action-btn.loading svg { animation: arrow-down 0.8s ease-in-out infinite; }
        .header-action-btn.loading { color: var(--accent); border-color: rgba(59,130,246,0.4); }
        .header-action-btn.done { animation: btn-pulse 0.35s ease; }
        .theme-toggle {
            height: 36px; width: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; transition: all 0.2s ease; position: relative;
        }
        .theme-toggle:hover { border-color: var(--text-muted); transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.07); }
        .theme-toggle svg { position: absolute; width: 15px; height: 15px; transition: all 0.4s cubic-bezier(0.68,-0.55,0.27,1.55); stroke: var(--text-main); stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
        body[data-theme="dark"] .icon-sun { transform: translateY(28px) rotate(90deg); opacity: 0; }
        body:not([data-theme="dark"]) .icon-moon { transform: translateY(-28px) rotate(-90deg); opacity: 0; }
        h2, h3 { font-weight: 700; margin-bottom: 8px; letter-spacing: -0.3px; }
        p { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px; line-height: 1.5; }
        label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }

        /* Animated Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--surface); color: var(--text-main);
            border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; width: 100%; margin-bottom: 10px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); outline: none;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--text-muted); }
        .btn:active { transform: scale(0.97); box-shadow: none; }
        .btn.primary { background-color: var(--primary); color: var(--primary-text); border-color: var(--primary); }
        .btn.primary:hover { background-color: var(--primary-hover); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .btn.danger { color: var(--danger); border-color: rgba(239, 68, 68, 0.3); background-color: rgba(239, 68, 68, 0.05); }
        .btn.danger:hover { background-color: var(--danger); color: white; border-color: var(--danger); }

        /* Theme Toggle Animation */
        body:not([data-theme="dark"]) .icon-moon { transform: translateY(-30px) rotate(-90deg); opacity: 0; }

        /* Inputs */
        .input { width: 100%; background-color: var(--bg-base); color: var(--text-main); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 0.95rem; margin-bottom: 16px; transition: all 0.3s ease; outline: none; color-scheme: inherit; }
        .input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        /* ── Custom Month-Year Picker ── */
        .mp-wrapper { position: relative; }
        .mp-display {
            display: flex; align-items: center; gap: 8px;
            background: var(--bg-base); border: 1px solid var(--border);
            border-radius: 8px; padding: 11px 12px; cursor: pointer;
            transition: all 0.2s ease; user-select: none;
            color: var(--text-main);
        }
        .mp-display:hover { border-color: var(--accent); }
        .mp-wrapper.open .mp-display {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
        }
        .mp-cal-icon {
            width: 15px; height: 15px; stroke: var(--accent);
            fill: none; stroke-width: 2; stroke-linecap: round;
            stroke-linejoin: round; flex-shrink: 0;
        }
        .mp-label { flex: 1; font-size: 0.88rem; font-weight: 600; transition: opacity 0.2s ease, transform 0.2s ease; }
        .mp-label.placeholder { color: var(--text-muted); font-weight: 500; }
        .mp-chevron {
            width: 14px; height: 14px; stroke: var(--text-muted);
            fill: none; stroke-width: 2; flex-shrink: 0;
            transition: transform 0.25s cubic-bezier(0.16,1,0.3,1);
        }
        .mp-wrapper.open .mp-chevron { transform: rotate(180deg); }
        .mp-dropdown {
            position: absolute; top: calc(100% + 6px); left: 0; right: 0;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; z-index: 500; min-width: 200px;
            box-shadow: 0 20px 40px -8px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.04);
            opacity: 0; transform: translateY(-8px) scale(0.97);
            pointer-events: none;
            transition: opacity 0.22s cubic-bezier(0.16,1,0.3,1),
                        transform 0.22s cubic-bezier(0.16,1,0.3,1);
            overflow: hidden;
        }
        [data-theme="dark"] .mp-dropdown { box-shadow: 0 20px 40px -8px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.06); }
        .mp-wrapper.open .mp-dropdown { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .mp-year-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px 10px; border-bottom: 1px solid var(--border);
        }
        .mp-year-label { font-size: 0.92rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.3px; }
        .mp-yr-btn {
            width: 28px; height: 28px; border-radius: 6px;
            border: 1px solid var(--border); background: var(--bg-base);
            cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.15s ease; color: var(--text-main);
        }
        .mp-yr-btn:hover { border-color: var(--accent); background: rgba(59,130,246,0.08); color: var(--accent); }
        .mp-yr-btn svg { width: 13px; height: 13px; stroke: currentColor; fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
        .mp-months { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; padding: 10px; }
        .mp-month-btn {
            border: 1px solid transparent; border-radius: 8px;
            padding: 9px 4px; font-size: 0.78rem; font-weight: 600;
            cursor: pointer; background: none; color: var(--text-muted);
            transition: all 0.15s ease; text-align: center;
            position: relative; overflow: hidden;
        }
        .mp-month-btn:hover { background: var(--bg-base); color: var(--text-main); border-color: var(--border); }
        .mp-month-btn.current-month { border-color: rgba(59,130,246,0.4); color: var(--accent); font-weight: 700; }
        .mp-month-btn.selected {
            background: var(--primary); color: var(--primary-text);
            border-color: var(--primary); font-weight: 800;
            transform: scale(1.04);
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        .mp-month-btn.selected.current-month { background: var(--primary); color: var(--primary-text); border-color: var(--primary); }

        /* Custom Dropdown UI (In-App) */
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; margin-bottom: 16px; }
        .custom-select-trigger { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-base); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-size: 0.9rem; color: var(--text-main); cursor: pointer; transition: all 0.2s; }
        .custom-select-wrapper.open .custom-select-trigger { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .custom-options { position: absolute; display: block; top: 100%; left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); margin-top: 6px; z-index: 9999; opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); max-height: 250px; overflow-y: auto; }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0); }
        .custom-option { padding: 12px 16px; font-size: 0.9rem; cursor: pointer; transition: background-color 0.1s; border-bottom: 1px solid var(--bg-base); }
        .custom-option:last-child { border-bottom: none; }
        
        /* Modern File Upload */
        .file-upload-wrapper { position: relative; width: 100%; margin-bottom: 16px; }
        .file-upload-wrapper input[type="file"] { position: absolute; opacity: 0; width: 0; height: 0; }
        .file-upload-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: var(--surface); border: 2px dashed var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; color: var(--text-main); font-weight: 600; font-size: 0.9rem; }
        .file-upload-btn:hover { border-color: var(--accent); background: var(--bg-base); transform: translateY(-2px); }
        .file-upload-btn svg { width: 24px; height: 24px; stroke: var(--accent); stroke-width: 2; fill: none; }
        .file-card { display: flex; align-items: center; gap: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; animation: slideIn 0.3s ease; }
        .file-card-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .file-card-icon svg { width: 20px; height: 20px; stroke: white; stroke-width: 2; fill: none; }
        .file-card-info { flex: 1; min-width: 0; }
        .file-card-name { font-weight: 700; font-size: 0.9rem; color: var(--text-main); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-card-size { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .file-card-remove { cursor: pointer; padding: 6px; border-radius: 6px; transition: 0.2s; background: rgba(239, 68, 68, 0.1); }
        .file-card-remove:hover { background: var(--danger); }
        .file-card-remove svg { width: 18px; height: 18px; stroke: var(--danger); stroke-width: 2; fill: none; }
        .file-card-remove:hover svg { stroke: white; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Highlight for selected option */
        .custom-option:hover { background-color: var(--bg-base); color: var(--accent); }
        .custom-option.selected { background-color: rgba(59, 130, 246, 0.1) !important; color: var(--accent) !important; font-weight: 800 !important; border-left: 4px solid var(--accent); }
        .custom-option.kb-focus { background-color: var(--bg-base); color: var(--accent); border-left: 4px solid var(--accent); }

        /* TV Dropdown Clip Fix: Smart Relative Positioning pushes the modal taller instead of cutting off */
        #wrap-modal-disc.open .custom-options { position: relative !important; margin-bottom: 16px; box-shadow: none !important; border-color: var(--accent); max-height: 220px; overflow-y: auto; -webkit-overflow-scrolling: touch; z-index: 10; }

        /* Screen Transitions */
        .screen { display: none; flex: 1; } 
        .screen.active { display: flex; flex-direction: column; animation: slideFadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideFadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .grid-2 { display: grid; grid-template-columns: 1fr; gap: 12px; } @media (min-width: 500px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }

        /* Animated Grid Menu */
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; max-width: 650px; margin: 0 auto; width: 100%; }
        .menu-card {
            background-color: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 24px 12px; text-align: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
            box-shadow: var(--shadow); color: var(--text-main); font-weight: 600; font-size: 0.85rem;
        }
        .menu-card:hover { border-color: var(--accent); transform: translateY(-4px); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1); color: var(--accent); }
        .menu-card:active { transform: scale(0.95); }
        .menu-icon { width: 32px; height: 32px; stroke: currentColor; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; fill: none; transition: transform 0.3s ease; }
        .menu-card:hover .menu-icon { transform: scale(1.1); }

        /* Notification Banner */
        .notification-banner { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); padding: 14px 16px; border-radius: 8px; display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 0.85rem; margin: 0 auto 20px auto; max-width: 650px; width: 100%; display: none; cursor: pointer; animation: slideFadeUp 0.4s ease; }

        /* Dashboard & Stats */
        .stat-card { background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); transition: all 0.2s ease; cursor: pointer; opacity: 0.85; }
        .stat-card:hover { transform: translateY(-2px); opacity: 1; }
        .stat-card.active-filter { opacity: 1; transform: scale(1.02); box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: 800; margin-bottom: 6px; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;}
        /* Claim count cards are bigger */
        .stat-card.claim-card { padding: 24px 16px; }
        .stat-card.claim-card .stat-value { font-size: 2.6rem; margin-bottom: 8px; }
        .stat-card.claim-card .stat-label { font-size: 0.8rem; }

        /* App Footer */
        .app-footer { padding: 24px 0 32px; margin-top: auto; max-width: 650px; margin-left: auto; margin-right: auto; width: 100%; }

        /* Tables */
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); -webkit-overflow-scrolling: touch; width: 100%; box-shadow: var(--shadow); }
        table { width: max-content; min-width: 100%; border-collapse: collapse; text-align: left; font-size: 0.75rem; }
        th, td { padding: 7px 12px; border-bottom: 1px solid var(--border); white-space: nowrap; }
        th { background-color: var(--bg-base); font-weight: 700; color: var(--text-muted); text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.5px; }
        tr { transition: background-color 0.15s; }
        tr:hover td { background-color: var(--bg-base); cursor: pointer; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 2; border-right: 1px solid var(--border); font-weight: 600; }
        th:first-child { background-color: var(--bg-base); } td:first-child { background-color: var(--surface); }

        /* Mobile Compact Table for Custom Codes */
        @media (max-width: 600px) {
            #screen-settings .table-wrap table { font-size: 0.7rem; }
            #screen-settings th, #screen-settings td { padding: 6px 8px; }
            #screen-settings th:nth-child(2), #screen-settings td:nth-child(2) { white-space: normal; word-break: break-word; min-width: 120px; }
            #screen-settings .btn.danger { padding: 4px 8px; font-size: 0.7rem; }
            #screen-settings td:last-child { text-align: center; }
        }

        .status-clear { color: #10b981; font-weight: 800; letter-spacing: 0.5px; }
        .status-unclear { color: #f59e0b; font-weight: 800; letter-spacing: 0.5px; }
        .status-pending { color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; }
        /* Animated top border line on stat cards — color shift only, no glow */
        @keyframes border-green { 0%,100%{ border-top-color: #10b981; } 50%{ border-top-color: #34d399; } }
        @keyframes border-amber { 0%,100%{ border-top-color: #f59e0b; } 50%{ border-top-color: #fde68a; } }
        @keyframes border-muted { 0%,100%{ border-top-color: #94a3b8; } 50%{ border-top-color: #e2e8f0; } }
        @keyframes border-accent { 0%,100%{ border-top-color: var(--accent); } 50%{ border-top-color: #93c5fd; } }
        #dash-card-all, #ws-filter-all { animation: border-accent 2s ease-in-out infinite; }
        #dash-card-clean, #ws-filter-clean { animation: border-green 2s ease-in-out infinite; }
        #dash-card-unclear, #ws-filter-unclear { animation: border-amber 2s ease-in-out infinite; }
        #dash-card-pending, #ws-filter-pending { animation: border-muted 2.5s ease-in-out infinite; }
        
        /* Abbreviations Hint - Top Global Position */
        .legend-hint { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; padding: 12px; background: var(--bg-base); border-radius: 8px; margin-bottom: 16px; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); border: 1px solid var(--border); }
        .legend-dot { width: 9px; height: 9px; border-radius: 50%; display: inline-block; margin-right: 4px; box-shadow: 0 0 0 1.5px rgba(255,255,255,0.15); }

        /* Modals */
        .modal-backdrop { position: fixed; inset: 0; background-color: var(--modal-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.25s ease; backdrop-filter: blur(5px); }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        .modal-dialog { width: 100%; max-width: 440px; max-height: 90vh; display: flex; flex-direction: column; margin: 16px; background: var(--surface); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-backdrop.active .modal-dialog { transform: scale(1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); background: var(--bg-base); }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .all-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: var(--bg-base); padding: 16px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        .detail-item span { display: block; } .detail-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; } .detail-val { font-size: 0.85rem; font-weight: 600; word-break: break-word; white-space: normal; }
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; } .pagination .btn { width: auto; margin: 0; padding: 8px 16px; }
        
        #loader { position: fixed; inset: 0; background: var(--surface); z-index: 2000; display: none; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; color: var(--primary); flex-direction: column; gap: 16px; transition: opacity 0.3s; }
        .spinner { width: 44px; height: 44px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.6, 0.2, 0.4, 0.8) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; background: var(--bg-base); border: 1px solid var(--border); }


        /* Security toggle pill */
        .sec-toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .sec-toggle-pill {
            position: relative; width: 44px; height: 24px; border-radius: 12px;
            background: var(--border); border: none; cursor: pointer;
            transition: background 0.25s ease; flex-shrink: 0; padding: 0;
        }
        .sec-toggle-pill.on { background: var(--success); }
        .sec-toggle-pill::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 18px; height: 18px; border-radius: 50%;
            background: white; transition: transform 0.25s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .sec-toggle-pill.on::after { transform: translateX(20px); }

        /* ── PC / TV ENHANCEMENTS ── */

        /* 21. Max-width 900px centered container */
        body { max-width: 1400px; margin-left: auto; margin-right: auto; }
        .app-header { max-width: 900px; margin-left: auto; margin-right: auto; width: 100%; }

        @media (min-width: 900px) {
            body { padding: 24px 32px; }

            /* 28. Larger click targets on large viewport */
            .menu-card { padding: 32px 16px; font-size: 0.9rem; }
            .menu-icon { width: 38px; height: 38px; }
            .btn { padding: 13px 18px; font-size: 0.88rem; }
            th, td { padding: 9px 14px; }

            /* 29. Font scale increase */
            body { font-size: 15px; }
        }

        /* 25. Focus ring — visible on all interactive elements for Tab/TV nav */
        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 6px;
        }
        .menu-card:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 3px;
            border-radius: var(--radius);
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(0,0,0,0.1);
            color: var(--accent);
        }
        .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        tr:focus-visible td { background-color: var(--bg-base); outline: 2px solid var(--accent); }

        /* 23. Row hover tooltip */
        tr { position: relative; }

        /* 22. Two-column layout on wide screens: table + side panel */
        @media (min-width: 1100px) {
            #screen-workspace, #screen-dashboard {
                /* will be handled via JS class toggle when modal opens */
            }
            .wide-layout-wrapper {
                display: grid;
                grid-template-columns: 1fr 420px;
                gap: 24px;
                align-items: start;
            }
            .wide-layout-wrapper .wide-left { min-width: 0; }
            .wide-layout-wrapper .wide-right { position: sticky; top: 16px; }
            /* Side panel audit modal */
            #audit-modal.side-panel {
                position: static;
                background: none;
                backdrop-filter: none;
                pointer-events: auto;
                opacity: 1;
                display: block;
            }
            #audit-modal.side-panel .modal-dialog {
                margin: 0;
                max-width: 100%;
                transform: none;
                border: 1px solid var(--border);
                box-shadow: var(--shadow);
                max-height: none;
            }
        }

        /* 20/24. Shortcut help overlay */
        #shortcut-overlay {
            position: fixed; inset: 0; background: var(--modal-overlay);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
            backdrop-filter: blur(4px);
        }
        #shortcut-overlay.active { opacity: 1; pointer-events: auto; }
        #shortcut-overlay .so-dialog {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px; width: 100%; max-width: 520px;
            margin: 16px; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3);
        }
        .so-title { font-size: 1rem; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }
        .so-section { margin-bottom: 18px; }
        .so-section-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-muted); margin-bottom: 10px; }
        .so-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
        .so-row:last-child { border-bottom: none; }
        .so-keys { display: flex; gap: 4px; }
        .so-key { background: var(--bg-base); border: 1px solid var(--border); border-radius: 5px; padding: 2px 8px; font-size: 0.72rem; font-weight: 700; font-family: monospace; color: var(--text-main); white-space: nowrap; }
        .so-desc { color: var(--text-muted); }

        /* Tooltip on table rows */
        .row-tooltip {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: var(--primary); color: var(--primary-text);
            padding: 3px 8px; border-radius: 6px; font-size: 0.68rem; font-weight: 700;
            white-space: nowrap; pointer-events: none; opacity: 0;
            transition: opacity 0.15s; z-index: 10;
        }
        tr:hover .row-tooltip { opacity: 1; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><span>Processing...</span></div>

    <!-- Shortcut Help Overlay (#20) -->
    <div id="shortcut-overlay" onclick="closeShortcutOverlay(event)">
        <div class="so-dialog">
            <div class="so-title">
                Keyboard Shortcuts
                <button onclick="toggleShortcutOverlay()" style="background:none;border:none;cursor:pointer;padding:4px;color:var(--text-muted);font-size:1.2rem;" title="Close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <div class="so-section">
                <div class="so-section-title">Navigation</div>
                <div class="so-row"><span class="so-desc">Back to Main Menu</span><div class="so-keys"><span class="so-key">Esc</span></div></div>
                <div class="so-row"><span class="so-desc">Exit Workspace (confirm)</span><div class="so-keys"><span class="so-key">Esc</span></div></div>
                <div class="so-row"><span class="so-desc">This help overlay</span><div class="so-keys"><span class="so-key">?</span></div></div>
            </div>

            <div class="so-section">
                <div class="so-section-title">Workspace</div>
                <div class="so-row"><span class="so-desc">Type to search claims</span><div class="so-keys"><span class="so-key">0–9</span><span class="so-key">A–Z</span></div></div>
                <div class="so-row"><span class="so-desc">Open first claim in list</span><div class="so-keys"><span class="so-key">Enter</span></div></div>
                <div class="so-row"><span class="so-desc">Previous / Next page</span><div class="so-keys"><span class="so-key">←</span><span class="so-key">→</span></div></div>
            </div>

            <div class="so-section">
                <div class="so-section-title">Dashboard</div>
                <div class="so-row"><span class="so-desc">Type to search claims</span><div class="so-keys"><span class="so-key">0–9</span><span class="so-key">A–Z</span></div></div>
                <div class="so-row"><span class="so-desc">Previous / Next page</span><div class="so-keys"><span class="so-key">←</span><span class="so-key">→</span></div></div>
            </div>

            <div class="so-section">
                <div class="so-section-title">Audit Modal</div>
                <div class="so-row"><span class="so-desc">Save entry</span><div class="so-keys"><span class="so-key">Enter</span></div></div>
                <div class="so-row"><span class="so-desc">Close / cancel</span><div class="so-keys"><span class="so-key">Esc</span></div></div>
                <div class="so-row"><span class="so-desc">Quick-select discrepancy</span><div class="so-keys"><span class="so-key">0–9</span></div></div>
            </div>

            <div class="so-section">
                <div class="so-section-title">Dropdown</div>
                <div class="so-row"><span class="so-desc">Navigate options</span><div class="so-keys"><span class="so-key">↑</span><span class="so-key">↓</span></div></div>
                <div class="so-row"><span class="so-desc">Select focused option</span><div class="so-keys"><span class="so-key">Enter</span></div></div>
                <div class="so-row"><span class="so-desc">Close dropdown</span><div class="so-keys"><span class="so-key">Esc</span></div></div>
            </div>

            <div class="so-section">
                <div class="so-section-title">Menu Grid (TV / Tab)</div>
                <div class="so-row"><span class="so-desc">Navigate cards</span><div class="so-keys"><span class="so-key">↑</span><span class="so-key">↓</span><span class="so-key">←</span><span class="so-key">→</span></div></div>
                <div class="so-row"><span class="so-desc">Open selected card</span><div class="so-keys"><span class="so-key">Enter</span><span class="so-key">Space</span></div></div>
                <div class="so-row"><span class="so-desc">Tab through all elements</span><div class="so-keys"><span class="so-key">Tab</span></div></div>
            </div>
        </div>
    </div>

    <div id="app-dialog" class="modal-backdrop">
        <div class="modal-dialog" style="max-width: 340px;">
            <div class="modal-body" style="text-align:center; padding: 32px 24px;">
                <h3 id="dialog-msg" style="margin-bottom:20px; font-size:1.05rem; line-height: 1.5;"></h3>
                
                <div id="dialog-input-wrapper" style="position:relative; display:none; margin-bottom: 16px;" autocomplete="off">
                    <input type="text" id="dialog-input" inputmode="numeric" class="input" style="text-align:center; letter-spacing: 4px; font-size: 1.2rem; margin:0; padding-right: 44px; -webkit-text-security: disc; text-security: disc;" placeholder="••••••••" autocomplete="off" data-lpignore="true" data-form-type="other" spellcheck="false" autocorrect="off" autocapitalize="off">
                    <button id="kb-toggle" onclick="toggleKeyboardMode('dialog-input', this)" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:var(--bg-base); border:1px solid var(--border); border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Toggle Keyboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></button>
                </div>

                <div style="display:flex; gap:12px; justify-content:center; margin-top: 12px;">
                    <button class="btn primary" id="dialog-btn-yes" style="margin:0;">Confirm</button>
                    <button class="btn" id="dialog-btn-no" style="margin:0; display:none;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-header">
        <h1 class="app-title">
            <div class="app-title-badge">
                <img class="app-title-icon" src="data:image/png;base64,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" alt="Hyundai">
                <span class="app-title-text">Warranty Auditor</span>

            </div>
        </h1>
        <div style="display:flex;gap:6px;align-items:center;">
            <button id="header-upload-btn" class="header-action-btn upload-shortcut" onclick="headerUploadNow()" title="Upload to GitHub Cloud">
                <svg viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                <span class="btn-label">Backup</span>
            </button>
            <button id="header-restore-btn" class="header-action-btn restore-shortcut" onclick="headerRestoreNow()" title="Restore from GitHub Cloud">
                <svg viewBox="0 0 24 24"><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/><polyline points="8 13 12 17 16 13"/><line x1="12" y1="17" x2="12" y2="9"/></svg>
                <span class="btn-label">Restore</span>
            </button>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </div>

    <div id="screen-menu" class="screen active">
        
        <div id="main-notification" class="notification-banner" onclick="buildDashboard()">
            <svg style="width:24px; height:24px; flex-shrink:0; stroke:currentColor; stroke-width:2; fill:none;" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            <span id="notif-text">Loading notifications...</span>
        </div>

        <div id="suspense-notification" class="notification-banner" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.4); color: var(--danger); display: none;" onclick="buildDashboard()">
            <svg style="width:24px; height:24px; flex-shrink:0; stroke:currentColor; stroke-width:2; fill:none;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <span id="suspense-notif-text">Loading suspense notifications...</span>
        </div>

        <div class="menu-grid">
            <div class="menu-card" tabindex="0" onclick="showScreen('screen-new-audit')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showScreen('screen-new-audit');}">
                <svg class="menu-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                <span>New Audit</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="openArchive(false)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openArchive(false);}">
                <svg class="menu-icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                <span>Drafts</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="openArchive(true)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openArchive(true);}">
                <svg class="menu-icon" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                <span>Previous Audits</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="buildDashboard()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();buildDashboard();}">
                <svg class="menu-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                <span>Dashboard</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="openReportingMenu()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openReportingMenu();}">
                <svg class="menu-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                <span>Reports Export</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="showScreen('screen-backup')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showScreen('screen-backup');}">
                <svg class="menu-icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>Backup & Restore</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="showScreen('screen-security')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();showScreen('screen-security');}">
                <svg class="menu-icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span>Security Settings</span>
            </div>
            <div class="menu-card" tabindex="0" onclick="openSettingsScreen()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openSettingsScreen();}">
                <svg class="menu-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                <span>Custom Codes</span>
            </div>
        </div>

        <footer class="app-footer">
            <div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow);">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:14px;">
                    <div style="width:36px;height:36px;background:var(--primary);border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <svg style="width:18px;height:18px;stroke:var(--primary-text);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><path d="M12 2L3 7v5c0 5.25 3.75 10.15 9 11.25C17.25 22.15 21 17.25 21 12V7L12 2z"/><path d="M9 12l2 2 4-4"/></svg>
                    </div>
                    <div>
                        <div style="font-size:0.95rem;font-weight:800;color:var(--text-main);">Warranty Auditor</div>
                        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:1px;">by Aashish Giri H</div>
                    </div>
                </div>
                <p style="font-size:0.78rem;color:var(--text-muted);line-height:1.65;margin:0;">
                    A professional warranty claims audit tool built for dealership audit specialists. Supports Excel import, claim-by-claim auditing with discrepancy tagging, finalized reports with PDF &amp; Excel export, AES-256 local encryption, and cloud backup via GitHub Gist &amp; Google Drive — all fully offline-capable.
                </p>
            </div>
        </footer>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="flex-between" style="margin-bottom: 12px;">
            <h3 style="margin:0;">Dashboard</h3>
            <button class="btn" style="width:auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>
        
        <div class="legend-hint">
            <span><span class="legend-dot" style="background:#10b981;"></span> <b>Cln</b> = Clean (No Discrepancy)</span>
            <span><span class="legend-dot" style="background:#f59e0b;"></span> <b>Unc</b> = Unclear (Discrepancy Found)</span>
            <span><span class="legend-dot" style="background:#94a3b8;"></span> <b>Pen</b> = Pending (Not Audited)</span>
        </div>

        <label>Select Audit Period</label>
        <div class="custom-select-wrapper" id="wrap-dash-scope">
            <input type="hidden" id="dash-scope" value="">
            <div class="custom-select-trigger"><span class="trigger-text">Select an Audit to View...</span> <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
            <div class="custom-options" id="options-dash-scope"></div>
        </div>

        <div id="dash-content-area" style="display:none; animation: slideFadeUp 0.3s ease;">
            <div class="grid-2" style="margin-bottom: 8px;">
                <div class="stat-card claim-card active-filter" id="dash-card-all" style="border-top: 4px solid var(--accent);" onclick="setDashFilter('all')">
                    <div class="stat-value" id="dash-total">0</div><div class="stat-label">Total Claims</div>
                </div>
                <div class="stat-card claim-card" id="dash-card-clean" style="border-top: 4px solid var(--success);" onclick="setDashFilter('clean')">
                    <div class="stat-value" id="dash-clean" style="color:var(--success)">0</div><div class="stat-label">Total Claims Clean</div>
                </div>
                <div class="stat-card claim-card" id="dash-card-unclear" style="border-top: 4px solid var(--warning);" onclick="setDashFilter('unclear')">
                    <div class="stat-value" id="dash-unclear" style="color:var(--warning)">0</div><div class="stat-label">Total Claims Unclear</div>
                </div>
                <div class="stat-card claim-card" id="dash-card-pending" style="border-top: 4px solid var(--text-muted);" onclick="setDashFilter('pending')">
                    <div class="stat-value" id="dash-pending">0</div><div class="stat-label">Total Claims Pending</div>
                </div>
            </div>

            <div id="dash-amount-stats" style="margin-bottom:20px;"></div>
            
            <div id="dash-suspense-notif" class="notification-banner" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.4); color: var(--danger); display: none; max-width: 100%; margin-bottom: 16px;">
                <svg style="width:20px; height:20px; flex-shrink:0; stroke:currentColor; stroke-width:2; fill:none;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                <span id="dash-suspense-text"></span>
            </div>
            
            <button class="btn" id="btn-toggle-chart" onclick="toggleDashChart()" style="margin-bottom:16px; display:inline-flex; align-items:center; gap:8px;">
    <svg style="width:18px; height:18px; stroke:currentColor; stroke-width:2; fill:none; stroke-linecap:round; stroke-linejoin:round;" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg> 
    Show Chart
</button>
        <div id="dash-chart-container" style="display:none; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px;">
            <canvas id="auditChart" height="220"></canvas>
        </div>

            <div style="position:relative; margin-bottom:16px; width: 100%;">
                <svg style="position:absolute; left:12px; top:50%; transform:translateY(-50%); width:20px; height:20px; stroke:var(--text-muted); stroke-width:2; fill:none; z-index:5;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="dash-search" inputmode="numeric" class="input" placeholder="Enter Claim Number..." oninput="handleDashSearch()" style="padding-left:40px; padding-right:44px; margin-bottom:0;">
                <button onclick="toggleKeyboardMode('dash-search', this)" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:var(--bg-base); border:1px solid var(--border); border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Toggle Keyboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></button>
            </div>

            <div class="table-wrap">
                <table id="dash-table">
                    <thead><tr>
                        <th style="cursor:pointer;" onclick="dashSortTable(0)">Claim No ↕</th>
                        <th style="cursor:pointer;" onclick="dashSortTable(1)">Status ↕</th>
                        <th>R/O No</th><th>Type</th><th>Causal Part</th><th>Part Desc</th>
                        <th style="cursor:pointer;" onclick="dashSortTable(6)">Prod Date ↕</th>
                        <th style="cursor:pointer;" onclick="dashSortTable(7)">Amount ↕</th>
                        <th>Findings</th><th>Remarks</th>
                    </tr></thead>
                    <tbody id="dash-tbody"></tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button class="btn" onclick="changeDashPage(-1)" id="dash-btn-prev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg> Previous</button>
                <span id="dash-page-indicator" style="font-size: 0.85rem; color: var(--text-muted); font-weight: 700;">Page 1</span>
                <button class="btn" onclick="changeDashPage(1)" id="dash-btn-next">Next <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
            </div>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <div class="flex-between" style="margin-bottom: 16px;">
            <h3 style="margin:0;">Custom Discrepancy Codes</h3>
            <button class="btn" style="width:auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>
        <div class="card">
            <p>Add your own codes for the audit dropdown. (e.g. Code: 9, Desc: Labour Mismatch)</p>
            <div class="grid-2">
                <div style="position:relative; width: 100%; margin-bottom: 16px;">
                    <input type="text" id="new-code-id" inputmode="numeric" class="input" placeholder="Enter Code Number" style="padding-right:44px; margin-bottom:0;">
                    <button onclick="toggleKeyboardMode('new-code-id', this)" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:var(--bg-base); border:1px solid var(--border); border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Toggle Keyboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></button>
                </div>
                <input type="text" id="new-code-desc" class="input" placeholder="Enter Description">
            </div>
            <div class="custom-select-wrapper" id="wrap-new-code-type" style="margin-bottom: 16px;">
                <input type="hidden" id="new-code-type" value="unclear">
                <div class="custom-select-trigger"><span class="trigger-text">Marks as Unclear (Discrepancy Found)</span> <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                <div class="custom-options">
                    <div class="custom-option selected" data-value="unclear">Marks as Unclear (Discrepancy Found)</div>
                    <div class="custom-option" data-value="clean">Marks as Clean (No Discrepancy)</div>
                </div>
            </div>
            <button class="btn primary" onclick="addCustomCode()">+ Add Code</button>
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>Code</th><th>Description</th><th>Action</th></tr></thead>
                <tbody id="settings-codes-tbody"></tbody>
            </table>
        </div>
    </div>
    <div id="screen-security" class="screen">
        <div class="flex-between" style="margin-bottom: 12px; max-width: 440px; margin-left: auto; margin-right: auto; width: 100%;">
            <h3 style="margin:0;">Security Settings</h3>
            <button class="btn" style="width:auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>
        <div class="card" style="max-width: 440px; margin: 0 auto; width: 100%;">
            <p style="margin-bottom:16px;">Manage access control locks for the app and archived audits.</p>
            
            <div style="background: var(--bg-base); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px;">
                <div class="sec-toggle-row">
                    <span style="font-weight:700;">App Launch Lock</span>
                    <button class="sec-toggle-pill" id="btn-toggle-app-sec" onclick="toggleSecurity('app')" title="Toggle App Lock"></button>
                </div>
                <p style="font-size:0.75rem; margin:10px 0 0 0; color:var(--text-muted);">Requires Master Password upon opening the website.</p>
            </div>

            <div style="background: var(--bg-base); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                <div class="sec-toggle-row">
                    <span style="font-weight:700;">Archive Protection</span>
                    <button class="sec-toggle-pill" id="btn-toggle-arc-sec" onclick="toggleSecurity('archive')" title="Toggle Archive Lock"></button>
                </div>
                <p style="font-size:0.75rem; margin:10px 0 0 0; color:var(--text-muted);">Requires Master Password to open or delete Finalized Audits.</p>
            </div>

            <button class="btn" onclick="showScreen('screen-menu')" style="display:none;"></button>
        </div>
    </div>

    <div id="screen-backup" class="screen">
        <div class="flex-between" style="margin-bottom: 12px; max-width: 440px; margin-left: auto; margin-right: auto; width: 100%;">
            <h3 style="margin:0;">Backup &amp; Restore</h3>
            <button class="btn" style="width:auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>
        <div class="card" style="max-width: 440px; margin: 0 auto; width: 100%;">
            <p style="margin-bottom:16px;">Export and restore a full local backup of all audit data.</p>
            
            <button class="btn primary" style="margin-bottom: 24px; padding: 14px;" onclick="backupDatabase()">
                <svg class="menu-icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download Full Backup
            </button>
            <hr style="border:none; border-top:1px solid var(--border); margin-bottom: 24px;">
            <label>Restore Database</label>
            <p style="font-size:0.75rem; color:var(--danger); margin-bottom: 12px; font-weight:600;">Warning: This will overwrite current data.</p>
            <div class="file-upload-wrapper">
                <input type="file" id="restore-file" accept=".json" onchange="handleFileSelect(event, 'restore'); restoreDatabase(event);">
                <label for="restore-file" class="file-upload-btn">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Browse File</span>
                </label>
            </div>
            <div id="restore-file-card" style="display: none;"></div>

        </div><!-- end local backup card -->

        <!-- ══════════ GITHUB GIST CLOUD SYNC ══════════ -->
        <div class="card" style="max-width: 440px; margin: 0 auto 16px auto; width: 100%;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                <svg style="width:22px;height:22px;fill:var(--text-main);flex-shrink:0;" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
                <h3 style="margin:0; font-size:1rem;">GitHub Cloud Sync</h3>
                <span id="gist-status-dot" style="margin-left:auto; font-size:0.75rem; font-weight:700; padding:3px 10px; border-radius:20px; background:rgba(100,116,139,0.1); color:var(--text-muted);">Not Connected</span>
            </div>
            <p style="font-size:0.75rem; margin-bottom:12px;">Sync to a private GitHub Gist. Accessible from any device with your token.</p>

            <div id="gist-setup-section">
                <label>GitHub Personal Access Token</label>
                <div style="position:relative; margin-bottom:12px;">
                    <input type="text" id="gist-token-input" class="input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" style="margin-bottom:0; padding-right:44px; font-family:monospace; font-size:0.85rem; -webkit-text-security: disc; text-security: disc;" autocomplete="off" data-lpignore="true" data-form-type="other" spellcheck="false" autocorrect="off" autocapitalize="off">
                    <button onclick="toggleGistTokenVisibility()" id="gist-token-eye" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--bg-base);border:1px solid var(--border);border-radius:6px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-muted);font-size:16px;" title="Show/Hide Token"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
                <p style="font-size:0.7rem; color:var(--text-muted); margin-bottom:16px; line-height:1.6;">
                    <b>How to get token:</b> GitHub → Settings → Developer Settings → Personal Access Tokens → Tokens (classic) → Generate new token → Select <b>"gist"</b> scope only → Copy & paste here.
                </p>
                <p style="font-size:0.7rem; color:var(--text-muted); margin-bottom:14px;">Token is encrypted with AES-256-GCM. Raw value is never stored.</p>
                <button class="btn primary" onclick="connectGist()" style="margin-bottom:8px;">
                    <svg style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    Connect & Encrypt Token
                </button>
            </div>

            <div id="gist-connected-section" style="display:none;">
                <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.3); border-radius:10px; padding:14px; margin-bottom:12px; font-size:0.8rem;">
                    <div style="font-weight:700; color:var(--success); margin-bottom:4px;">Connected to GitHub Gist</div>
                    <div style="color:var(--text-muted);" id="gist-info-text">Gist ID: loading...</div>
                </div>
                <!-- LAST SYNC CARD -->
                <div id="last-sync-card" style="display:none; background:var(--bg-base); border:1px solid var(--border); border-radius:10px; padding:12px 14px; margin-bottom:14px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:3px;">Last Cloud Backup</div>
                            <div id="last-sync-display" style="font-size:0.88rem; font-weight:700; color:var(--text-main);">—</div>
                            <div id="last-sync-age" style="font-size:0.7rem; color:var(--text-muted); margin-top:2px;"></div>
                        </div>
                        <svg style="width:26px;height:26px;stroke:var(--success);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;opacity:0.7;" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                </div>

                <!-- AUTO-SYNC TOGGLE -->
                <div style="background:var(--bg-base); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:14px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <div style="font-weight:700; font-size:0.85rem;">Auto-Sync</div>
                            <div style="font-size:0.72rem; color:var(--text-muted); margin-top:2px;" id="autosync-status-text">Loading...</div>
                        </div>
                        <button id="btn-autosync-toggle" onclick="toggleAutoSync()" style="padding:6px 14px; border-radius:20px; border:1px solid var(--border); background:var(--surface); font-size:0.78rem; font-weight:700; cursor:pointer; transition:all 0.2s; color:var(--text-muted);">OFF</button>
                    </div>
                    <!-- Rate limit warning -->
                    <div id="autosync-warning" style="display:none; background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.3); border-radius:8px; padding:10px; font-size:0.72rem; color:var(--warning); line-height:1.6;">
                        GitHub allows 5,000 API requests/hour. Auto-sync uses ~18/hour. Turn off if sharing token across multiple devices.
                    </div>
                    <div id="autosync-triggers" style="display:none; margin-top:10px; font-size:0.72rem; color:var(--text-muted); line-height:1.8;">
                        Triggers on: <b>Finalize</b> · <b>Tab close</b> · <b>Every 3 min</b>
                    </div>
                </div>

                <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                    <span id="gist-sync-indicator" style="display:none; font-size:0.75rem; color:var(--accent); font-weight:600; align-items:center; gap:6px;"><span style="width:7px;height:7px;border-radius:50%;background:var(--accent);display:inline-block;animation:pulse 1.2s ease-in-out infinite;"></span> Syncing...</span>
                </div>

                <div class="grid-2" style="gap:8px; margin-bottom:8px;">
                    <button class="btn" onclick="syncToGist(true)" style="margin:0; background:var(--success); color:white; border-color:var(--success);">
                        <svg style="width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                        Backup Now
                    </button>
                    <button class="btn" onclick="restoreFromGist()" style="margin:0;">
                        <svg style="width:15px;height:15px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><polyline points="8 8 12 12 16 8"/><line x1="12" y1="12" x2="12" y2="3"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                        Restore from Cloud
                    </button>
                </div>
                <div class="grid-2" style="gap:8px; margin-top:8px;">
                    <button class="btn" onclick="disconnectGist()" style="margin:0; padding:10px 16px; background:var(--surface); border:1px solid var(--warning); color:var(--warning); font-weight:600;">
                        <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;margin-right:4px;" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        Disconnect GitHub
                    </button>
                    <button class="btn" onclick="deleteGistFile()" style="margin:0; padding:10px 16px; background:var(--surface); border:1px solid var(--danger); color:var(--danger); font-weight:600;">
                        <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;margin-right:4px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                        Delete Cloud File
                    </button>
                </div>
            </div>
        </div><!-- end GitHub card -->

        <!-- ══════════ GOOGLE DRIVE CLOUD SYNC ══════════ -->
        <div class="card" style="max-width: 440px; margin: 0 auto 16px auto; width: 100%;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                <!-- Google Drive logo (official colors) -->
                <svg style="width:22px;height:22px;flex-shrink:0;" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
                    <path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/>
                    <path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/>
                    <path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"/>
                    <path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/>
                    <path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/>
                    <path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/>
                </svg>
                <h3 style="margin:0; font-size:1rem;">Google Drive Sync</h3>
                <span id="gdrive-status-dot" style="margin-left:auto; font-size:0.75rem; font-weight:700; padding:3px 10px; border-radius:20px; background:rgba(100,116,139,0.1); color:var(--text-muted);">Not Connected</span>
            </div>
            <p style="font-size:0.75rem; margin-bottom:12px;">Sync backup to Google Drive. Accessible from any signed-in device.</p>

            <div id="gdrive-setup-section">
                <p style="font-size:0.7rem; color:var(--text-muted); margin-bottom:14px;">Sign in to authorize access. Backup is stored privately in your Google Drive.</p>
                <button class="btn" onclick="connectGoogleDrive()" style="margin-bottom:8px; background:white; color:#1f2937; border:1px solid #dadce0; font-weight:700; gap:10px;">
                    <svg style="width:18px;height:18px;flex-shrink:0;" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg"><path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"/><path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"/><path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"/><path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"/><path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"/><path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"/></svg>
                    Sign in with Google
                </button>
            </div>

            <div id="gdrive-connected-section" style="display:none;">
                <!-- Account info -->
                <div style="background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.3); border-radius:10px; padding:14px; margin-bottom:12px; font-size:0.8rem;">
                    <div style="font-weight:700; color:var(--success); margin-bottom:4px;">Connected to Google Drive</div>
                    <div style="color:var(--text-muted);" id="gdrive-info-text">Loading account info...</div>
                </div>

                <!-- Cloud backup status card — shows what's on Drive -->
                <div id="gdrive-cloud-status-card" style="background:var(--bg-base); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:14px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div style="font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted);">Cloud Backup Status</div>
                        <button onclick="checkGdriveBackupStatus()" id="gdrive-refresh-btn" style="background:none;border:none;cursor:pointer;font-size:0.68rem;color:var(--accent);font-weight:700;padding:0;">↻ Refresh</button>
                    </div>
                    <div id="gdrive-cloud-status-body">
                        <div style="color:var(--text-muted); font-size:0.78rem;">Checking Drive...</div>
                    </div>
                </div>

                <!-- Action buttons -->
                <div class="grid-2" style="gap:8px; margin-bottom:8px;">
                    <button class="btn" id="gdrive-backup-btn" onclick="uploadToGoogleDrive()" style="margin:0; background:#4285f4; color:white; border-color:#4285f4; font-weight:700;">
                        <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                        Backup to Drive
                    </button>
                    <button class="btn" id="gdrive-restore-btn" onclick="restoreFromGoogleDrive()" style="margin:0; font-weight:700;">
                        <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><polyline points="8 8 12 12 16 8"/><line x1="12" y1="12" x2="12" y2="3"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                        Restore from Drive
                    </button>
                </div>
                <!-- New device hint -->
                <div id="gdrive-new-device-hint" style="display:none; background:rgba(59,130,246,0.08); border:1px solid rgba(59,130,246,0.25); border-radius:8px; padding:10px 12px; margin-bottom:10px; font-size:0.72rem; color:var(--accent); line-height:1.6;">
                    <b>New Device:</b> No local data found. A backup exists from <span id="gdrive-hint-date" style="font-weight:700;"></span>. Click <b>Restore from Drive</b> to load.
                </div>
                <button class="btn" onclick="disconnectGoogleDrive()" style="margin:0; padding:10px 16px; background:var(--surface); border:1px solid var(--warning); color:var(--warning); font-weight:600;">
                    <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;margin-right:4px;" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    Disconnect Google Drive
                </button>
            </div>
            <!-- ══════════════════════════════════════════════ -->
        </div><!-- end Google Drive card -->

    </div>

    <div id="screen-new-audit" class="screen">
        <div class="card" style="max-width: 440px; margin: 0 auto; width: 100%;">
            <h3>Setup Audit</h3>
            <!-- Hidden inputs — retain YYYY-MM-DD for JS compatibility -->
            <input type="hidden" id="audit-from">
            <input type="hidden" id="audit-to">

            <div class="grid-2" style="margin-bottom:16px;">
                <!-- FROM picker -->
                <div>
                    <label>From</label>
                    <div class="mp-wrapper" id="mp-from" data-target="audit-from">
                        <div class="mp-display" onclick="toggleMonthPicker('mp-from')">
                            <svg class="mp-cal-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <span class="mp-label placeholder" id="mp-from-label">Select month</span>
                            <svg class="mp-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="mp-dropdown" id="mp-from-dropdown">
                            <div class="mp-year-row">
                                <button type="button" class="mp-yr-btn" onclick="shiftYear('mp-from',-1)"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
                                <span class="mp-year-label" id="mp-from-year">2025</span>
                                <button type="button" class="mp-yr-btn" onclick="shiftYear('mp-from',1)"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
                            </div>
                            <div class="mp-months" id="mp-from-months"></div>
                        </div>
                    </div>
                </div>
                <!-- TO picker -->
                <div>
                    <label>To</label>
                    <div class="mp-wrapper" id="mp-to" data-target="audit-to">
                        <div class="mp-display" onclick="toggleMonthPicker('mp-to')">
                            <svg class="mp-cal-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            <span class="mp-label placeholder" id="mp-to-label">Select month</span>
                            <svg class="mp-chevron" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="mp-dropdown" id="mp-to-dropdown">
                            <div class="mp-year-row">
                                <button type="button" class="mp-yr-btn" onclick="shiftYear('mp-to',-1)"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
                                <span class="mp-year-label" id="mp-to-year">2025</span>
                                <button type="button" class="mp-yr-btn" onclick="shiftYear('mp-to',1)"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
                            </div>
                            <div class="mp-months" id="mp-to-months"></div>
                        </div>
                    </div>
                </div>
            </div>
            <label>Source Excel File</label>
            <div class="file-upload-wrapper">
                <input type="file" id="audit-file" accept=".xlsx, .xls" onchange="handleFileSelect(event, 'audit')">
                <label for="audit-file" class="file-upload-btn">
                    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <span>Browse File</span>
                </label>
            </div>
            <div id="audit-file-card" style="display: none;"></div>
            <div class="grid-2" style="margin-top: 12px;">
                <button class="btn primary" style="margin:0;" onclick="startNewAudit()">Load Data</button>
                <button class="btn" style="margin:0;" onclick="showScreen('screen-menu')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="screen-workspace" class="screen">
        <div class="flex-between" style="margin-bottom: 12px;">
            <h3 id="workspace-title" style="margin:0; font-size:1.15rem;">Workspace</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn primary" style="width: auto; margin:0; padding: 8px 16px; font-size:0.8rem;" onclick="finalizeAuditFlow()">Finalize</button>
                <button class="btn danger" style="width: auto; margin:0; padding: 8px 16px; font-size:0.8rem;" onclick="discardWorkspace()">Discard</button>
                <button class="btn" style="width: auto; margin:0; padding: 8px 16px; font-size:0.8rem;" onclick="requestExitWorkspace()">Menu</button>
            </div>
        </div>

        <div class="legend-hint">
            <span><span class="legend-dot" style="background:#10b981;"></span> <b>Cln</b> = Clean</span>
            <span><span class="legend-dot" style="background:#f59e0b;"></span> <b>Unc</b> = Unclear</span>
            <span><span class="legend-dot" style="background:#94a3b8;"></span> <b>Pen</b> = Pending</span>
        </div>

        <div id="workspace-stats" style="margin-bottom: 16px;"></div>
        
        <div id="workspace-suspense-notif" class="notification-banner" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.4); color: var(--danger); display: none; max-width: 100%; margin-bottom: 16px;">
            <svg style="width:20px; height:20px; flex-shrink:0; stroke:currentColor; stroke-width:2; fill:none;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <span id="workspace-suspense-text"></span>
        </div>
        
        <div style="position:relative; margin-bottom:16px; width: 100%;">
            <svg style="position:absolute; left:12px; top:50%; transform:translateY(-50%); width:20px; height:20px; stroke:var(--text-muted); stroke-width:2; fill:none; z-index:5;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="search-claim" inputmode="numeric" class="input" placeholder="Search Claim No..." oninput="handleSearch()" style="padding-left:40px; padding-right:44px; margin-bottom:0;">
            <button onclick="toggleKeyboardMode('search-claim', this)" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); background:var(--bg-base); border:1px solid var(--border); border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-muted); transition:0.2s;" title="Toggle Keyboard"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></button>
        </div>

        <div class="table-wrap">
            <table id="claims-table">
                <thead><tr><th>Claim No</th><th>Status</th><th>R/O No</th><th>Type</th><th>Causal Part</th><th>Part Desc</th><th>Prod Date</th><th>Amount</th><th>Findings</th><th>Remarks</th></tr></thead>
                <tbody id="claims-tbody"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn" onclick="changePage(-1)" id="btn-prev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg> Previous</button>
            <span id="page-indicator" style="font-size: 0.85rem; color: var(--text-muted); font-weight: 700;">Page 1</span>
            <button class="btn" onclick="changePage(1)" id="btn-next">Next <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
    </div>

    <div id="screen-archive" class="screen">
        <div class="flex-between" style="margin-bottom: 12px;">
            <h3 id="archive-title" style="margin:0;">Archive</h3>
            <button class="btn" style="width: auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>

        <div class="legend-hint">
            <span><span class="legend-dot" style="background:#10b981;"></span> <b>Fin</b> = Finalized Audit</span>
            <span><span class="legend-dot" style="background:#f59e0b;"></span> <b>Drf</b> = Ongoing Draft</span>
        </div>

        <div class="table-wrap" style="margin-bottom: 20px;">
            <table>
                <thead><tr><th>Period</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="archive-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="screen-reports" class="screen">
        <div class="flex-between" style="margin-bottom: 12px; max-width: 440px; margin-left: auto; margin-right: auto; width: 100%;">
            <h3 style="margin:0;">Reports Export</h3>
            <button class="btn" style="width:auto; margin:0; padding: 8px 16px;" onclick="showScreen('screen-menu')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg> Main Menu</button>
        </div>
        <div class="card" style="max-width: 440px; margin: 0 auto; width: 100%;">
            <p style="margin-bottom:16px;">Export structured audit reports with amount summaries.</p>
            
            <label>Select Audit Scope</label>
            <div class="custom-select-wrapper" id="wrap-report-scope">
                <input type="hidden" id="report-scope" value="master">
                <div class="custom-select-trigger"><span class="trigger-text">Master Report (All Dates)</span> <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                <div class="custom-options" id="options-report-scope"></div>
            </div>
            
            <label>Filter Output</label>
            <div class="custom-select-wrapper" id="wrap-report-filter">
                <input type="hidden" id="report-filter" value="ALL">
                <div class="custom-select-trigger"><span class="trigger-text">All Claims</span> <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                <div class="custom-options">
                    <div class="custom-option selected" data-value="ALL">All Claims</div>
                    <div class="custom-option" data-value="CLEAR">Clear Claims Only</div>
                    <div class="custom-option" data-value="UNCLEAR">Unclear Claims Only</div>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 24px;">
                <button class="btn primary" style="margin:0;" onclick="executeExport('excel')"><svg style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:inline-block;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2.5M8 17h5M13 13l2 4 2-4"/></svg><span style="vertical-align:middle;">Export Excel</span></button>
                <button class="btn" style="margin:0; background-color:#ef4444; color:#ffffff; border-color:#ef4444;" onmouseover="this.style.backgroundColor='#dc2626';this.style.borderColor='#dc2626';" onmouseout="this.style.backgroundColor='#ef4444';this.style.borderColor='#ef4444';" onclick="executeExport('pdf')"><svg style="width:16px;height:16px;stroke:#ffffff;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:inline-block;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><rect x="8" y="13" width="4" height="4" rx="1"/><line x1="16" y1="13" x2="16" y2="17"/><line x1="14" y1="15" x2="18" y2="15"/></svg><span style="vertical-align:middle;">Export PDF</span></button>
            </div>
            <button class="btn" style="margin-top: 16px; display:none;"></button>
        </div>
    </div>

    <div id="audit-modal" class="modal-backdrop">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 id="modal-claim-no" style="margin:0; font-size: 1.25rem;">Claim No</h3>
                <p id="modal-part-subtitle" style="margin:4px 0 0 0; font-size:0.75rem; color:var(--text-muted); font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;"></p>
            </div>
            <div class="modal-body">
                <div id="modal-all-details" class="all-details-grid"></div>

                <label>Discrepancy Status</label>
                <div class="custom-select-wrapper" id="wrap-modal-disc">
                    <input type="hidden" id="modal-discrepancy" value="0">
                    <div class="custom-select-trigger"><span class="trigger-text">Part is Clean (None Found)</span> <svg style="width:16px;height:16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></div>
                    <div class="custom-options">
                        <div class="custom-option selected" data-value="0">Part is Clean (None Found)</div>
                        <div class="custom-option" data-value="1">Part is clean (Sent HMIL Suspense)</div>
                        <div class="custom-option" data-value="3">Part is Missing</div>
                        <div class="custom-option" data-value="4">Part Batch Code Mismatch</div>
                        <div class="custom-option" data-value="5">Part Not Tagged</div>
                        <div class="custom-option" data-value="6">Part Packing Missing</div>
                        <div class="custom-option" data-value="7">Related Part Missing to Causal or Affected Part Missing</div>
                        <div class="custom-option" data-value="8">Part is Not Defective</div>
                        <div class="custom-option" data-value="9">Part is Damaged</div>
                    </div>
                </div>

                <div id="modal-extra-inputs" style="display: none; animation: slideFadeUp 0.2s ease;">
                    <label id="modal-extra-label">Additional Details</label>
                    <input type="text" id="modal-extra-text" class="input" placeholder="...">
                </div>

                <div id="modal-suspense-box" style="display:none; animation: slideFadeUp 0.2s ease; margin-bottom: 16px; padding: 16px; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px;">
                    <label style="color: var(--danger); font-weight: 700; margin-bottom: 12px;">Suspense(P) — Send to Technical Centre</label>
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 0.75rem; margin-bottom: 8px;">Part Sent Status</label>
                        <div class="grid-2" style="gap: 8px;">
                            <button type="button" class="btn" id="suspense-done-btn" onclick="selectSuspenseStatus('done')" style="margin: 0; min-height: 48px; font-size: 0.9rem;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Done</button>
                            <button type="button" class="btn" id="suspense-no-btn" onclick="selectSuspenseStatus('no')" style="margin: 0; min-height: 48px; font-size: 0.9rem;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Not Yet</button>
                        </div>
                    </div>
                    <div id="suspense-pod-box" style="display: none;">
                        <label style="font-size: 0.75rem;">POD Number (Optional)</label>
                        <input type="text" id="suspense-pod" class="input" placeholder="Enter POD number..." style="margin-bottom: 0;">
                    </div>
                </div>

                <div id="modal-remark-box" style="display:block; animation: slideFadeUp 0.2s ease;">
                    <label>Optional Remark</label>
                    <input type="text" id="modal-remark" class="input" placeholder="Add a remark (optional)...">
                </div>

                <div class="grid-2" style="margin-top: 24px;">
                    <button class="btn primary" style="margin:0;" onclick="saveClaimAudit()">Save Entry</button>
                    <button class="btn" style="margin:0;" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- PERSISTENT THEME & ICONS ---
    function applyTheme(theme) {
        if(theme === 'dark') document.body.setAttribute('data-theme', 'dark');
        else document.body.removeAttribute('data-theme');
    }
    let savedTheme = localStorage.getItem('auditor_theme') || 'light';
    applyTheme(savedTheme);

    function toggleTheme() {
        savedTheme = savedTheme === 'dark' ? 'light' : 'dark';
        applyTheme(savedTheme); localStorage.setItem('auditor_theme', savedTheme);
    }

    // --- AMOUNT HELPERS ---
    function parseAmt(val) { const cleaned = String(val).replace(/[^\d.-]/g, ''); const v = parseFloat(cleaned); return isNaN(v) ? 0 : v; }
    function fmtAmt(val) { const num = Math.round(parseAmt(val)); return '₹' + num.toLocaleString('en-IN'); }
    function pdfAmt(val) { const num = Math.round(parseAmt(val)); return 'Rs. ' + num.toLocaleString('en-IN'); }

    // --- KEYBOARD TOGGLE HELPER ---
    function toggleKeyboardMode(inputId, btn) {
        const input = document.getElementById(inputId);
        if(input.inputMode === 'numeric') { input.inputMode = 'text'; btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>`; btn.style.background = 'var(--surface)'; } 
        else { input.inputMode = 'numeric'; btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>`; btn.style.background = 'var(--bg-base)'; }
        input.focus();
    }

    // --- CUSTOM DROPDOWN ENGINE ---
    document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.custom-select-trigger');
        if (trigger) {
            e.stopPropagation();
            const wrapper = trigger.closest('.custom-select-wrapper');
            document.querySelectorAll('.custom-select-wrapper').forEach(w => { 
                if(w !== wrapper) w.classList.remove('open'); 
            });
            wrapper.classList.toggle('open');
            return;
        }

        const option = e.target.closest('.custom-option');
        if (option) {
            e.stopPropagation();
            const wrapper = option.closest('.custom-select-wrapper');
            const hiddenInput = wrapper.querySelector('input[type="hidden"]');
            const textDisplay = wrapper.querySelector('.trigger-text');
            
            wrapper.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            const val = option.getAttribute('data-value');
            hiddenInput.value = val; 
            textDisplay.innerText = option.innerText; 
            wrapper.classList.remove('open');
            
            if(hiddenInput.id === 'modal-discrepancy') handleDiscrepancyChange(val);
            if(hiddenInput.id === 'dash-scope') loadDashboardMonth(val);
            return;
        }

        document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
    });

    function setCustomSelectValue(wrapperId, val) {
        const wrapper = document.getElementById(wrapperId);
        if (!wrapper) return;
        const options = wrapper.querySelectorAll('.custom-option');
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        const textDisplay = wrapper.querySelector('.trigger-text');
        
        options.forEach(o => {
            o.classList.remove('selected');
            if(String(o.getAttribute('data-value')) === String(val)) {
                o.classList.add('selected'); 
                hiddenInput.value = val; 
                textDisplay.innerText = o.innerText;
            }
        });

        if (wrapperId === 'wrap-modal-disc') handleDiscrepancyChange(val);
    }

    function handleDiscrepancyChange(val) {
        const extraBox = document.getElementById('modal-extra-inputs'); const label = document.getElementById('modal-extra-label'); const input = document.getElementById('modal-extra-text');
        const remarkBox = document.getElementById('modal-remark-box');
        if(val === '1') { extraBox.style.display = 'block'; label.innerText = "POD Number (Optional)"; input.placeholder = "Enter POD..."; }
        else if(val === '7') { extraBox.style.display = 'block'; label.innerText = "Missing Part Name (Required)"; input.placeholder = "Enter Part..."; }
        else { extraBox.style.display = 'none'; input.value = ''; }
        // Show optional remark for all non-clean statuses
        const isClean = (val === '0' || (DISCREPANCY_TYPES[val] && (DISCREPANCY_TYPES[val].includes('None Found') || DISCREPANCY_TYPES[val].includes('[CLN]'))));
        if(remarkBox) remarkBox.style.display = 'block';
    }

    function handleFileSelect(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        
        const cardId = type + '-file-card';
        const cardElement = document.getElementById(cardId);
        const fileSize = (file.size / 1024).toFixed(2) + ' KB';
        if (file.size > 1024 * 1024) fileSize = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
        
        cardElement.innerHTML = `
            <div class="file-card">
                <div class="file-card-icon">
                    <svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                </div>
                <div class="file-card-info">
                    <div class="file-card-name">${file.name}</div>
                    <div class="file-card-size">${fileSize}</div>
                </div>
                <div class="file-card-remove" onclick="clearFileSelect('${type}')">
                    <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
        `;
        cardElement.style.display = 'block';
    }
    
    function clearFileSelect(type) {
        const inputId = type + '-file';
        const cardId = type + '-file-card';
        document.getElementById(inputId).value = '';
        document.getElementById(cardId).style.display = 'none';
        document.getElementById(cardId).innerHTML = '';
    }

    function highlightError(el) {
        if (!el) return;
        const originalBorder = el.style.borderColor;
        const originalBoxShadow = el.style.boxShadow;
        el.style.transition = 'all 0.3s ease';
        el.style.borderColor = 'var(--danger)';
        el.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';
        
        setTimeout(() => {
            el.style.borderColor = originalBorder;
            el.style.boxShadow = originalBoxShadow;
        }, 3000);
    }

    // --- SMART KEYBOARD & DIALOG ENGINE ---
    function closeDialog() { document.getElementById('app-dialog').classList.remove('active'); const di=document.getElementById('dialog-input'); di.value=''; di.style.cssText='text-align:center; letter-spacing:4px; font-size:1.2rem; margin:0; padding-right:44px; -webkit-text-security:disc; text-security:disc;'; di.placeholder='••••••••'; di.setAttribute('inputmode', 'numeric'); }
    function showAppAlert(msg) { document.getElementById('dialog-msg').innerText = msg; document.getElementById('dialog-input-wrapper').style.display = 'none'; document.getElementById('dialog-btn-no').style.display = 'none'; document.getElementById('dialog-btn-yes').onclick = closeDialog; document.getElementById('app-dialog').classList.add('active'); }
    function showAppConfirm(msg, onYes) { document.getElementById('dialog-msg').innerText = msg; document.getElementById('dialog-input-wrapper').style.display = 'none'; document.getElementById('dialog-btn-no').style.display = 'block'; document.getElementById('dialog-btn-yes').onclick = () => { closeDialog(); if(onYes) onYes(); }; document.getElementById('dialog-btn-no').onclick = closeDialog; document.getElementById('app-dialog').classList.add('active'); }

    function showAppPrompt(msg, isPassword, onConfirm, disableCancel = false) {
        document.getElementById('dialog-msg').innerText = msg;
        const inputWrap = document.getElementById('dialog-input-wrapper'); const input = document.getElementById('dialog-input'); const kbBtn = document.getElementById('kb-toggle');
        
        input.type = 'text'; input.style.webkitTextSecurity = isPassword ? 'disc' : 'none'; input.style.textSecurity = isPassword ? 'disc' : 'none'; input.setAttribute('autocomplete', 'off'); input.setAttribute('data-lpignore', 'true'); input.setAttribute('data-form-type', 'other');
        input.inputMode = 'numeric'; kbBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>`; kbBtn.style.background = 'var(--bg-base)';
        input.placeholder = isPassword ? '••••••••' : '';
        
        inputWrap.style.display = 'block'; input.value = '';
        document.getElementById('dialog-btn-no').style.display = disableCancel ? 'none' : 'block';
        
        document.getElementById('dialog-btn-yes').onclick = () => { const val = input.value; if(val) { closeDialog(); if(onConfirm) onConfirm(val); } else { input.focus(); } };
        document.getElementById('dialog-btn-no').onclick = closeDialog; document.getElementById('app-dialog').classList.add('active');
        setTimeout(() => input.focus(), 150);
    }

    // --- UNIFIED SECURITY MODULE ---
    let secConfig = JSON.parse(localStorage.getItem('auditor_sec')) || { protectArchive: false, appLock: false, masterHash: '' };
    
    // Auto-migrate old disjointed passwords to Unified Master Password
    if (secConfig.appHash || secConfig.archiveHash) {
        secConfig.masterHash = secConfig.appHash || secConfig.archiveHash;
        delete secConfig.appHash; delete secConfig.archiveHash;
        localStorage.setItem('auditor_sec', JSON.stringify(secConfig));
    }

    async function sha256(message) { const msgBuffer = new TextEncoder().encode(message); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join(''); }

    function updateSecurityUI() {
        const appBtn = document.getElementById('btn-toggle-app-sec');
        if (appBtn) { if (secConfig.appLock) appBtn.classList.add('on'); else appBtn.classList.remove('on'); }

        const arcBtn = document.getElementById('btn-toggle-arc-sec');
        if (arcBtn) { if (secConfig.protectArchive) arcBtn.classList.add('on'); else arcBtn.classList.remove('on'); }
    }

    function verifyPasswordFlow(onSuccess) {
        if (!secConfig.masterHash) return onSuccess();
        showAppPrompt(`Enter Master Password / PIN:`, true, async (attempt) => {
            if (await sha256(attempt) === secConfig.masterHash) onSuccess(); else showAppAlert("Incorrect Password. Access Denied.");
        });
    }

    function toggleSecurity(type) {
        const isApp = type === 'app'; const isProtected = isApp ? secConfig.appLock : secConfig.protectArchive;
        
        if (isProtected) {
            verifyPasswordFlow(() => {
                if(isApp) secConfig.appLock = false; else secConfig.protectArchive = false;
                if(!secConfig.appLock && !secConfig.protectArchive) secConfig.masterHash = '';
                localStorage.setItem('auditor_sec', JSON.stringify(secConfig)); updateSecurityUI(); showAppAlert("Protection Disabled.");
            });
        } else {
            if (!secConfig.masterHash) {
                showAppPrompt(`Create Master Password for App & Archive:`, true, (p1) => {
                    showAppPrompt("Confirm Master Password:", true, async (p2) => {
                        if (p1 !== p2) return showAppAlert("Passwords do not match. Aborted.");
                        secConfig.masterHash = await sha256(p1);
                        if(isApp) secConfig.appLock = true; else secConfig.protectArchive = true;
                        localStorage.setItem('auditor_sec', JSON.stringify(secConfig)); updateSecurityUI(); showAppAlert("Protection Enabled.");
                    });
                });
            } else {
                verifyPasswordFlow(() => {
                    if(isApp) secConfig.appLock = true; else secConfig.protectArchive = true;
                    localStorage.setItem('auditor_sec', JSON.stringify(secConfig)); updateSecurityUI(); showAppAlert("Protection Enabled.");
                });
            }
        }
    }

    async function initApp() {
    const savedIndex = await localforage.getItem('db_index');
    if(savedIndex) dbIndex = savedIndex;
    if (secConfig.appLock) {
        const enforceAppLock = () => {
            showAppPrompt("Warranty Auditor is locked. Enter your password to continue:", true, async (attempt) => {
                if (await sha256(attempt) === secConfig.masterHash) { 
                    document.getElementById('screen-menu').classList.add('active'); 
                    loadDashboardNotifications(); 
                } else { 
                    showAppAlert("Incorrect Password."); 
                    setTimeout(enforceAppLock, 500); 
                }
            }, true);
        }; 
        enforceAppLock();
    } else { 
        document.getElementById('screen-menu').classList.add('active'); 
        setTimeout(loadDashboardNotifications, 200); 
    }
    updateSecurityUI();
}

window.addEventListener('DOMContentLoaded', () => {
    initApp();
});

    // --- BACKUP AND RESTORE ---
    async function backupDatabase() {
        showLoader(true);
        try {
            let backupObj = {}; const keys = await localforage.keys();
            for (let k of keys) { backupObj[k] = await localforage.getItem(k); }
            backupObj['_secConfig'] = localStorage.getItem('auditor_sec') || "{}";
            backupObj['_autosync'] = localStorage.getItem('gist_autosync') || 'false';
            backupObj['_theme'] = localStorage.getItem('auditor_theme') || 'light';
            backupObj['_customCodes'] = localStorage.getItem('auditor_custom_codes') || '{}';
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupObj));
            const dlAnchorElem = document.createElement('a'); dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", `WarrantyAuditor_Backup_${new Date().toISOString().split('T')[0]}.json`);
            dlAnchorElem.click(); showAppAlert("Backup downloaded successfully.");
        } catch (e) { showAppAlert("Backup failed: " + e.message); }
        showLoader(false);
    }
    function restoreDatabase(event) {
        const file = event.target.files[0]; if (!file) return;
        showAppConfirm("WARNING: Restoring will overwrite all existing data.\n\nAre you sure?", () => {
            showLoader(true); const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result); await localforage.clear();
                    for (let key in data) { if (key === '_secConfig') { localStorage.setItem('auditor_sec', data[key]); } else if (key === '_autosync') { localStorage.setItem('gist_autosync', data[key]); } else if (key === '_theme') { localStorage.setItem('auditor_theme', data[key]); applyTheme(data[key]); } else if (key === '_customCodes') { localStorage.setItem('auditor_custom_codes', data[key]); } else { await localforage.setItem(key, data[key]); } }
                    showLoader(false); showAppAlert("Database Restored Successfully! App will reload."); setTimeout(() => window.location.reload(), 2000);
                } catch(err) { showLoader(false); showAppAlert("Restore failed. Invalid backup."); document.getElementById('restore-file').value = ''; }
            }; reader.readAsText(file);
        });
    }

    // --- STATE & GLOBAL UTILS ---
    localforage.config({ name: 'AutoPuncherDB', storeName: 'audits' });
    let dbIndex = {}; let currentSessionKey = null; let currentData = []; let currentFilteredData = []; let currentAuditData = {}; let colMap = {};
    let _isNewSession = false; // true = brand new audit, false = resumed draft
    let _sessionSnapshot = null; // deep copy of audit_data at the moment session was opened
    let currentPage = 1; const pageSize = 50; let activeClaimRowIndex = null; 

    // Read Only Dashboard State
    let dashCurrentData = []; let dashFilteredData = []; let dashAuditData = {}; let dashColMap = {}; let dashCurrentPage = 1;
    let dashCurrentFilter = 'all'; 
    
    // Active Workspace State
    let workspaceCurrentFilter = 'all';

    const DEFAULT_DISCREPANCIES = { "0": "None Found", "1": "Part is clean (Sent HMIL Suspense)", "3": "Part is Missing", "4": "Part Batch Code Mismatch", "5": "Part Not Tagged", "6": "Part Packing Missing", "7": "Related Part Missing to Causal or Affected Part Missing", "8": "Part is Not Defective", "9": "Part is Damaged", "10": "Issue part casual issue. Else Fine [CLN]", "11": "Labour Only Claim [CLN]" };
    let DISCREPANCY_TYPES = JSON.parse(localStorage.getItem('auditor_custom_codes')) || DEFAULT_DISCREPANCIES;

    function isClaimClean(findings) { if (!findings || findings.length === 0) return true; return findings[0].includes("None Found") || findings[0].includes("Sent HMIL Suspense") || findings[0].includes("[CLN]"); }

    localforage.getItem('db_index').then(val => { if(val) dbIndex = val; });

    async function saveSessionToDB(sessionData) { dbIndex[currentSessionKey] = { month: sessionData.month, year: sessionData.year, finalized: sessionData.finalized || false, last_saved: sessionData.last_saved, audit_remark: sessionData.audit_remark || '' }; await localforage.setItem('db_index', dbIndex); await localforage.setItem(currentSessionKey, sessionData); }      
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id === 'screen-menu') setTimeout(loadDashboardNotifications, 100); if(id === 'screen-new-audit') { const today = new Date(); const y = today.getFullYear(); const m = today.getMonth(); const firstDay = new Date(y, m, 1).toISOString().split('T')[0]; const lastDay = new Date(y, m + 1, 0).toISOString().split('T')[0]; const fromEl = document.getElementById('audit-from'); const toEl = document.getElementById('audit-to'); if(!fromEl.value) { fromEl.value = firstDay; setTimeout(() => setMonthPickerValue('mp-from', y, m), 0); } if(!toEl.value) { toEl.value = lastDay; setTimeout(() => setMonthPickerValue('mp-to', y, m), 0); } } }

    function detectColumns(headers) {
        const map = {}; 
        const lowerHeaders = headers.map(h => h.toString().toLowerCase().replace(/[\s_]/g, ''));
        const used = new Set(); // prevent two keys from grabbing same column
        const fuzzy = { "claim_no": ["claimno","claimnumber","clmno","clm#"], "ro_no": ["rono","r/ono","repairorderno","ronumber"], "claim_type": ["claimtype","clmtype","typeofclaim"], "causal_part": ["causalpart","causalpartno","causalpartnumber","causalpno"], "amount": ["totalamt","totalamount","claimamount","netamount","netamt","amount","amt"], "part_desc": ["partdesc","partdescription","partname","partsname","itemdesc","itemdescription","description"], "prod_date": ["pdctndate","proddate","productiondate","mfgdate","manufacturedate","dateofmanufacture","prod.date","mfg.date","proddt","mfgdt","dateofmfg"], "status": ["status","claimstatus","clmstatus","state"] };
        for (const [key, terms] of Object.entries(fuzzy)) { 
            const idx = lowerHeaders.findIndex((h, i) => !used.has(i) && terms.some(t => h.includes(t))); 
            if (idx !== -1) { map[key] = headers[idx]; used.add(idx); } 
        } 
        return map;
    }

    // --- READ-ONLY DASHBOARD ENGINE ---
    async function loadDashboardNotifications() {
        let tunclear = 0; let tpending = 0; let pendingDrafts = 0;
        let tsuspense = 0; // Track urgent Suspense(P) items
        let actionMonths = [];
        let suspenseMonths = [];
        
        for (const key of Object.keys(dbIndex)) {
            if (dbIndex[key].finalized) { 
                const session = await localforage.getItem(key);
                if(session && session.raw_data) {
                    let aud = 0; let clr = 0; let susp = 0;
                    session.raw_data.forEach(row => { 
                        const entry = session.audit_data[row[session.col_map.claim_no]]; 
                        if(entry && entry.audited) { 
                            aud++; 
                            if(isClaimClean(entry.findings)) clr++; 
                            // Count urgent suspense items
                            if(entry.suspense_pending && entry.suspense_sent === 'no') {
                                susp++;
                            }
                        } 
                    });
                    const p = session.raw_data.length - aud; const u = aud - clr; 
                    if(p > 0 || u > 0) { 
                        tunclear += u; tpending += p; 
                        if (!actionMonths.includes(dbIndex[key].month)) {
                            actionMonths.push(dbIndex[key].month);
                        }
                    }
                    if(susp > 0) {
                        tsuspense += susp;
                        if (!suspenseMonths.includes(dbIndex[key].month)) {
                            suspenseMonths.push(dbIndex[key].month);
                        }
                    }
                }
            } else {
                pendingDrafts++;
            }
        }
        
        const banner = document.getElementById('main-notification');
        const suspenseBanner = document.getElementById('suspense-notification');
        
        // Show Suspense(P) urgent notification
        if (tsuspense > 0) {
            const suspenseMonthsStr = suspenseMonths.join(', ');
            document.getElementById('suspense-notif-text').innerHTML = `<strong style="font-size:1rem; display:block; margin-bottom:4px; color:var(--danger);">Suspense(P) — Action Required</strong> <span style="color:var(--text-muted);">You have <b>${tsuspense}</b> Suspense(P) part(s) not yet sent to Technical Centre in <b>${suspenseMonthsStr}</b>. Click to view.</span>`; 
            suspenseBanner.style.display = 'flex';
        } else {
            suspenseBanner.style.display = 'none';
        }
        
        if (tunclear > 0 || tpending > 0) { 
            const monthsStr = actionMonths.join(', ');
            // HTML use kiya taaki title bold ho aur clear dikhe
            document.getElementById('notif-text').innerHTML = `<strong style="font-size:1rem; display:block; margin-bottom:4px; color:var(--danger);">Action Required</strong> <span style="color:var(--text-muted);">You have ${tunclear} Unclear & ${tpending} Pending claims in <b>${monthsStr}</b>. Click to view.</span>`; 
            banner.className = 'notification-banner alert-mode';
            banner.style.display = 'flex'; 
        } else if (pendingDrafts > 0) {
            document.getElementById('notif-text').innerHTML = `<strong style="font-size:1rem; display:block; margin-bottom:4px; color:var(--accent);">Draft Pending</strong> <span style="color:var(--text-muted);">You have ${pendingDrafts} Draft session(s) pending completion. Click to view.</span>`; 
            banner.className = 'notification-banner info-mode';
            banner.style.display = 'flex';
        } else { 
            banner.style.display = 'none'; 
        }
    }

    function buildDashboard() {
        const optContainer = document.getElementById('options-dash-scope'); optContainer.innerHTML = '';
        const keys = Object.keys(dbIndex);
        if(keys.length === 0) return showAppAlert("No audits saved. Please create an audit first.");
        
        optContainer.innerHTML = '<div class="custom-option" data-value="__all__">All Months Combined</div>';
        keys.forEach(k => { optContainer.innerHTML += `<div class="custom-option" data-value="${k}">${dbIndex[k].month} ${dbIndex[k].finalized ? '(Finalized)' : '(Draft)'}</div>`; });
        
        showScreen('screen-dashboard');

        // Restore last session selection if available
        const lastKey = sessionStorage.getItem('dash_last_key');
        const lastFilter = sessionStorage.getItem('dash_last_filter') || 'all';
        if (lastKey && (lastKey === '__all__' || dbIndex[lastKey])) {
            // Restore the dropdown display
            const matchOpt = optContainer.querySelector(`[data-value="${lastKey}"]`);
            if (matchOpt) {
                document.getElementById('dash-scope').value = lastKey;
                document.getElementById('wrap-dash-scope').querySelector('.trigger-text').innerText = matchOpt.innerText;
                matchOpt.classList.add('selected');
            }
            loadDashboardMonth(lastKey).then(() => {
                if (lastFilter !== 'all') setDashFilter(lastFilter);
            });
        } else {
            document.getElementById('dash-content-area').style.display = 'none';
            document.getElementById('dash-scope').value = ""; 
            document.getElementById('wrap-dash-scope').querySelector('.trigger-text').innerText = "Select an Audit to View...";
        }
    }

    async function loadDashboardMonth(sessionKey) {
        if(!sessionKey) return;
        sessionStorage.setItem('dash_last_key', sessionKey);
        showLoader(true);

        if(sessionKey === '__all__') {
            // Merge all sessions
            dashCurrentData = []; dashAuditData = {}; dashColMap = null; dashCurrentPage = 1;
            const keys = Object.keys(dbIndex);
            for(const k of keys) {
                const s = await localforage.getItem(k);
                if(!s || !s.raw_data) continue;
                if(!dashColMap) dashColMap = s.col_map;
                dashCurrentData = dashCurrentData.concat(s.raw_data);
                Object.assign(dashAuditData, s.audit_data);
            }
            if(dashCurrentData.length === 0) { showLoader(false); return showAppAlert("No data found."); }
            document.getElementById('dash-search').value = '';
        } else {
            const session = await localforage.getItem(sessionKey);
            if(!session || !session.raw_data) { showLoader(false); return showAppAlert("Error loading audit data."); }
            dashCurrentData = session.raw_data; dashAuditData = session.audit_data; dashColMap = session.col_map; dashCurrentPage = 1;
            document.getElementById('dash-search').value = '';
        }

        let aud = 0; let clr = 0; let suspenseUrgent = 0;
        let amtAudited = 0, amtUnclear = 0, amtPending = 0;

        dashCurrentData.forEach(row => { 
            const entry = dashAuditData[row[dashColMap.claim_no]]; 
            const amt = parseAmt(row[dashColMap.amount]);
            
            if(entry && entry.audited) { 
                aud++; 
                amtAudited += amt;
                if(isClaimClean(entry.findings)) { clr++; } else { amtUnclear += amt; }
                // Count urgent suspense items
                if(entry.suspense_pending && entry.suspense_sent === 'no') {
                    suspenseUrgent++;
                }
            } else {
                amtPending += amt;
            }
        });
        
        // Update dashboard suspense notification
        const dashSuspenseNotif = document.getElementById('dash-suspense-notif');
        if (suspenseUrgent > 0) {
            document.getElementById('dash-suspense-text').innerHTML = `<strong style="font-weight:700;">Action Required:</strong> ${suspenseUrgent} Suspense(P) part${suspenseUrgent > 1 ? 's' : ''} need${suspenseUrgent === 1 ? 's' : ''} to be sent to Technical Centre immediately!`;
            dashSuspenseNotif.style.display = 'flex';
        } else {
            dashSuspenseNotif.style.display = 'none';
        }
        
        document.getElementById('dash-total').innerText = dashCurrentData.length; document.getElementById('dash-clean').innerText = clr;
        document.getElementById('dash-unclear').innerText = aud - clr; document.getElementById('dash-pending').innerText = dashCurrentData.length - aud;

        document.getElementById('dash-amount-stats').innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <div class="stat-card" style="border-top: 2px solid var(--accent); padding: 12px; min-width: 0; cursor:pointer;" onclick="setDashFilter('all')" title="Show All Claims">
                    <div class="stat-value" style="font-size:1.1rem; margin-bottom:2px;">${fmtAmt(amtAudited)}</div><div class="stat-label" style="font-size:0.65rem;">Total Claim Amount Audited</div>
                </div>
                <div class="stat-card" style="border-top: 2px solid var(--warning); padding: 12px; min-width: 0; cursor:pointer;" onclick="setDashFilter('unclear')" title="Show Unclear Claims">
                    <div class="stat-value" style="font-size:1.1rem; color:var(--warning); margin-bottom:2px;">${fmtAmt(amtUnclear)}</div><div class="stat-label" style="font-size:0.65rem;">Total Claim Amount Unclear</div>
                </div>
                <div class="stat-card" style="border-top: 2px solid var(--text-muted); padding: 12px; min-width: 0; cursor:pointer;" onclick="setDashFilter('pending')" title="Show Pending Claims">
                    <div class="stat-value" style="font-size:1.1rem; margin-bottom:2px;">${fmtAmt(amtPending)}</div><div class="stat-label" style="font-size:0.65rem;">Total Claim Amount Pending</div>
                </div>
            </div>
        `;

        setDashFilter('all'); 
        document.getElementById('dash-content-area').style.display = 'block'; showLoader(false);
    }

    function setDashFilter(filterType) {
        dashCurrentFilter = filterType;
        sessionStorage.setItem('dash_last_filter', filterType);
        document.querySelectorAll('#dash-content-area .stat-card.active-filter').forEach(c => c.classList.remove('active-filter'));
        const btn = document.getElementById('dash-card-' + filterType);
        if(btn) btn.classList.add('active-filter');
        applyDashFilters();
    }

    function handleDashSearch() { applyDashFilters(); }

    let dashSortCol = -1; let dashSortAsc = true;
    function dashSortTable(colIdx) {
        if(dashSortCol === colIdx) { dashSortAsc = !dashSortAsc; } else { dashSortCol = colIdx; dashSortAsc = true; }
        const colKeys = [dashColMap.claim_no, null, dashColMap.ro_no, dashColMap.claim_type, dashColMap.causal_part, dashColMap.part_desc, dashColMap.prod_date, dashColMap.amount];
        
        dashFilteredData.sort((a, b) => {
            let va, vb;
            if(colIdx === 1) { // Status
                const ea = dashAuditData[a[dashColMap.claim_no]] || {}; const eb = dashAuditData[b[dashColMap.claim_no]] || {};
                const statusOrder = s => { if(s.audited && isClaimClean(s.findings)) return 1; if(s.audited) return 2; return 3; };
                va = statusOrder(ea); vb = statusOrder(eb);
            } else {
                const key = colKeys[colIdx]; if(!key) return 0;
                va = a[key] || ''; vb = b[key] || '';
                if(colIdx === 7) { va = parseFloat(va)||0; vb = parseFloat(vb)||0; }
            }
            if(va < vb) return dashSortAsc ? -1 : 1;
            if(va > vb) return dashSortAsc ? 1 : -1;
            return 0;
        });
        dashCurrentPage = 1;
        renderDashTable();
    }

    function applyDashFilters() {
        const q = document.getElementById('dash-search').value.toUpperCase();
        dashFilteredData = dashCurrentData.filter(row => {
            const claimNo = row[dashColMap.claim_no];
            const matchesSearch = !q || String(claimNo).toUpperCase().includes(q);
            if (!matchesSearch) return false;

            const entry = dashAuditData[claimNo] || {};
            const isClear = entry.audited && isClaimClean(entry.findings);
            const isAudited = entry.audited;

            if (dashCurrentFilter === 'clean') return isClear;
            if (dashCurrentFilter === 'unclear') return isAudited && !isClear;
            if (dashCurrentFilter === 'pending') return !isAudited;
            return true;
        });
        dashCurrentPage = 1;
        renderDashTable();
    }

    function changeDashPage(dir) { const maxPage = Math.ceil(dashFilteredData.length / pageSize) || 1; dashCurrentPage = Math.max(1, Math.min(dashCurrentPage + dir, maxPage)); renderDashTable(); }

    function renderDashTable() {
        const tbody = document.getElementById('dash-tbody'); tbody.innerHTML = '';
        const start = (dashCurrentPage - 1) * pageSize; const pageData = dashFilteredData.slice(start, start + pageSize); const frag = document.createDocumentFragment();
        
        pageData.forEach(row => {
            const claimNo = row[dashColMap.claim_no]; const entry = dashAuditData[claimNo] || {}; const isClear = entry.audited && isClaimClean(entry.findings);
            const isSuspensePending = entry.suspense_pending && entry.suspense_sent === 'no';
            let statusHtml = '<span class="status-pending">Pen</span>'; 
            if (isClear) statusHtml = '<span class="status-clear">Cln</span>'; 
            else if (entry.audited) statusHtml = `<span class="status-unclear">Unc</span>`;
            
            // Add urgent flag for suspense pending
            if (isSuspensePending) statusHtml += ' <span style="background:var(--danger); color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:700; margin-left:4px;">URGENT</span>';
            
            const tr = document.createElement('tr');
            // Highlight entire row if suspense pending
            if (isSuspensePending) tr.style.background = 'rgba(239, 68, 68, 0.08)';
            
            const dTooltip = [
                entry.audited ? (isClear ? 'Clean' : 'Unclear') : 'Pending',
                row[dashColMap.amount] ? fmtAmt(row[dashColMap.amount]) : '',
                entry.findings && entry.findings[0] ? entry.findings[0].split(' [')[0].split(' (')[0] : ''
            ].filter(Boolean).join(' · ');
            tr.innerHTML = `<td>${claimNo}</td><td>${statusHtml}</td><td>${row[dashColMap.ro_no] || '-'}</td><td>${row[dashColMap.claim_type] || '-'}</td><td>${row[dashColMap.causal_part] || '-'}</td><td style="color:var(--text-muted); max-width:100px; overflow:hidden; text-overflow:ellipsis;">${row[dashColMap.part_desc] || '-'}</td><td style="white-space:nowrap;">${row[dashColMap.prod_date] || '-'}</td><td>${row[dashColMap.amount] || '-'}</td><td style="color:var(--text-muted);">${(entry.findings||[]).join('; ')}</td><td style="color:var(--accent); font-style:italic; max-width:120px; overflow:hidden; text-overflow:ellipsis;">${entry.optional_remark || '-'}</td><td style="position:relative;padding:0;width:0;border:none;"><span class="row-tooltip">${dTooltip}</span></td>`;
            frag.appendChild(tr);
        }); tbody.appendChild(frag);

        const maxPage = Math.ceil(dashFilteredData.length / pageSize) || 1; document.getElementById('dash-page-indicator').innerText = `${dashCurrentPage} / ${maxPage}`;
        document.getElementById('dash-btn-prev').disabled = dashCurrentPage === 1; document.getElementById('dash-btn-next').disabled = dashCurrentPage === maxPage;
    }


    // --- WORKSPACE CREATION ---
    function startNewAudit() {
        const fileInput = document.getElementById('audit-file'); const fromDate = document.getElementById('audit-from'); const toDate = document.getElementById('audit-to');
        
        let hasError = false;
        if (!fromDate.value) { highlightError(document.querySelector('#mp-from .mp-display')); hasError = true; }
        if (!toDate.value) { highlightError(document.querySelector('#mp-to .mp-display')); hasError = true; }
        if (!fileInput.files.length) { highlightError(fileInput); hasError = true; }
        
        if (hasError) return showAppAlert("Please fill in all highlighted fields.");

        showLoader(true); 
        
        // Month Year formatting
        const formatMonthYear = d => { const dt = new Date(d); return dt.toLocaleDateString('en-GB', {month:'short'}) + ' ' + dt.getFullYear(); };
        const fromStr = formatMonthYear(fromDate.value); const toStr = formatMonthYear(toDate.value);
        const periodString = fromStr === toStr ? fromStr : fromStr + ' – ' + toStr;
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'});
                let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});
                if(jsonData.length === 0) throw new Error("File empty.");
                colMap = detectColumns(Object.keys(jsonData[0])); if(!colMap.claim_no) throw new Error("Could not detect Claim No column.");

                currentData = jsonData.filter(row => {
                    const type = String(row[colMap.claim_type] || "").toUpperCase(); const amt = parseFloat(row[colMap.amount]) || 0; const desc = String(row[colMap.part_desc] || "").toUpperCase();
                    if (type.includes("FREE SERVICE") || type.includes("FSC")) return false;
                    if (type.includes("CAMPAIGN") && amt < 300 && !desc.includes("POWER WINDOW") && !desc.includes("FUEL PUMP")) return false;
                    return true;
                });
                currentSessionKey = `audit_${fromDate.value}_${toDate.value}_${Date.now()}`; currentAuditData = {}; workspaceCurrentFilter = 'all'; currentFilteredData = [...currentData]; currentPage = 1; _isNewSession = true; _sessionSnapshot = null;
                await saveSessionToDB({ month: periodString, year: '', last_saved: new Date().toLocaleString(), finalized: false, col_map: colMap, audit_data: currentAuditData, raw_data: currentData });
                document.getElementById('workspace-title').innerText = periodString; showScreen('screen-workspace'); updateStats(); renderTablePage();
            } catch(err) { showAppAlert(err.message); } finally { showLoader(false); }
        }; setTimeout(() => reader.readAsArrayBuffer(fileInput.files[0]), 50);
    }

    // --- WORKSPACE ACTIVE STATE & FILTERS ---
    function requestExitWorkspace() { showAppConfirm("Return to menu?\nYour progress is safely auto-saved as a Draft.", () => { showScreen('screen-menu'); }); }

    async function discardWorkspace() {
        const msg = _isNewSession
            ? "Discard this new audit?\n\nAre you sure? This session will be deleted completely."
            : "Discard changes from this session?\n\nAre you sure? All edits made since you opened this draft will be reverted to the state it was in before you resumed it.";

        showAppConfirm(msg, async () => {
            showLoader(true);
            if (_isNewSession) {
                // Brand new — delete entirely
                await localforage.removeItem(currentSessionKey);
                delete dbIndex[currentSessionKey];
                await localforage.setItem('db_index', dbIndex);
                currentData = []; currentAuditData = {}; currentSessionKey = null;
            } else {
                // Resumed draft — restore the snapshot taken at load time, write it back to DB
                const session = await localforage.getItem(currentSessionKey);
                if (session && _sessionSnapshot !== null) {
                    session.audit_data = _sessionSnapshot;
                    session.last_saved = new Date().toLocaleString();
                    await localforage.setItem(currentSessionKey, session);
                }
            }
            showLoader(false);
            showScreen('screen-menu');
        });
    }
    function handleSearch() { applyWorkspaceFilters(); }
    function changePage(dir) { const maxPage = Math.ceil(currentFilteredData.length / pageSize) || 1; currentPage = Math.max(1, Math.min(currentPage + dir, maxPage)); renderTablePage(); }

    function setWorkspaceFilter(filterType) {
        workspaceCurrentFilter = filterType;
        document.querySelectorAll('.ws-filter-btn').forEach(b => b.classList.remove('active-filter'));
        const btn = document.getElementById('ws-filter-' + filterType);
        if(btn) btn.classList.add('active-filter');
        applyWorkspaceFilters();
    }

    function applyWorkspaceFilters() {
        const q = document.getElementById('search-claim').value.toUpperCase();
        currentFilteredData = currentData.filter(row => {
            const claimNo = row[colMap.claim_no];
            const matchesSearch = !q || String(claimNo).toUpperCase().includes(q);
            if (!matchesSearch) return false;

            const entry = currentAuditData[claimNo] || {};
            const isClear = entry.audited && isClaimClean(entry.findings);
            const isAudited = entry.audited;

            if (workspaceCurrentFilter === 'clean') return isClear;
            if (workspaceCurrentFilter === 'unclear') return isAudited && !isClear;
            if (workspaceCurrentFilter === 'pending') return !isAudited;
            return true;
        });
        currentPage = 1;
        renderTablePage();
    }

    function updateStats() {
        let audited = 0; let clear = 0; let suspenseUrgent = 0;
        let amtAudited = 0, amtUnclear = 0, amtPending = 0;

        currentData.forEach(row => { 
            const entry = currentAuditData[row[colMap.claim_no]]; 
            const amt = parseAmt(row[colMap.amount]);
            
            if(entry && entry.audited) { 
                audited++; 
                amtAudited += amt;
                if(isClaimClean(entry.findings)) { clear++; } else { amtUnclear += amt; }
                // Count urgent suspense items
                if(entry.suspense_pending && entry.suspense_sent === 'no') {
                    suspenseUrgent++;
                }
            } else {
                amtPending += amt;
            }
        });
        
        // Update suspense notification
        const suspenseNotif = document.getElementById('workspace-suspense-notif');
        if (suspenseUrgent > 0) {
            document.getElementById('workspace-suspense-text').innerHTML = `<strong style="font-weight:700;">Action Required:</strong> ${suspenseUrgent} Suspense(P) part${suspenseUrgent > 1 ? 's' : ''} need${suspenseUrgent === 1 ? 's' : ''} to be sent to Technical Centre immediately!`;
            suspenseNotif.style.display = 'flex';
        } else {
            suspenseNotif.style.display = 'none';
        }
        
        const html = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">
                <div class="stat-card claim-card ws-filter-btn ${workspaceCurrentFilter === 'all' ? 'active-filter' : ''}" id="ws-filter-all" onclick="setWorkspaceFilter('all')" style="border-top: 3px solid var(--accent); padding: 14px; cursor: pointer; min-width: 0;">
                    <div class="stat-value" style="font-size:1.5rem; margin-bottom:2px;">${currentData.length}</div><div class="stat-label" style="font-size:0.65rem;">Total Claims</div>
                </div>
                <div class="stat-card claim-card ws-filter-btn ${workspaceCurrentFilter === 'clean' ? 'active-filter' : ''}" id="ws-filter-clean" onclick="setWorkspaceFilter('clean')" style="border-top: 3px solid var(--success); padding: 14px; cursor: pointer; min-width: 0;">
                    <div class="stat-value" style="font-size:1.5rem; color:var(--success); margin-bottom:2px;">${clear}</div><div class="stat-label" style="font-size:0.65rem;">Claims Clean</div>
                </div>
                <div class="stat-card claim-card ws-filter-btn ${workspaceCurrentFilter === 'unclear' ? 'active-filter' : ''}" id="ws-filter-unclear" onclick="setWorkspaceFilter('unclear')" style="border-top: 3px solid var(--warning); padding: 14px; cursor: pointer; min-width: 0;">
                    <div class="stat-value" style="font-size:1.5rem; color:var(--warning); margin-bottom:2px;">${audited - clear}</div><div class="stat-label" style="font-size:0.65rem;">Claims Unclear</div>
                </div>
                <div class="stat-card claim-card ws-filter-btn ${workspaceCurrentFilter === 'pending' ? 'active-filter' : ''}" id="ws-filter-pending" onclick="setWorkspaceFilter('pending')" style="border-top: 3px solid var(--text-muted); padding: 14px; cursor: pointer; min-width: 0;">
                    <div class="stat-value" style="font-size:1.5rem; margin-bottom:2px;">${currentData.length - audited}</div><div class="stat-label" style="font-size:0.65rem;">Claims Pending</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <div class="stat-card" style="border-top: 2px solid var(--accent); padding: 12px; min-width: 0; cursor:pointer;" onclick="setWorkspaceFilter('all')" title="Show All Claims">
                    <div class="stat-value" style="font-size:1rem; margin-bottom:2px;">${fmtAmt(amtAudited)}</div><div class="stat-label" style="font-size:0.6rem;">Total Claim Amt Audited</div>
                </div>
                <div class="stat-card" style="border-top: 2px solid var(--warning); padding: 12px; min-width: 0; cursor:pointer;" onclick="setWorkspaceFilter('unclear')" title="Show Unclear Claims">
                    <div class="stat-value" style="font-size:1rem; color:var(--warning); margin-bottom:2px;">${fmtAmt(amtUnclear)}</div><div class="stat-label" style="font-size:0.6rem;">Total Claim Amt Unclear</div>
                </div>
                <div class="stat-card" style="border-top: 2px solid var(--text-muted); padding: 12px; min-width: 0; cursor:pointer;" onclick="setWorkspaceFilter('pending')" title="Show Pending Claims">
                    <div class="stat-value" style="font-size:1rem; margin-bottom:2px;">${fmtAmt(amtPending)}</div><div class="stat-label" style="font-size:0.6rem;">Total Claim Amt Pending</div>
                </div>
            </div>
        `;
        document.getElementById('workspace-stats').innerHTML = html;
    }

    function renderTablePage() {
        const tbody = document.getElementById('claims-tbody'); tbody.innerHTML = ''; const start = (currentPage - 1) * pageSize; const pageData = currentFilteredData.slice(start, start + pageSize); const frag = document.createDocumentFragment();
        pageData.forEach((row, i) => {
            const claimNo = row[colMap.claim_no]; const entry = currentAuditData[claimNo] || {}; const isClear = entry.audited && isClaimClean(entry.findings);
            const isSuspensePending = entry.suspense_pending && entry.suspense_sent === 'no';
            let statusHtml = '<span class="status-pending">Pen</span>'; 
            if (isClear) statusHtml = '<span class="status-clear">Cln</span>'; 
            else if (entry.audited) statusHtml = `<span class="status-unclear">Unc</span>`;
            
            // Add urgent flag for suspense pending
            if (isSuspensePending) statusHtml += ' <span style="background:var(--danger); color:white; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:700; margin-left:4px;">URGENT</span>';
            
            const tr = document.createElement('tr'); tr.onclick = () => openAuditModal(start + i);
            // Highlight entire row if suspense pending
            if (isSuspensePending) tr.style.background = 'rgba(239, 68, 68, 0.08)';
            
            const tooltipText = [
                entry.audited ? (isClear ? 'Clean' : 'Unclear') : 'Pending',
                row[colMap.amount] ? fmtAmt(row[colMap.amount]) : '',
                entry.findings && entry.findings[0] ? entry.findings[0].split(' [')[0].split(' (')[0] : ''
            ].filter(Boolean).join(' · ');
            tr.innerHTML = `<td>${claimNo}</td><td>${statusHtml}</td><td>${row[colMap.ro_no] || '-'}</td><td>${row[colMap.claim_type] || '-'}</td><td>${row[colMap.causal_part] || '-'}</td><td style="color:var(--text-muted); max-width:100px; overflow:hidden; text-overflow:ellipsis;">${row[colMap.part_desc] || '-'}</td><td style="white-space:nowrap;">${row[colMap.prod_date] || '-'}</td><td>${row[colMap.amount] || '-'}</td><td style="color:var(--text-muted);">${(entry.findings||[]).join('; ')}</td><td style="color:var(--accent); font-style:italic; max-width:120px; overflow:hidden; text-overflow:ellipsis;">${entry.optional_remark || '-'}</td><td style="position:relative;padding:0;width:0;border:none;"><span class="row-tooltip">${tooltipText}</span></td>`;
            frag.appendChild(tr);
        }); tbody.appendChild(frag);
        const maxPage = Math.ceil(currentFilteredData.length / pageSize) || 1; document.getElementById('page-indicator').innerText = `${currentPage} / ${maxPage}`;
        document.getElementById('btn-prev').disabled = currentPage === 1; document.getElementById('btn-next').disabled = currentPage === maxPage;
    }

    function selectSuspenseStatus(status) {
        const doneBtn = document.getElementById('suspense-done-btn');
        const noBtn = document.getElementById('suspense-no-btn');
        const podBox = document.getElementById('suspense-pod-box');
        
        // Reset button styles
        doneBtn.classList.remove('primary');
        noBtn.classList.remove('primary');
        
        // Highlight selected button
        if (status === 'done') {
            doneBtn.classList.add('primary');
            podBox.style.display = 'block';
        } else {
            noBtn.classList.add('primary');
            podBox.style.display = 'none';
        }
        
        // Store selection in a data attribute
        document.getElementById('modal-suspense-box').setAttribute('data-status', status);
    }

    function closeModal() {
        const modal = document.getElementById('audit-modal');
        modal.classList.remove('active');
        modal.classList.remove('side-panel');
        const r = document.getElementById('modal-remark'); if(r) r.value='';
        const rb = document.getElementById('modal-remark-box'); if(rb) rb.style.display='block';
        // If side panel was active, restore modal to body-level
        const wrapperEl = document.getElementById('wide-layout-wrapper');
        if (wrapperEl && modal.closest('#wide-layout-wrapper')) {
            document.body.appendChild(modal);
            wrapperEl.remove();
        }
    }

    function openAuditModal(filteredIndex) {
        activeClaimRowIndex = filteredIndex; const row = currentFilteredData[filteredIndex];
        const claimNo = row[colMap.claim_no]; document.getElementById('modal-claim-no').innerText = claimNo;
        const partDesc = colMap.part_desc ? (row[colMap.part_desc] || '') : ''; const partSubtitle = document.getElementById('modal-part-subtitle'); if(partSubtitle) partSubtitle.innerText = partDesc;
        
        const displayKeys = ["ro_no", "claim_type", "causal_part", "part_desc", "prod_date", "amount"]; let detailsHtml = '';
        displayKeys.forEach(k => { if(colMap[k]) { let val = row[colMap[k]] || "-"; let lbl = colMap[k].replace(/_/g, " "); detailsHtml += `<div class="detail-item"><span class="detail-lbl">${lbl}</span><span class="detail-val">${val}</span></div>`; } });
        document.getElementById('modal-all-details').innerHTML = detailsHtml;

        const entry = currentAuditData[claimNo];
        
        document.getElementById('modal-extra-inputs').style.display = 'none'; 
        document.getElementById('modal-extra-text').value = '';
        
        // --- 100% DIRECT UI UPDATE ---
        document.getElementById('modal-discrepancy').value = "0"; 
        const wrapper = document.getElementById('wrap-modal-disc');
        wrapper.querySelector('.trigger-text').innerText = "Part is Clean (None Found)";
        wrapper.querySelectorAll('.custom-option').forEach(o => {
            o.classList.remove('selected');
            if(o.getAttribute('data-value') === "0") o.classList.add('selected');
        });

        if(entry && entry.audited) {
            const f = entry.findings[0]; 
            for(let key in DISCREPANCY_TYPES) {
                if(f.includes(DISCREPANCY_TYPES[key])) {
                    document.getElementById('modal-discrepancy').value = key;
                    wrapper.querySelector('.trigger-text').innerText = DISCREPANCY_TYPES[key] === "None Found" ? "Part is Clean (None Found)" : DISCREPANCY_TYPES[key];
                    wrapper.querySelectorAll('.custom-option').forEach(o => {
                        o.classList.remove('selected');
                        if(o.getAttribute('data-value') === String(key)) o.classList.add('selected');
                    });

                    if(key === '1') { document.getElementById('modal-extra-inputs').style.display = 'block'; document.getElementById('modal-extra-label').innerText = "POD Number (Optional)"; document.getElementById('modal-extra-text').value = entry.pod_number || ''; }
                    if(key === '7') { document.getElementById('modal-extra-inputs').style.display = 'block'; document.getElementById('modal-extra-label').innerText = "Missing Part Name (Required)"; document.getElementById('modal-extra-text').value = entry.missing_part_name || ''; }
                    break;
                }
            }
        }
        // Load existing optional remark
        const remarkBox = document.getElementById('modal-remark-box');
        const remarkInput = document.getElementById('modal-remark');
        if(remarkBox && remarkInput) {
            remarkInput.value = (entry && entry.optional_remark) ? entry.optional_remark : '';
            const discVal = document.getElementById('modal-discrepancy').value;
            const isClean = (discVal === '0' || (DISCREPANCY_TYPES[discVal] && (DISCREPANCY_TYPES[discVal].includes('None Found') || DISCREPANCY_TYPES[discVal].includes('[CLN]'))));
            remarkBox.style.display = 'block';
        }
        
        // Handle Suspense(P) claims
        const suspenseBox = document.getElementById('modal-suspense-box');
        const suspensePodInput = document.getElementById('suspense-pod');
        const claimStatus = colMap.status ? String(row[colMap.status] || '').toUpperCase() : '';
        const isSuspense = claimStatus.includes('SUSPENSE') && claimStatus.includes('(P)');
        
        if (isSuspense) {
            suspenseBox.style.display = 'block';
            // Load existing suspense data if available
            if (entry && entry.suspense_sent) {
                selectSuspenseStatus(entry.suspense_sent);
                if (entry.suspense_pod) suspensePodInput.value = entry.suspense_pod;
            } else {
                // Reset to default
                document.getElementById('suspense-done-btn').classList.remove('primary');
                document.getElementById('suspense-no-btn').classList.remove('primary');
                document.getElementById('suspense-pod-box').style.display = 'none';
                suspensePodInput.value = '';
                suspenseBox.removeAttribute('data-status');
            }
        } else {
            suspenseBox.style.display = 'none';
        }
        
        // Scroll modal body to top on every open
        const modalBody = document.querySelector('#audit-modal .modal-body');
        if (modalBody) modalBody.scrollTop = 0;

        const modal = document.getElementById('audit-modal');
        if (window.innerWidth >= 1100) {
            // Wide screen: side panel mode
            modal.classList.add('side-panel');
            modal.classList.remove('active');
            // Ensure workspace uses wide layout
            const ws = document.getElementById('screen-workspace');
            if (!document.getElementById('wide-layout-wrapper')) {
                const tableWrap = ws.querySelector('.table-wrap');
                const pagi = ws.querySelector('.pagination');
                const wrapper = document.createElement('div');
                wrapper.id = 'wide-layout-wrapper';
                wrapper.className = 'wide-layout-wrapper';
                const left = document.createElement('div');
                left.className = 'wide-left';
                const right = document.createElement('div');
                right.className = 'wide-right';
                tableWrap.parentNode.insertBefore(wrapper, tableWrap);
                left.appendChild(tableWrap);
                left.appendChild(pagi);
                right.appendChild(modal);
                wrapper.appendChild(left);
                wrapper.appendChild(right);
                ws.appendChild(wrapper);
            }
        } else {
            modal.classList.remove('side-panel');
            modal.classList.add('active');
        }
    }

    async function saveClaimAudit() {
        const claimNo = currentFilteredData[activeClaimRowIndex][colMap.claim_no];
        
        const discCode = document.getElementById('modal-discrepancy').value || "0"; 
        const extraText = document.getElementById('modal-extra-text').value.trim();
        
        let finding = DISCREPANCY_TYPES[discCode]; 
        let entry = { audited: true, timestamp: new Date().toISOString() };

        if(discCode === '1') { 
            entry.pod_number = extraText; entry.remarks = "Sent to Hmil Suspense (P)"; entry.courier_provider = "Track-On Couriers"; finding += extraText ? ` [POD: ${extraText}]` : ""; 
        } else if (discCode === '7') { 
            if(!extraText) {
                highlightError(document.getElementById('modal-extra-text'));
                return showAppAlert("Missing Part Name is required for Code 7.");
            }
            entry.missing_part_name = extraText; finding += ` (${extraText})`; 
        }

        entry.findings = [finding];
        // Save optional remark
        const optRemark = document.getElementById('modal-remark');
        if(optRemark && optRemark.value.trim()) entry.optional_remark = optRemark.value.trim();
        
        // Save Suspense(P) tracking data
        const suspenseBox = document.getElementById('modal-suspense-box');
        if (suspenseBox && suspenseBox.style.display !== 'none') {
            const suspenseStatus = suspenseBox.getAttribute('data-status');
            if (suspenseStatus) {
                entry.suspense_sent = suspenseStatus;
                if (suspenseStatus === 'done') {
                    const suspensePod = document.getElementById('suspense-pod').value.trim();
                    if (suspensePod) entry.suspense_pod = suspensePod;
                } else if (suspenseStatus === 'no') {
                    entry.suspense_pending = true; // Mark for urgent action
                }
            }
        }
        
        currentAuditData[claimNo] = entry;

        closeModal(); updateStats();
        
        const session = await localforage.getItem(currentSessionKey);
        if(session) { 
            session.audit_data = currentAuditData; 
            session.last_saved = new Date().toLocaleString(); 
            await saveSessionToDB(session); 
        }
        
        const nextInput = document.getElementById('search-claim'); 
        if(nextInput.value) { nextInput.value = ''; handleSearch(); nextInput.focus(); } 
        else { applyWorkspaceFilters(); } 
    }

    async function finalizeAuditFlow() {
        if(!currentData || currentData.length === 0) return;
        let audited = 0; let clear = 0;
        const findingCounts = {};
        currentData.forEach(row => {
            const entry = currentAuditData[row[colMap.claim_no]];
            if(entry && entry.audited) {
                audited++;
                if(isClaimClean(entry.findings)) { clear++; }
                else {
                    const f = (entry.findings[0] || '').split(' [')[0].split(' (')[0];
                    findingCounts[f] = (findingCounts[f] || 0) + 1;
                }
            }
        });
        const pending = currentData.length - audited; const unclear = audited - clear;

        // Build findings summary
        let summary = `Audit Summary\n`;
        summary += `Clean:   ${clear}\n`;
        summary += `Unclear: ${unclear}\n`;
        summary += `Pending: ${pending}\n`;
        if(Object.keys(findingCounts).length > 0) {
            summary += `\nFindings Breakdown:\n`;
            for(const [f, c] of Object.entries(findingCounts)) {
                summary += `  ${f}: ${c}\n`;
            }
        }
        summary += `\nFinalize this audit?`;

        const processFinalize = async (auditRemark) => {
            showLoader(true);
            const session = await localforage.getItem(currentSessionKey);
            session.finalized = true;
            if(auditRemark) session.audit_remark = auditRemark;
            await saveSessionToDB(session);
            showLoader(false); showAppAlert("Audit finalized and saved."); showScreen('screen-menu');
        };

        // Show summary confirm first, then prompt for optional remark (allows empty)
        showAppConfirm(summary, () => {
            // Custom prompt that allows empty value (remark is optional)
            const msg = "Add a final remark for this audit?\n(Leave blank and press Confirm to skip)";
            document.getElementById('dialog-msg').innerText = msg;
            document.getElementById('dialog-input-wrapper').style.display = 'block';
            const input = document.getElementById('dialog-input');
            const kbBtn = document.getElementById('kb-toggle');
            input.value = '';
            input.type = 'text';
            input.style.cssText = 'text-align:left; letter-spacing:normal; font-size:0.95rem; margin:0; padding:10px 14px; -webkit-text-security:none; text-security:none;';
            input.setAttribute('inputmode', 'text');
            input.placeholder = 'Optional remark for this audit...';
            if(kbBtn) kbBtn.style.display = 'none';
            document.getElementById('dialog-btn-no').style.display = 'block';
            document.getElementById('dialog-btn-no').onclick = closeDialog;
            document.getElementById('dialog-btn-yes').onclick = () => {
                const remark = input.value.trim();
                closeDialog();
                // Reset input style back to PIN style for next use
                input.style.cssText = 'text-align:center; letter-spacing:4px; font-size:1.2rem; margin:0; padding-right:44px; -webkit-text-security:disc; text-security:disc;';
                input.placeholder = '••••••••';
                input.setAttribute('inputmode', 'numeric');
                processFinalize(remark);
            };
            document.getElementById('app-dialog').classList.add('active');
            setTimeout(() => input.focus(), 100);
        });
    }

    // --- ARCHIVE ---
    async function openArchive(showFinalized) {
        showLoader(true); const tbody = document.getElementById('archive-tbody'); tbody.innerHTML = '';
        document.getElementById('archive-title').innerText = showFinalized ? "Previous Audits" : "Drafts"; let found = false;
        for (const [key, meta] of Object.entries(dbIndex)) {
            if (meta.finalized === showFinalized) {
                found = true; const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600;">${meta.month}<br><span style="font-size:0.7rem; color:var(--text-muted); font-weight:normal;">${meta.last_saved}</span>${meta.audit_remark ? `<br><span style="font-size:0.7rem; color:var(--accent); font-weight:600; font-style:italic;">"${meta.audit_remark}"</span>` : ''}</td>
                    <td><span class="badge ${meta.finalized ? 'status-clear' : 'status-unclear'}">${meta.finalized ? 'Fin' : 'Drf'}</span></td>
                    <td><div style="display:flex; gap:6px;"><button class="btn primary" style="padding:6px; width:auto; margin:0;" onclick="resumeSession('${key}', ${meta.finalized})">Open</button><button class="btn danger" style="padding:6px; width:auto; margin:0;" onclick="deleteSession('${key}', ${meta.finalized})">Del</button></div></td>
                `; tbody.appendChild(tr);
            }
        }
        if(!found) tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:var(--text-muted); padding: 20px;">No records found.</td></tr>`;
        showLoader(false); showScreen('screen-archive');
    }

    async function resumeSession(key, isFinalized) { if (isFinalized) { verifyPasswordFlow(() => loadSession(key)); } else { loadSession(key); } }
    
    async function loadSession(key) {
        showLoader(true); const session = await localforage.getItem(key); if(!session) { showLoader(false); return showAppAlert("Error loading session."); }
        currentSessionKey = key; currentData = session.raw_data; workspaceCurrentFilter = 'all'; currentFilteredData = [...currentData]; 
        currentAuditData = session.audit_data; colMap = session.col_map; currentPage = 1; _isNewSession = false;
        _sessionSnapshot = JSON.parse(JSON.stringify(session.audit_data || {})); // snapshot before any edits
        document.getElementById('workspace-title').innerText = session.month; document.getElementById('search-claim').value = '';
        updateStats(); renderTablePage(); showLoader(false); showScreen('screen-workspace');
    }

    async function deleteSession(key, isFinalized) {
        const delOp = async () => { delete dbIndex[key]; await localforage.setItem('db_index', dbIndex); await localforage.removeItem(key); openArchive(document.getElementById('archive-title').innerText.includes('Previous')); };
        if (isFinalized) { verifyPasswordFlow(() => showAppConfirm("Permanently delete this Finalized Audit?", delOp)); } else { showAppConfirm("Permanently delete this Draft?", () => verifyPasswordFlow(delOp)); }
    }

    // --- REPORTING & EXPORT ENGINE ---
    function openReportingMenu() {
        const optContainer = document.getElementById('options-report-scope');
        optContainer.innerHTML = '<div class="custom-option selected" data-value="master">Master Report (All Dates)</div>';
        for (const [key, meta] of Object.entries(dbIndex)) { optContainer.innerHTML += `<div class="custom-option" data-value="${key}">${meta.month} ${meta.finalized ? '(Fin)' : '(Drf)'}</div>`; }
        showScreen('screen-reports');
    }

    function formatRowForExport(row, auditEntry, colMapping) {
        // Build ordered export row with key fields first
        let expRow = {};
        const orderedKeys = ["claim_no","ro_no","claim_type","causal_part","part_desc","prod_date","amount"];
        orderedKeys.forEach(k => { if(colMapping[k]) expRow[colMapping[k]] = row[colMapping[k]] || ""; });
        // Any remaining columns from source
        for(let key in colMapping) { if(!orderedKeys.includes(key)) expRow[colMapping[key]] = row[colMapping[key]] || ""; }
        // Audit fields
        expRow["Audit Status"] = auditEntry.audited ? "Audited" : "Pending";
        expRow["Discrepancy Found"] = (!isClaimClean(auditEntry.findings) && auditEntry.audited) ? "Yes" : "No";
        expRow["Discrepancy Details"] = auditEntry.findings ? auditEntry.findings.join("; ") : "";
        expRow["Optional Remark"] = auditEntry.optional_remark || "";
        expRow["POD Number"] = auditEntry.pod_number || "";
        expRow["Missing Part Name"] = auditEntry.missing_part_name || "";
        expRow["Suspense Status"] = auditEntry.suspense_sent || "";
        expRow["Suspense POD"] = auditEntry.suspense_pod || "";
        expRow["Urgent Action Required"] = (auditEntry.suspense_pending && auditEntry.suspense_sent === 'no') ? "YES - SEND TO TECHNICAL CENTRE" : "";
        expRow["Audit Time"] = auditEntry.timestamp ? new Date(auditEntry.timestamp).toLocaleString() : "";
        expRow["Auditor"] = "Aashish Giri H";
        return expRow;
    }

    function generateExportData(sessionData, filter) {
        let clearRows = []; let unclearRows = [];
        let aAud = 0, aUnc = 0, aPen = 0;
        
        sessionData.raw_data.forEach(row => {
            const entry = sessionData.audit_data[row[sessionData.col_map.claim_no]] || {}; 
            const isClear = entry.audited && isClaimClean(entry.findings);
            const amt = parseAmt(row[sessionData.col_map.amount]);
            
            if (entry.audited) {
                aAud += amt;
                if (!isClear) aUnc += amt;
            } else {
                aPen += amt;
            }

            let fRow = formatRowForExport(row, entry, sessionData.col_map);
            if (filter === 'ALL' || filter === 'CLEAR') { if(isClear) clearRows.push(fRow); }
            if (filter === 'ALL' || filter === 'UNCLEAR') { if(!isClear) unclearRows.push(fRow); }
        }); 
        return { clearRows, unclearRows, periodName: sessionData.month, aAud, aUnc, aPen };
    }

    async function executeExport(format) {
        const scope = document.getElementById('report-scope').value; const filter = document.getElementById('report-filter').value; showLoader(true);
        try {
            let combinedClear = []; let combinedUnclear = [];
            let tAud = 0, tUnc = 0, tPen = 0;

            if (scope === 'master') {
                for (const key of Object.keys(dbIndex)) { 
                    const session = await localforage.getItem(key); 
                    if (session && session.raw_data) { 
                        const data = generateExportData(session, filter); 
                        combinedClear = combinedClear.concat(data.clearRows); combinedUnclear = combinedUnclear.concat(data.unclearRows); 
                        tAud += data.aAud; tUnc += data.aUnc; tPen += data.aPen;
                    } 
                }
            } else { 
                const session = await localforage.getItem(scope); 
                if (session && session.raw_data) { 
                    const data = generateExportData(session, filter); 
                    combinedClear = data.clearRows; combinedUnclear = data.unclearRows; 
                    tAud = data.aAud; tUnc = data.aUnc; tPen = data.aPen;
                } 
            }

            if (combinedClear.length === 0 && combinedUnclear.length === 0) { showLoader(false); return showAppAlert("No data matches this filter."); }
            const fileName = scope === 'master' ? `Master_Audit_${Date.now()}` : `Audit_${scope}`;

            if(format === 'excel') {
                const wb = XLSX.utils.book_new();
                const headers = combinedClear.length > 0 ? Object.keys(combinedClear[0]) : Object.keys(combinedUnclear[0]);
                const periodLabel = scope === 'master' ? 'All Periods' : (dbIndex[scope] ? dbIndex[scope].month : scope);
                const scopeRemark = scope !== 'master' && dbIndex[scope] && dbIndex[scope].audit_remark ? dbIndex[scope].audit_remark : '';

                // ── Helper: apply cell style ──
                function cellStyle(ws, addr, s) { if(!ws[addr]) ws[addr]={v:'',t:'s'}; ws[addr].s = s; }
                function setRow(ws, r, values, styles) {
                    values.forEach((v, c) => {
                        const addr = XLSX.utils.encode_cell({r, c});
                        if(!ws[addr]) ws[addr] = {v: v ?? '', t: typeof v === 'number' ? 'n' : 's'};
                        else { ws[addr].v = v ?? ''; ws[addr].t = typeof v === 'number' ? 'n' : 's'; }
                        if(styles && styles[c]) ws[addr].s = styles[c];
                    });
                }

                const darkBg = {fgColor:{rgb:'1E293B'}}; const greenBg = {fgColor:{rgb:'16A34A'}}; const amberBg = {fgColor:{rgb:'D97706'}};
                const whiteTxt = {color:{rgb:'FFFFFF'}}; const boldWhite = {bold:true, color:{rgb:'FFFFFF'}};
                const thinBorder = { top:{style:'thin',color:{rgb:'CBD5E1'}}, bottom:{style:'thin',color:{rgb:'CBD5E1'}}, left:{style:'thin',color:{rgb:'CBD5E1'}}, right:{style:'thin',color:{rgb:'CBD5E1'}} };
                const thickBorderB = { top:{style:'thin',color:{rgb:'CBD5E1'}}, bottom:{style:'medium',color:{rgb:'64748B'}}, left:{style:'thin',color:{rgb:'CBD5E1'}}, right:{style:'thin',color:{rgb:'CBD5E1'}} };

                const aoa = []; let r = 0;

                // Row 0: Title
                aoa.push([`WARRANTY AUDIT REPORT — ${periodLabel}`]);
                // Row 1: Meta
                aoa.push([`Generated: ${new Date().toLocaleString()}   |   Auditor: Aashish Giri H   |   Filter: ${filter}`]);
                // Row 2: Remark (if any)
                if(scopeRemark) aoa.push([`Auditor Remark: ${scopeRemark}`]); else aoa.push(['']);
                // Row 3: blank
                aoa.push(['']);
                // Row 4: Amount summary labels
                aoa.push(['TOTAL AMOUNT', '', 'AUDITED AMOUNT', '', 'UNCLEAR AMOUNT', '', 'PENDING AMOUNT', '']);
                // Row 5: Amount values
                aoa.push([Math.round(tAud + tPen), '', Math.round(tAud), '', Math.round(tUnc), '', Math.round(tPen), '']);
                // Row 6: blank
                aoa.push(['']);

                let dataStartRow = aoa.length;

                // Clear section
                if(combinedClear.length > 0) {
                    aoa.push([`CLEAR CLAIMS (${combinedClear.length})`]);
                    aoa.push(headers);
                    combinedClear.forEach(row => aoa.push(Object.values(row)));
                    aoa.push(['']);
                }
                // Unclear section
                if(combinedUnclear.length > 0) {
                    aoa.push([`UNCLEAR / PENDING CLAIMS (${combinedUnclear.length})`]);
                    aoa.push(headers);
                    combinedUnclear.forEach(row => aoa.push(Object.values(row)));
                }

                const ws = XLSX.utils.aoa_to_sheet(aoa);
                const numRows = aoa.length; const numCols = headers.length;
                if(!ws['!ref']) ws['!ref'] = XLSX.utils.encode_range({s:{r:0,c:0}, e:{r:numRows-1,c:numCols-1}});

                // Column widths — auto based on header length
                ws['!cols'] = headers.map(h => ({ wch: Math.max(String(h).length + 4, 12) }));
                ws['!cols'][0] = {wch: 16}; // Claim No

                // Row heights
                ws['!rows'] = [];
                ws['!rows'][0] = {hpt: 28}; // Title
                ws['!rows'][1] = {hpt: 18};
                ws['!rows'][4] = {hpt: 20}; // Amount labels
                ws['!rows'][5] = {hpt: 24}; // Amount values

                // Style title row
                const titleCell = XLSX.utils.encode_cell({r:0,c:0});
                if(ws[titleCell]) ws[titleCell].s = {font:{bold:true, sz:14, color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb:'1E293B'}}, alignment:{horizontal:'left',vertical:'center'}};

                // Style meta row
                const metaCell = XLSX.utils.encode_cell({r:1,c:0});
                if(ws[metaCell]) ws[metaCell].s = {font:{italic:true, sz:9, color:{rgb:'64748B'}}, fill:{fgColor:{rgb:'F8FAFC'}}};

                // Style remark row
                const remCell = XLSX.utils.encode_cell({r:2,c:0});
                if(ws[remCell]) ws[remCell].s = {font:{italic:true, sz:9, color:{rgb:'6366F1'}}, fill:{fgColor:{rgb:'F8FAFC'}}};

                // Style amount summary
                const amtLabelStyle = {font:{bold:true, sz:9, color:{rgb:'FFFFFF'}}, alignment:{horizontal:'center',vertical:'center'}};
                const amtValStyle   = {font:{bold:true, sz:13, color:{rgb:'FFFFFF'}}, alignment:{horizontal:'center',vertical:'center'}};
                const amtColors = ['1E293B','16A34A','D97706','64748B'];
                [0,2,4,6].forEach((c,i) => {
                    const lAddr = XLSX.utils.encode_cell({r:4,c});
                    const vAddr = XLSX.utils.encode_cell({r:5,c});
                    if(ws[lAddr]) ws[lAddr].s = {...amtLabelStyle, fill:{fgColor:{rgb:amtColors[i]}}, border:thinBorder};
                    if(ws[vAddr]) ws[vAddr].s = {...amtValStyle,   fill:{fgColor:{rgb:amtColors[i]}}, border:thinBorder};
                });

                // Style data sections
                let curRow = dataStartRow;
                const applySectionStyles = (sectionLabel, dataRows, isClr) => {
                    // Section header
                    const shAddr = XLSX.utils.encode_cell({r:curRow,c:0});
                    if(ws[shAddr]) ws[shAddr].s = {font:{bold:true,sz:11,color:{rgb:'FFFFFF'}}, fill:{fgColor:{rgb: isClr ? '16A34A' : 'DC2626'}}, alignment:{horizontal:'left',vertical:'center'}};
                    ws['!rows'][curRow] = {hpt:20};
                    curRow++;
                    // Column headers
                    for(let c=0;c<headers.length;c++){
                        const hAddr=XLSX.utils.encode_cell({r:curRow,c});
                        if(ws[hAddr]) ws[hAddr].s={font:{bold:true,sz:8,color:{rgb:'FFFFFF'}},fill:{fgColor:{rgb:isClr?'166534':'991B1B'}},border:thickBorderB,alignment:{horizontal:'center',vertical:'center',wrapText:true}};
                    }
                    ws['!rows'][curRow]={hpt:18};
                    curRow++;
                    // Data rows
                    dataRows.forEach((row,ri) => {
                        // Check if this row has urgent action required
                        const isUrgent = row["Urgent Action Required"] && row["Urgent Action Required"].includes("YES");
                        const altFill = isUrgent ? 'FECACA' : (isClr ? (ri%2===0?'F0FDF4':'DCFCE7') : (ri%2===0?'FFFBEB':'FEF3C7'));
                        for(let c=0;c<headers.length;c++){
                            const dAddr=XLSX.utils.encode_cell({r:curRow,c});
                            if(ws[dAddr]) ws[dAddr].s={font:{sz:8,bold:isUrgent},fill:{fgColor:{rgb:altFill}},border:thinBorder,alignment:{horizontal:'center',vertical:'center',wrapText:true}};
                        }
                        ws['!rows'][curRow]={hpt:15};
                        curRow++;
                    });
                    curRow++; // blank row
                };

                if(combinedClear.length > 0) applySectionStyles('clear', combinedClear, true);
                if(combinedUnclear.length > 0) applySectionStyles('unclear', combinedUnclear, false);

                // Merges for title and section headers
                if(!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({s:{r:0,c:0},e:{r:0,c:numCols-1}});
                ws['!merges'].push({s:{r:1,c:0},e:{r:1,c:numCols-1}});
                ws['!merges'].push({s:{r:2,c:0},e:{r:2,c:numCols-1}});

                XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
                XLSX.writeFile(wb, fileName + ".xlsx");
            } 
            else if (format === 'pdf') {
                const btn = document.querySelector('button[onclick="executeExport(\'pdf\')"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = 'Exporting...';
                btn.disabled = true;

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageW = doc.internal.pageSize.getWidth();
                    const now = new Date().toLocaleString();
                    const periodLabel = scope === 'master' ? 'All Periods (Master)' : (dbIndex[scope] ? dbIndex[scope].month : scope);
                    const totalClaims = combinedClear.length + combinedUnclear.length;
                    const tTotal = tAud + tPen;

                    // ── Header Bar ──
                    doc.setFillColor(30, 41, 59);
                    doc.rect(0, 0, pageW, 28, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16); doc.setFont(undefined, 'bold');
                    doc.text('WARRANTY AUDIT REPORT', 14, 11);
                    doc.setFontSize(8); doc.setFont(undefined, 'normal');
                    doc.text(`Period: ${periodLabel}`, 14, 18);
                    doc.text(`Generated: ${now}`, 14, 23);
                    doc.setFontSize(8);
                    doc.text(`Auditor: Aashish Giri H`, pageW - 14, 18, { align: 'right' });
                    doc.text(`Filter: ${filter}  |  Total Claims: ${totalClaims}`, pageW - 14, 23, { align: 'right' });

                    // ── Amount Summary Cards ──
                    doc.setTextColor(30, 41, 59);
                    const cardY = 34; const cardH = 22; const cardW = (pageW - 28 - 12) / 4; const cardX = [14, 14 + cardW + 4, 14 + (cardW + 4) * 2, 14 + (cardW + 4) * 3];
                    const cards = [
                        { label: 'TOTAL AMOUNT', value: pdfAmt(tTotal), color: [30,41,59], text: [255,255,255] },
                        { label: 'AUDITED AMOUNT', value: pdfAmt(tAud), color: [16,185,129], text: [255,255,255] },
                        { label: 'UNCLEAR AMOUNT', value: pdfAmt(tUnc), color: [245,158,11], text: [255,255,255] },
                        { label: 'PENDING AMOUNT', value: pdfAmt(tPen), color: [100,116,139], text: [255,255,255] },
                    ];
                    cards.forEach((c, i) => {
                        doc.setFillColor(...c.color);
                        doc.roundedRect(cardX[i], cardY, cardW, cardH, 2, 2, 'F');
                        doc.setTextColor(...c.text);
                        doc.setFontSize(7); doc.setFont(undefined, 'normal');
                        doc.text(c.label, cardX[i] + cardW / 2, cardY + 7, { align: 'center' });
                        doc.setFontSize(11); doc.setFont(undefined, 'bold');
                        doc.text(c.value, cardX[i] + cardW / 2, cardY + 16, { align: 'center' });
                    });

                    // ── Claim Count Row ──
                    doc.setTextColor(30,41,59); doc.setFont(undefined,'normal'); doc.setFontSize(8);
                    const clrCount = combinedClear.length; const uncCount = combinedUnclear.length;
                    doc.text(`Clean: ${clrCount}   Unclear/Pending: ${uncCount}   Total: ${totalClaims}`, 14, cardY + cardH + 7);

                    // Audit finalization remark (if any)
                    let startY = cardY + cardH + 14;
                    const scopeRemark = scope !== 'master' && dbIndex[scope] && dbIndex[scope].audit_remark ? dbIndex[scope].audit_remark : null;
                    if(scopeRemark) {
                        doc.setFontSize(8); doc.setFont(undefined,'italic'); doc.setTextColor(99,102,241);
                        doc.text(`Auditor Remark: "${scopeRemark}"`, 14, startY);
                        startY += 7;
                        doc.setFont(undefined,'normal');
                    }
                    const headers = combinedClear.length > 0 ? Object.keys(combinedClear[0]) : Object.keys(combinedUnclear[0]);
                    const tableStyles = { fontSize: 5.5, cellPadding: 1.5, overflow: 'linebreak', lineColor: [203,213,225], lineWidth: 0.1 };
                    const tableHeadStyles = { fontSize: 6, fontStyle: 'bold', halign: 'center', cellPadding: 2 };

                    if(combinedClear.length > 0) {
                        doc.setFontSize(10); doc.setFont(undefined,'bold'); doc.setTextColor(16,185,129);
                        doc.text(`CLEAR CLAIMS  (${combinedClear.length})`, 14, startY);
                        doc.autoTable({
                            startY: startY + 4,
                            head: [headers],
                            body: combinedClear.map(r => Object.values(r)),
                            styles: tableStyles,
                            headStyles: { ...tableHeadStyles, fillColor: [16,185,129], textColor: 255 },
                            alternateRowStyles: { fillColor: [240,253,244] },
                            margin: { left: 14, right: 14 }
                        });
                        startY = doc.lastAutoTable.finalY + 12;
                    }
                    if(combinedUnclear.length > 0) {
                        doc.setFontSize(10); doc.setFont(undefined,'bold'); doc.setTextColor(245,158,11);
                        doc.text(`UNCLEAR / PENDING CLAIMS  (${combinedUnclear.length})`, 14, startY);
                        doc.autoTable({
                            startY: startY + 4,
                            head: [headers],
                            body: combinedUnclear.map(r => Object.values(r)),
                            styles: tableStyles,
                            headStyles: { ...tableHeadStyles, fillColor: [220,38,38], textColor: 255 },
                            alternateRowStyles: { fillColor: [255,251,235] },
                            margin: { left: 14, right: 14 }
                        });
                    }

                    // ── Footer on every page ──
                    const pageCount = doc.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7); doc.setFont(undefined,'normal'); doc.setTextColor(148,163,184);
                        doc.text(`Warranty Auditor  |  Aashish Giri H  |  Page ${i} of ${pageCount}`, pageW / 2, doc.internal.pageSize.getHeight() - 5, { align: 'center' });
                    }

                    doc.save(fileName + ".pdf");
                } catch (e) {
                    showAppAlert("Failed: " + e.message);
                } finally {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }
            }
        } catch (e) { showAppAlert("Failed: " + e.message); } finally { showLoader(false); }
    }
    
    // --- CUSTOM CODES & CHART ENGINE ---
    function openSettingsScreen() {
        renderSettingsCodes();
        showScreen('screen-settings');
    }

    function renderSettingsCodes() {
        const tbody = document.getElementById('settings-codes-tbody');
        tbody.innerHTML = '';
        for (let key in DISCREPANCY_TYPES) {
            let isDefault = DEFAULT_DISCREPANCIES[key] ? true : false;
            const actions = isDefault
                ? '<span class="badge">Default</span>'
                : `<div style="display:flex;gap:4px;"><button class="btn" style="padding:4px 8px; margin:0; font-size:0.7rem;" onclick="editCustomCode('${key}')">Edit</button><button class="btn danger" style="padding:4px 8px; margin:0; font-size:0.7rem;" onclick="deleteCustomCode('${key}')">Del</button></div>`;
            tbody.innerHTML += `<tr>
                <td style="font-weight:700;">${key}</td>
                <td style="white-space:normal;">${DISCREPANCY_TYPES[key].replace(/ \[CLN\]$/,'')}</td>
                <td>${actions}</td>
            </tr>`;
        }
        updateModalDropdown();
    }

    function editCustomCode(key) {
        const currentDesc = DISCREPANCY_TYPES[key].replace(/ \[CLN\]$/, '');
        const isCln = DISCREPANCY_TYPES[key].endsWith('[CLN]');
        document.getElementById('new-code-id').value = key;
        document.getElementById('new-code-desc').value = currentDesc;
        setCustomSelectValue('wrap-new-code-type', isCln ? 'clean' : 'unclear');
        // Change Add button to Update for this edit session
        const addBtn = document.querySelector('#screen-settings .btn.primary[onclick="addCustomCode()"]');
        if(addBtn) {
            addBtn.innerText = `Update Code ${key}`;
            addBtn.onclick = () => {
                delete DISCREPANCY_TYPES[key];
                localStorage.setItem('auditor_custom_codes', JSON.stringify(DISCREPANCY_TYPES));
                addCustomCode();
                addBtn.innerText = '+ Add Code';
                addBtn.onclick = addCustomCode;
            };
        }
        document.getElementById('new-code-id').scrollIntoView({behavior:'smooth', block:'center'});
    }

    function addCustomCode() {
        const id = document.getElementById('new-code-id').value.trim();
        let desc = document.getElementById('new-code-desc').value.trim();
        const codeType = document.getElementById('new-code-type').value; // Dropdown ki value yahan read hogi
        
        if (!id || !desc) return showAppAlert("Enter both Code and Description.");
        if (DISCREPANCY_TYPES[id]) return showAppAlert("This Code already exists!");
        
        // Agar clean select kiya hai, toh description mein invisibly [CLN] add kar do
        if (codeType === 'clean') {
            desc = desc + " [CLN]";
        }
        
        DISCREPANCY_TYPES[id] = desc;
        localStorage.setItem('auditor_custom_codes', JSON.stringify(DISCREPANCY_TYPES));
        document.getElementById('new-code-id').value = '';
        document.getElementById('new-code-desc').value = '';
        
        // Dropdown ko wapas default (unclear) par set karne ke liye
        setCustomSelectValue('wrap-new-code-type', 'unclear');
        
        renderSettingsCodes();
        showAppAlert("Custom code saved.");
    }

    async function deleteCustomCode(key) {
        // Check how many saved audit claims use this code's text
        const codeText = DISCREPANCY_TYPES[key];
        let usedIn = 0;
        try {
            const allKeys = await localforage.keys();
            for (const k of allKeys) {
                if (!k.startsWith('audit_')) continue;
                const session = await localforage.getItem(k);
                if (!session || !session.audit_data) continue;
                for (const claimNo in session.audit_data) {
                    const entry = session.audit_data[claimNo];
                    if (entry && entry.findings && entry.findings[0] && entry.findings[0].includes(codeText)) {
                        usedIn++;
                    }
                }
            }
        } catch(e) {}

        const doDelete = () => {
            verifyPasswordFlow(() => {
                delete DISCREPANCY_TYPES[key];
                localStorage.setItem('auditor_custom_codes', JSON.stringify(DISCREPANCY_TYPES));
                renderSettingsCodes();
                showAppAlert('Custom code deleted. Existing claim finding texts are preserved in saved audits.');
            });
        };

        if (usedIn > 0) {
            showAppConfirm(
                `Code "${key}" is in use across ${usedIn} claim(s).\n\nExisting findings are preserved, but re-saving those claims will reset them to Clean.\n\nProceed?`,
                doDelete
            );
        } else {
            showAppConfirm(`Delete custom code "${key}: ${codeText}"?`, doDelete);
        }
    }

    function updateModalDropdown() {
        const wrap = document.getElementById('wrap-modal-disc');
        if(!wrap) return;
        const optsContainer = wrap.querySelector('.custom-options');
        optsContainer.innerHTML = '';
        for (let key in DISCREPANCY_TYPES) {
            let displayText = DISCREPANCY_TYPES[key] === "None Found" ? "Part is Clean (None Found)" : DISCREPANCY_TYPES[key];
            optsContainer.innerHTML += `<div class="custom-option" data-value="${key}">${displayText}</div>`;
        }
    }
    
    // Auto-load custom codes into dropdown on start
    setTimeout(updateModalDropdown, 300);

    // ══════════════════════════════════════════════════
    // GITHUB GIST CLOUD SYNC MODULE (AES-GCM ENCRYPTED)
    // ══════════════════════════════════════════════════

    async function deriveKey(pass,salt){const km=await crypto.subtle.importKey('raw',new TextEncoder().encode(pass),{name:'PBKDF2'},false,['deriveKey']);return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:310000,hash:'SHA-256'},km,{name:'AES-GCM',length:256},false,['encrypt','decrypt']);}
    async function encryptToken(plain,pass){const salt=crypto.getRandomValues(new Uint8Array(16)),iv=crypto.getRandomValues(new Uint8Array(12)),key=await deriveKey(pass,salt),c=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,new TextEncoder().encode(plain)),o=new Uint8Array(16+12+c.byteLength);o.set(salt,0);o.set(iv,16);o.set(new Uint8Array(c),28);return btoa(String.fromCharCode(...o));}
    async function decryptToken(b64,pass){const b=Uint8Array.from(atob(b64),c=>c.charCodeAt(0)),key=await deriveKey(pass,b.slice(0,16));return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv:b.slice(16,28)},key,b.slice(28)));}

    let _gistPassCache=null;
    async function getDecryptedToken(){
        const enc=localStorage.getItem('gist_token_enc');
        if(!enc) return null;
        if(_gistPassCache){try{return await decryptToken(enc,_gistPassCache);}catch{_gistPassCache=null;}}
        return new Promise(resolve=>{
            showAppPrompt('Enter Token Passphrase:',true,async pass=>{
                try{const t=await decryptToken(enc,pass);_gistPassCache=pass;if(localStorage.getItem('gist_dirty_flag')==='true'){localStorage.removeItem('gist_dirty_flag');setTimeout(()=>silentAutoSync('crash-recovery'),2000);}resolve(t);}
                catch{showAppAlert('Wrong passphrase.');resolve(null);}
            });
        });
    }

    const RATE_WARN=4000, RATE_MAX=4500;
    function getRateData(){try{return JSON.parse(localStorage.getItem('gist_rate_data'))||{c:0,t:Date.now()};}catch{return{c:0,t:Date.now()};}}
    function bumpRate(){let d=getRateData();if(Date.now()-d.t>3600000)d={c:0,t:Date.now()};d.c++;localStorage.setItem('gist_rate_data',JSON.stringify(d));checkRate(d.c);}
    function checkRate(c){
        if(c>=RATE_MAX&&isAutoSyncOn()){localStorage.setItem('gist_autosync','false');stopSyncTimer();updateSyncUI();showToast('Auto-Sync disabled — GitHub rate limit almost reached ('+c+'/5000 this hour). You can still upload manually.','danger',12000);}
        else if(c>=RATE_WARN&&c<RATE_MAX){showToast('GitHub rate limit warning: '+c+'/5000 requests used this hour. Auto-sync will disable at 4500.','warning',7000);}
    }

    function showToast(msg,type,dur){
        let t=document.getElementById('gist-toast');
        if(!t){t=document.createElement('div');t.id='gist-toast';t.style.cssText='position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:9999;max-width:92vw;width:380px;padding:14px 18px;border-radius:12px;font-size:0.8rem;font-weight:600;line-height:1.5;box-shadow:0 8px 32px rgba(0,0,0,0.22);cursor:pointer;transition:opacity 0.3s;';t.onclick=()=>{t.style.opacity='0';setTimeout(()=>{if(t.parentNode)t.remove();},300);};document.body.appendChild(t);}
        const S={danger:{bg:'rgba(239,68,68,0.97)',b:'#ef4444',c:'#fff'},warning:{bg:'rgba(245,158,11,0.97)',b:'#f59e0b',c:'#111'},success:{bg:'rgba(16,185,129,0.97)',b:'#10b981',c:'#fff'}};
        const s=S[type]||S.success;t.style.background=s.bg;t.style.border='1px solid '+s.b;t.style.color=s.c;t.style.opacity='1';t.innerText=msg;
        if(t._x)clearTimeout(t._x);t._x=setTimeout(()=>{t.style.opacity='0';setTimeout(()=>{if(t.parentNode)t.remove();},300);},(dur||5000));
    }

    let _syncTimer=null,_syncing=false,_syncPending=false;
    const SYNC_INTERVAL=3*60*1000;
    function isAutoSyncOn(){return localStorage.getItem('gist_autosync')==='true';}
    function toggleAutoSync(){const n=!isAutoSyncOn();localStorage.setItem('gist_autosync',n?'true':'false');n?startSyncTimer():stopSyncTimer();updateSyncUI();if(n){const w=document.getElementById('autosync-warning');if(w)w.style.display='block';}}
    function startSyncTimer(){stopSyncTimer();_syncTimer=setInterval(()=>silentAutoSync('3min'),SYNC_INTERVAL);}
    function stopSyncTimer(){if(_syncTimer){clearInterval(_syncTimer);_syncTimer=null;}}

    function updateSyncUI(){
        const en=isAutoSyncOn(),btn=document.getElementById('btn-autosync-toggle');
        if(!btn)return;
        const st=document.getElementById('autosync-status-text'),tr=document.getElementById('autosync-triggers'),wa=document.getElementById('autosync-warning');
        if(en){btn.innerText='ON';btn.style.cssText='padding:6px 14px;border-radius:20px;font-size:0.78rem;font-weight:700;cursor:pointer;background:rgba(16,185,129,0.15);color:var(--success);border:1px solid rgba(16,185,129,0.4);';const ls=localStorage.getItem('gist_last_sync');if(st)st.innerText=ls?'Last sync: '+ls:'Active — not synced yet';if(tr)tr.style.display='block';if(wa)wa.style.display='block';}
        else{btn.innerText='OFF';btn.style.cssText='padding:6px 14px;border-radius:20px;font-size:0.78rem;font-weight:700;cursor:pointer;background:var(--surface);color:var(--text-muted);border:1px solid var(--border);';if(st)st.innerText='Enable to auto-backup on finalize, close & every 3 min';if(tr)tr.style.display='none';if(wa)wa.style.display='none';}
        updateLastSyncCard();
    }

    function updateLastSyncCard(){
        const card=document.getElementById('last-sync-card'),disp=document.getElementById('last-sync-display'),age=document.getElementById('last-sync-age');
        if(!card||!disp)return;
        const ls=localStorage.getItem('gist_last_sync');
        if(ls){card.style.display='block';disp.innerText=ls;
            // Use ISO timestamp for accurate age calculation; fallback to locale string parse
            const isoTs=localStorage.getItem('gist_last_sync_iso');
            const d=isoTs?new Date(isoTs):new Date(ls);
            if(!isNaN(d)){const diff=Math.floor((Date.now()-d)/1000);age.innerText=diff<60?diff+'s ago':diff<3600?Math.floor(diff/60)+'m ago':diff<86400?Math.floor(diff/3600)+'h ago':Math.floor(diff/86400)+'d ago';}}
        else{card.style.display='none';}
    }

    async function silentAutoSync(trigger){
        if(!isAutoSyncOn()||!localStorage.getItem('gist_token_enc'))return;
        // Background timers only run if passphrase already cached (no UI prompt)
        if(!_gistPassCache)return; // never prompt during auto-sync — only sync if passphrase already cached
        if(_syncing){_syncPending=true;return;}
        _syncing=true;showSyncDot(true);
        try{
            // getDecryptedToken handles both: returns cached token or prompts user
            const tok=await getDecryptedToken();
            if(!tok){return;}
            let bk={};const ks=await localforage.keys();for(let k of ks)bk[k]=await localforage.getItem(k);
            bk['_secConfig']=localStorage.getItem('auditor_sec')||'{}';bk['_autosync']=localStorage.getItem('gist_autosync')||'false';bk['_theme']=localStorage.getItem('auditor_theme')||'light';bk['_customCodes']=localStorage.getItem('auditor_custom_codes')||'{}';
            const gid=localStorage.getItem('gist_id'),ds=new Date().toLocaleString();
            const res=await fetch(gid?'https://api.github.com/gists/'+gid:'https://api.github.com/gists',{method:gid?'PATCH':'POST',headers:{'Authorization':'token '+tok,'Content-Type':'application/json'},body:JSON.stringify({description:'WA Auto-Backup['+trigger+'] '+ds,public:false,files:{'auditor_backup.json':{content:JSON.stringify(bk)}}})});
            bumpRate();
            if(res.ok){const j=await res.json();localStorage.setItem('gist_id',j.id);localStorage.setItem('gist_last_sync',ds);localStorage.setItem('gist_last_sync_iso',new Date().toISOString());localStorage.removeItem('gist_dirty_flag');const sel=document.getElementById('autosync-status-text');if(sel&&isAutoSyncOn())sel.innerText='Last sync: '+ds;updateLastSyncCard();showToast('Auto-sync complete! '+ds,'success',4000);}
            else if(res.status===403||res.status===429){localStorage.setItem('gist_autosync','false');stopSyncTimer();updateSyncUI();showToast('Auto-Sync disabled — GitHub rate limit hit ('+res.status+'). Turned OFF automatically.','danger',10000);}
        }catch(e){console.warn('silent sync fail:',e.message);}
        finally{_syncing=false;showSyncDot(false);if(_syncPending){_syncPending=false;setTimeout(()=>silentAutoSync('queued'),3000);}}
    }
    function showSyncDot(s){const el=document.getElementById('gist-sync-indicator');if(el)el.style.display=s?'inline':'none';}

    window.addEventListener('beforeunload',()=>{if(isAutoSyncOn()&&localStorage.getItem('gist_token_enc'))localStorage.setItem('gist_dirty_flag','true');});
    document.addEventListener('visibilitychange',()=>{
        if(document.visibilityState==='hidden'){
            // Page going to standby/background — pause the timer, no sync
            if(_syncTimer) stopSyncTimer();
        } else {
            // Page back in focus — resume timer if autosync on
            if(isAutoSyncOn() && localStorage.getItem('gist_token_enc') && !_syncTimer) startSyncTimer();
        }
    });

    async function headerUploadNow() {
        const btn = document.getElementById('header-upload-btn');
        if (!localStorage.getItem('gist_token_enc')) { showAppAlert("Not connected to GitHub. Go to Backup & Restore to connect."); return; }
        btn.classList.add('syncing');
        try {
            await syncToGist(false);
            btn.classList.remove('syncing');
            btn.classList.add('done');
            showToast('Uploaded to GitHub Cloud! ' + new Date().toLocaleString(), 'success', 3000);
            setTimeout(() => btn.classList.remove('done'), 600);
        } catch(e) {
            btn.classList.remove('syncing');
            showToast('Upload failed: ' + e.message, 'danger', 4000);
        }
    }

    // Update header buttons visibility based on connection state
    function updateHeaderUploadBtn() {
        const connected = !!localStorage.getItem('gist_token_enc');
        const up = document.getElementById('header-upload-btn');
        if (up) { up.style.opacity = connected ? '1' : '0.35'; up.title = connected ? 'Upload to GitHub Cloud' : 'Not connected to GitHub'; }
        const re = document.getElementById('header-restore-btn');
        if (re) { re.style.opacity = connected ? '1' : '0.35'; re.title = connected ? 'Restore from GitHub Cloud' : 'Not connected to GitHub'; }
    }

    async function headerRestoreNow() {
        const btn = document.getElementById('header-restore-btn');
        if (!localStorage.getItem('gist_token_enc')) { showAppAlert("Not connected to GitHub. Go to Backup & Restore to connect."); return; }
        showAppConfirm("Restore from GitHub Cloud?\n\nThis will OVERWRITE all local data.", async () => {
            btn.classList.add('loading');
            const tok = await getDecryptedToken(); if (!tok) { btn.classList.remove('loading'); return; }
            try {
                let gid = localStorage.getItem('gist_id');
                if (!gid) {
                    let page = 1, found = false;
                    while (!found) {
                        const gr = await fetch('https://api.github.com/gists?per_page=100&page=' + page, { headers: { 'Authorization': 'token ' + tok } }); bumpRate();
                        if (!gr.ok) throw new Error('Could not search Gists.');
                        const gists = await gr.json();
                        if (gists.length === 0) throw new Error("No backup found.");
                        const match = gists.find(g => g.files && g.files['auditor_backup.json']);
                        if (match) { gid = match.id; localStorage.setItem('gist_id', gid); found = true; }
                        else if (gists.length < 100) throw new Error("No backup found in your GitHub Gists.");
                        else page++;
                    }
                }
                const r = await fetch('https://api.github.com/gists/' + gid, { headers: { 'Authorization': 'token ' + tok } }); bumpRate();
                if (!r.ok) throw new Error('Could not fetch backup.');
                const j = await r.json(), ct = j.files['auditor_backup.json']?.content;
                if (!ct) throw new Error("Backup file not found.");
                const data = JSON.parse(ct); await localforage.clear();
                for (let k in data) { if (k === '_secConfig') localStorage.setItem('auditor_sec', data[k]); else if (k === '_autosync') localStorage.setItem('gist_autosync', data[k]); else if (k === '_theme') { localStorage.setItem('auditor_theme', data[k]); applyTheme(data[k]); } else if (k === '_customCodes') { localStorage.setItem('auditor_custom_codes', data[k]); } else await localforage.setItem(k, data[k]); }
                localStorage.setItem('gist_id', gid);
                btn.classList.remove('loading'); btn.classList.add('done');
                showToast('Restore Successful! Reloading...', 'success', 3000);
                setTimeout(() => window.location.reload(), 2000);
            } catch(e) {
                btn.classList.remove('loading');
                showToast('Restore failed: ' + e.message, 'danger', 4000);
            }
        });
    }

    function initGistUI(){
        const hasEnc=!!localStorage.getItem('gist_token_enc'),gid=localStorage.getItem('gist_id');
        const setup=document.getElementById('gist-setup-section'),conn=document.getElementById('gist-connected-section'),dot=document.getElementById('gist-status-dot');
        if(!setup||!conn||!dot)return;
        if(hasEnc){
            setup.style.display='none';conn.style.display='block';dot.innerText='Connected';dot.style.background='rgba(16,185,129,0.1)';dot.style.color='var(--success)';
            const ls=localStorage.getItem('gist_last_sync'),gi=document.getElementById('gist-info-text');
            if(gi)gi.innerHTML=gid?'Gist: <span style="font-family:monospace;color:var(--accent);">'+gid.substring(0,20)+'...</span>'+(ls?'<br><small style="color:var(--text-muted);">Last sync: '+ls+'</small>':''):'Connected. No backup yet.';
            updateSyncUI();if(isAutoSyncOn()&&!_syncTimer)startSyncTimer();
        }else{
            setup.style.display='block';conn.style.display='none';dot.innerText='Not Connected';dot.style.background='rgba(100,116,139,0.1)';dot.style.color='var(--text-muted)';stopSyncTimer();
        }
        updateHeaderUploadBtn();
    }

    const _oSS=showScreen;
    showScreen=function(id){_oSS(id);if(id==='screen-backup')setTimeout(initGistUI,50);};

    function toggleGistTokenVisibility(){const i=document.getElementById('gist-token-input'),b=document.getElementById('gist-token-eye');const hidden=i.style.webkitTextSecurity==='disc';i.style.webkitTextSecurity=hidden?'none':'disc';i.style.textSecurity=hidden?'none':'disc';b.innerHTML=hidden?`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`;}

    async function connectGist(){
        const tok=document.getElementById('gist-token-input').value.trim();
        if(!tok||!tok.startsWith('ghp_'))return showAppAlert("Invalid token. Must start with ghp_");
        showLoader(true);
        try{
            const r=await fetch('https://api.github.com/user',{headers:{'Authorization':'token '+tok}});
            if(!r.ok)throw new Error("Token invalid or expired.");
            const u=await r.json();showLoader(false);
            showAppPrompt('Verified as @'+u.login+'! Set a Passphrase to encrypt your token (needed on new devices):',true,p1=>{
                if(p1.length<4)return showAppAlert("Passphrase too short. Min 4 characters.");
                showAppPrompt('Confirm Passphrase:',true,async p2=>{
                    if(p1!==p2)return showAppAlert("Passphrases do not match.");
                    showLoader(true);
                    try{const e=await encryptToken(tok,p1);localStorage.setItem('gist_token_enc',e);_gistPassCache=p1;document.getElementById('gist-token-input').value='';showLoader(false);initGistUI();showAppAlert('Connected as @'+u.login+'. Token encrypted with AES-256. Raw token never stored.');}
                    catch(e){showLoader(false);showAppAlert("Encryption failed: "+e.message);}
                });
            });
        }catch(e){showLoader(false);showAppAlert("Connection Failed: "+e.message);}
    }

    async function syncToGist(alert){
        const tok=await getDecryptedToken();if(!tok)return;
        if(alert)showLoader(true);
        try{
            let bk={};const ks=await localforage.keys();for(let k of ks)bk[k]=await localforage.getItem(k);bk['_secConfig']=localStorage.getItem('auditor_sec')||'{}';bk['_autosync']=localStorage.getItem('gist_autosync')||'false';bk['_theme']=localStorage.getItem('auditor_theme')||'light';bk['_customCodes']=localStorage.getItem('auditor_custom_codes')||'{}';
            const gid=localStorage.getItem('gist_id'),ds=new Date().toLocaleString();
            const res=await fetch(gid?'https://api.github.com/gists/'+gid:'https://api.github.com/gists',{method:gid?'PATCH':'POST',headers:{'Authorization':'token '+tok,'Content-Type':'application/json'},body:JSON.stringify({description:'Warranty Auditor Backup '+ds,public:false,files:{'auditor_backup.json':{content:JSON.stringify(bk)}}})});
            bumpRate();
            if(!res.ok){const e=await res.json();throw new Error(e.message||'API error');}
            const j=await res.json();localStorage.setItem('gist_id',j.id);localStorage.setItem('gist_last_sync',ds);localStorage.setItem('gist_last_sync_iso',new Date().toISOString());localStorage.removeItem('gist_dirty_flag');
            if(alert){showLoader(false);initGistUI();showAppAlert('Upload Successful! '+ds);}else initGistUI();
        }catch(e){if(alert){showLoader(false);showAppAlert("Upload Failed: "+e.message);}}
    }

    async function restoreFromGist(){
        if(!localStorage.getItem('gist_token_enc'))return showAppAlert("Not connected.");
        showAppConfirm("Restore from GitHub Cloud? This will OVERWRITE all local data.",async()=>{
            const tok=await getDecryptedToken();if(!tok)return;
            showLoader(true);
            try{
                // Use stored gist_id if available, otherwise search all gists for the backup file
                let gid=localStorage.getItem('gist_id');
                if(!gid){
                    showLoader(true);
                    let page=1,found=false;
                    while(!found){
                        const gr=await fetch('https://api.github.com/gists?per_page=100&page='+page,{headers:{'Authorization':'token '+tok}});bumpRate();
                        if(!gr.ok)throw new Error('Could not search Gists.');
                        const gists=await gr.json();
                        if(gists.length===0)throw new Error("No backup found in your GitHub Gists. Please upload from your other device first.");
                        const match=gists.find(g=>g.files&&g.files['auditor_backup.json']);
                        if(match){gid=match.id;localStorage.setItem('gist_id',gid);found=true;}
                        else if(gists.length<100){throw new Error("No backup found in your GitHub Gists. Please upload from your other device first.");}
                        else{page++;}
                    }
                }
                const r=await fetch('https://api.github.com/gists/'+gid,{headers:{'Authorization':'token '+tok}});bumpRate();
                if(!r.ok)throw new Error('Could not fetch backup.');
                const j=await r.json(),ct=j.files['auditor_backup.json']?.content;
                if(!ct)throw new Error("Backup file not found in Gist.");
                const data=JSON.parse(ct);await localforage.clear();
                for(let k in data){if(k==='_secConfig')localStorage.setItem('auditor_sec',data[k]);else if(k==='_autosync')localStorage.setItem('gist_autosync',data[k]);else if(k==='_theme'){localStorage.setItem('auditor_theme',data[k]);applyTheme(data[k]);}else if(k==='_customCodes'){localStorage.setItem('auditor_custom_codes',data[k]);}else await localforage.setItem(k,data[k]);}
                localStorage.setItem('gist_id',gid);
                showLoader(false);showAppAlert("Restore Successful! App will reload.");setTimeout(()=>window.location.reload(),2000);
            }catch(e){showLoader(false);showAppAlert("Restore Failed: "+e.message);}
        });
    }

    async function deleteGistFile(){
        if(!localStorage.getItem('gist_token_enc'))return showAppAlert("Not connected.");
        const gid=localStorage.getItem('gist_id');
        if(!gid)return showAppAlert("No cloud file to delete.");
        verifyPasswordFlow(async()=>{
            showAppConfirm("Delete cloud backup file from GitHub? Local data is NOT affected.",async()=>{
                const tok=await getDecryptedToken();if(!tok)return;
                showLoader(true);
                try{
                    const res=await fetch('https://api.github.com/gists/'+gid,{method:'PATCH',headers:{'Authorization':'token '+tok,'Content-Type':'application/json'},body:JSON.stringify({files:{'auditor_backup.json':null}})});bumpRate();
                    if(!res.ok){const e=await res.json();throw new Error(e.message||'Delete failed');}
                    localStorage.removeItem('gist_last_sync');localStorage.removeItem('gist_id');showLoader(false);initGistUI();showAppAlert("Cloud backup file deleted. Local data is safe.");
                }catch(e){showLoader(false);showAppAlert("Delete Failed: "+e.message);}
            });
        });
    }

    function disconnectGist(){
        showAppConfirm("Disconnect GitHub? Cloud backup stays safe. Only this device connection is removed.",()=>{
            ['gist_token_enc','gist_id','gist_last_sync','gist_autosync','gist_dirty_flag','gist_rate_data'].forEach(k=>localStorage.removeItem(k));
            _gistPassCache=null;stopSyncTimer();initGistUI();showAppAlert("Disconnected from GitHub.");
        });
    }

    const _oFA=finalizeAuditFlow;
    finalizeAuditFlow=async function(){await _oFA();if(isAutoSyncOn()&&localStorage.getItem('gist_token_enc'))setTimeout(()=>silentAutoSync('finalize'),1500);};

    setTimeout(()=>{
        if(isAutoSyncOn()&&localStorage.getItem('gist_token_enc')){startSyncTimer();const d=getRateData();if(d.c>=RATE_WARN)checkRate(d.c);}updateHeaderUploadBtn();
    },800);


    // --- PC KEYBOARD SHORTCUTS (Workspace / Auditing only) ---
    // ── SHORTCUT OVERLAY helpers ──
    function toggleShortcutOverlay() {
        const el = document.getElementById('shortcut-overlay');
        el.classList.toggle('active');
    }
    function closeShortcutOverlay(e) {
        if (e.target === document.getElementById('shortcut-overlay')) toggleShortcutOverlay();
    }

    // ── DROPDOWN keyboard navigation ──

    // ══════════════════════════════════════════════════
    // CUSTOM MONTH-YEAR PICKER
    // ══════════════════════════════════════════════════
    const MP_MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const _mpState = {}; // { wrapperId: { year, month } }

    function _mpInit(wrapperId) {
        if (!_mpState[wrapperId]) {
            const now = new Date();
            _mpState[wrapperId] = { year: now.getFullYear(), month: now.getMonth() };
        }
    }

    function renderMonthGrid(wrapperId) {
        _mpInit(wrapperId);
        const state = _mpState[wrapperId];
        const now = new Date();
        const container = document.getElementById(wrapperId + '-months');
        const yearLabel = document.getElementById(wrapperId + '-year');
        if (!container || !yearLabel) return;

        yearLabel.innerText = state.year;

        // Get currently selected month for this picker (from hidden input)
        const wrapper = document.getElementById(wrapperId);
        const targetId = wrapper.getAttribute('data-target');
        const hiddenVal = document.getElementById(targetId).value; // YYYY-MM-DD or ''
        let selMonth = -1, selYear = -1;
        if (hiddenVal) {
            const d = new Date(hiddenVal);
            selMonth = d.getMonth(); selYear = d.getFullYear();
        }

        container.innerHTML = '';
        MP_MONTHS.forEach((name, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'mp-month-btn';
            btn.innerText = name;

            const isSelected = (idx === selMonth && state.year === selYear);
            const isCurrent = (idx === now.getMonth() && state.year === now.getFullYear());
            if (isSelected) btn.classList.add('selected');
            if (isCurrent && !isSelected) btn.classList.add('current-month');

            btn.onclick = (e) => {
                e.stopPropagation();
                selectMonth(wrapperId, state.year, idx);
            };
            container.appendChild(btn);
        });
    }

    function toggleMonthPicker(wrapperId) {
        const wrapper = document.getElementById(wrapperId);
        const isOpen = wrapper.classList.contains('open');

        // Close all pickers
        document.querySelectorAll('.mp-wrapper.open').forEach(w => w.classList.remove('open'));

        if (!isOpen) {
            _mpInit(wrapperId);
            renderMonthGrid(wrapperId);
            wrapper.classList.add('open');
        }
    }

    function shiftYear(wrapperId, delta) {
        _mpInit(wrapperId);
        _mpState[wrapperId].year += delta;
        renderMonthGrid(wrapperId);
    }

    function selectMonth(wrapperId, year, monthIdx) {
        // Build YYYY-MM-DD value (first day of month)
        const mm = String(monthIdx + 1).padStart(2, '0');
        const firstDay = `${year}-${mm}-01`;
        // Last day of month
        const lastDay = new Date(year, monthIdx + 1, 0).toISOString().split('T')[0];

        const wrapper = document.getElementById(wrapperId);
        const targetId = wrapper.getAttribute('data-target');

        // Set hidden input value: from = first day, to = last day
        const hiddenInput = document.getElementById(targetId);
        if (targetId === 'audit-from') hiddenInput.value = firstDay;
        else hiddenInput.value = lastDay;

        // Update display label with animation
        const label = document.getElementById(wrapperId + '-label');
        label.classList.remove('placeholder');
        label.style.opacity = '0';
        label.style.transform = 'translateY(4px)';
        setTimeout(() => {
            label.innerText = MP_MONTHS[monthIdx] + ' ' + year;
            label.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
            label.style.opacity = '1';
            label.style.transform = 'translateY(0)';
        }, 80);

        // Update internal state
        _mpState[wrapperId] = { year, month: monthIdx };

        // Close picker with slight delay for selection animation
        setTimeout(() => {
            wrapper.classList.remove('open');
        }, 180);

        // Re-render to show selection
        renderMonthGrid(wrapperId);
    }

    function setMonthPickerValue(wrapperId, year, monthIdx) {
        _mpInit(wrapperId);
        _mpState[wrapperId] = { year, month: monthIdx };
        const label = document.getElementById(wrapperId + '-label');
        if (label) {
            label.classList.remove('placeholder');
            label.innerText = MP_MONTHS[monthIdx] + ' ' + year;
        }
        renderMonthGrid(wrapperId);
    }

    // Close picker on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.mp-wrapper')) {
            document.querySelectorAll('.mp-wrapper.open').forEach(w => w.classList.remove('open'));
        }
    });

    // Initialize labels as placeholder style on load
    document.addEventListener('DOMContentLoaded', function() {
        ['mp-from', 'mp-to'].forEach(id => {
            const lbl = document.getElementById(id + '-label');
            if (lbl && lbl.innerText === 'Select month') lbl.classList.add('placeholder');
        });
    });

    document.addEventListener('keydown', function(e) {
        const workspaceActive = document.getElementById('screen-workspace').classList.contains('active');
        const dashboardActive = document.getElementById('screen-dashboard').classList.contains('active');
        const menuActive = document.getElementById('screen-menu').classList.contains('active');
        const modalOpen = document.getElementById('audit-modal').classList.contains('active');
        const dialogOpen = document.getElementById('app-dialog').classList.contains('active');
        const shortcutOpen = document.getElementById('shortcut-overlay').classList.contains('active');
        const openDropdown = document.querySelector('.custom-select-wrapper.open');

        // --- Shortcut overlay: ? to toggle, Escape to close ---
        if (shortcutOpen) {
            if (e.key === 'Escape') { e.preventDefault(); toggleShortcutOverlay(); }
            return;
        }

        // --- ? anywhere = open shortcut help (#20) ---
        if (e.key === '?' && !dialogOpen && !modalOpen && !document.activeElement.matches('input, textarea')) {
            e.preventDefault(); toggleShortcutOverlay(); return;
        }

        // --- Dropdown keyboard navigation (#16, 17, 18) ---
        if (openDropdown) {
            const opts = Array.from(openDropdown.querySelectorAll('.custom-option'));
            const focused = openDropdown.querySelector('.custom-option.kb-focus');
            const idx = focused ? opts.indexOf(focused) : opts.findIndex(o => o.classList.contains('selected'));
            if (e.key === 'Escape') {
                e.preventDefault();
                document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
                return;
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = opts[Math.min(idx + 1, opts.length - 1)];
                opts.forEach(o => o.classList.remove('kb-focus'));
                next.classList.add('kb-focus');
                next.scrollIntoView({ block: 'nearest' });
                return;
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = opts[Math.max(idx - 1, 0)];
                opts.forEach(o => o.classList.remove('kb-focus'));
                prev.classList.add('kb-focus');
                prev.scrollIntoView({ block: 'nearest' });
                return;
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                const target = focused || opts[Math.max(idx, 0)];
                if (target) { opts.forEach(o => o.classList.remove('kb-focus')); target.click(); }
                return;
            }
        }

        // --- Dialog keyboard: Enter = Confirm, Escape = Cancel ---
        if (dialogOpen) {
            if (e.key === 'Escape') {
                e.preventDefault();
                const noBtn = document.getElementById('dialog-btn-no');
                if (noBtn && noBtn.style.display !== 'none') { noBtn.click(); }
                else { document.getElementById('dialog-btn-yes').click(); }
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('dialog-btn-yes').click();
            }
            return;
        }

        // --- Audit modal bindings ---
        if (modalOpen) {
            if (e.key === 'Escape') { e.preventDefault(); closeModal(); return; }
            const activeEl = document.activeElement;
            const isTypingInModal = activeEl && (activeEl.id === 'modal-remark' || activeEl.id === 'modal-extra-text' || activeEl.tagName === 'TEXTAREA');

            // #19 — 0-9 quick-select discrepancy (when not typing in input)
            if (!isTypingInModal && /^[0-9]$/.test(e.key) && !e.ctrlKey && !e.altKey && !e.metaKey) {
                const match = document.querySelector('#wrap-modal-disc .custom-option[data-value="' + e.key + '"]');
                if (match) { e.preventDefault(); match.click(); }
                return;
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                if (isTypingInModal) return;
                if (document.querySelector('.custom-select-wrapper.open')) {
                    document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
                    return;
                }
                saveClaimAudit();
            }
            return;
        }

        // --- Escape: back to menu from any simple screen (#1, 3, 4, 5, 6, 7) ---
        if (e.key === 'Escape') {
            e.preventDefault();
            if (workspaceActive) { requestExitWorkspace(); return; } // #8
            const screens = ['screen-dashboard','screen-archive','screen-reports','screen-security','screen-backup','screen-settings','screen-new-audit'];
            for (const sid of screens) {
                if (document.getElementById(sid).classList.contains('active')) {
                    showScreen('screen-menu'); return;
                }
            }
        }

        // --- Dashboard: search autofocus + arrow pagination (#12) ---
        if (dashboardActive) {
            const dashSearch = document.getElementById('dash-search');
            const isTyping = document.activeElement === dashSearch;
            if (e.key === 'ArrowLeft' && !isTyping) { e.preventDefault(); changeDashPage(-1); return; }
            if (e.key === 'ArrowRight' && !isTyping) { e.preventDefault(); changeDashPage(1); return; }
            if (!isTyping && e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                e.preventDefault(); dashSearch.focus(); dashSearch.value += e.key; handleDashSearch(); return;
            }
            if (!isTyping && e.key === 'Backspace') { e.preventDefault(); dashSearch.focus(); return; }
        }

        // --- Menu grid arrow navigation (#27) ---
        if (menuActive) {
            const cards = Array.from(document.querySelectorAll('.menu-card'));
            const focused = document.activeElement;
            const idx = cards.indexOf(focused);
            if (idx === -1) return;
            const cols = window.innerWidth >= 500 ? Math.round(cards.length / Math.ceil(cards.length / 2)) : 1;
            let next = -1;
            if (e.key === 'ArrowRight') next = Math.min(idx + 1, cards.length - 1);
            else if (e.key === 'ArrowLeft') next = Math.max(idx - 1, 0);
            else if (e.key === 'ArrowDown') next = Math.min(idx + cols, cards.length - 1);
            else if (e.key === 'ArrowUp') next = Math.max(idx - cols, 0);
            if (next !== -1) { e.preventDefault(); cards[next].focus(); return; }
        }

        // --- Workspace bindings ---
        if (!workspaceActive) return;

        const searchInput = document.getElementById('search-claim');
        const isTypingInSearch = document.activeElement === searchInput;

        // #11 — Arrow keys: paginate
        if (e.key === 'ArrowLeft' && !isTypingInSearch) { e.preventDefault(); changePage(-1); return; }
        if (e.key === 'ArrowRight' && !isTypingInSearch) { e.preventDefault(); changePage(1); return; }

        if (isTypingInSearch) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const firstRow = document.querySelector('#claims-tbody tr');
                if (firstRow) { searchInput.blur(); firstRow.click(); }
            }
            return;
        }

        if (e.key === 'Enter') {
            e.preventDefault();
            const firstRow = document.querySelector('#claims-tbody tr');
            if (firstRow) firstRow.click();
            return;
        }

        if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
            e.preventDefault(); searchInput.focus(); searchInput.value += e.key; handleSearch();
        }
        if (e.key === 'Backspace') { e.preventDefault(); searchInput.focus(); }
    });

    // ── Dropdown: clear kb-focus when dropdown closes ──
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-select-wrapper')) {
            document.querySelectorAll('.custom-option.kb-focus').forEach(o => o.classList.remove('kb-focus'));
        }
    }, true);

    let dashChartInstance = null;

    function toggleDashChart() {
        const container = document.getElementById('dash-chart-container');
        const btn = document.getElementById('btn-toggle-chart');
        const chartIcon = '<svg style="width:18px; height:18px; stroke:currentColor; stroke-width:2; fill:none; stroke-linecap:round; stroke-linejoin:round; vertical-align:middle; margin-right:4px;" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>';
        
        if (container.style.display === 'none' || container.style.display === '') {
            container.style.display = 'block';
            btn.innerHTML = chartIcon + ' Hide Chart';
            
            setTimeout(() => {
                renderDashChart();
            }, 50);
        } else {
            container.style.display = 'none';
            btn.innerHTML = chartIcon + ' Show Chart';
        }
    }

    function renderDashChart() {
        const ctx = document.getElementById('auditChart');
        if(!ctx) return;
        if (dashChartInstance) dashChartInstance.destroy();
        
        let cln = parseInt(document.getElementById('dash-clean').innerText) || 0;
        let unc = parseInt(document.getElementById('dash-unclear').innerText) || 0;
        let pen = parseInt(document.getElementById('dash-pending').innerText) || 0;

        dashChartInstance = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Clean', 'Unclear', 'Pending'],
                datasets: [{
                    data: [cln, unc, pen],
                    backgroundColor: ['#10b981', '#f59e0b', '#64748b'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { position: 'right', labels: { color: 'var(--text-main)' } } 
                } 
            }
        });
    }

    // Magic Trick: Filter change hone par chart apne aap update ho jayega!
    const originalApplyDashFilters = applyDashFilters;
    applyDashFilters = function() {
        originalApplyDashFilters();
        if (document.getElementById('dash-chart-container').style.display === 'block') {
            renderDashChart();
        }
    };

    // ══════════════════════════════════════════════════════════════
    // GOOGLE DRIVE CLOUD BACKUP & RESTORE — SMART CROSS-DEVICE
    // ══════════════════════════════════════════════════════════════
    const GDRIVE_CLIENT_ID = '740711070362-b0vjh0kgouuc3s27b7b8o136icj16d55.apps.googleusercontent.com';
    const GDRIVE_SCOPE = 'https://www.googleapis.com/auth/drive.appdata';
    const GDRIVE_BACKUP_FILENAME = 'warranty_auditor_backup.json';

    let _gdriveToken = null;
    let _gdriveTokenExpiry = 0;
    let _gdriveCloudInfo = null; // cached cloud backup info {fileId, savedAt, hasData}

    function isGdriveConnected() { return !!localStorage.getItem('gdrive_connected'); }
    function isGdriveTokenValid() { return _gdriveToken && Date.now() < _gdriveTokenExpiry - 60000; }

    // ── Get OAuth token (silent if possible, popup if needed) ──
    async function getGdriveToken(forcePrompt = false) {
        if (!forcePrompt && isGdriveTokenValid()) return _gdriveToken;
        return new Promise((resolve) => {
            try {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GDRIVE_CLIENT_ID,
                    scope: GDRIVE_SCOPE,
                    callback: (resp) => {
                        if (resp.error || !resp.access_token) { resolve(null); return; }
                        _gdriveToken = resp.access_token;
                        _gdriveTokenExpiry = Date.now() + (resp.expires_in * 1000);
                        resolve(_gdriveToken);
                    },
                    error_callback: () => resolve(null)
                });
                client.requestAccessToken({ prompt: forcePrompt ? 'select_account' : '' });
            } catch(e) { resolve(null); }
        });
    }

    // ── Search Drive for existing backup file ──
    async function findGdriveBackupFile(tok) {
        const r = await fetch(
            `https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${GDRIVE_BACKUP_FILENAME}'&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime+desc`,
            { headers: { 'Authorization': 'Bearer ' + tok } }
        );
        if (!r.ok) throw new Error('Could not search Drive.');
        const d = await r.json();
        return d.files && d.files.length > 0 ? d.files[0] : null;
    }

    // ── Connect — sign in + immediately check cloud state ──
    // Owner identity verification (hash-protected, not human-readable)
    const _ownerVerify = async (e) => (await sha256(e.toLowerCase().trim())) === '47f51db862f5e0714232e00b5669a3c152004576fac888a898c635be0f96cf91';

    async function connectGoogleDrive() {
        showLoader(true);
        try {
            const tok = await getGdriveToken(true);
            if (!tok) { showLoader(false); return showAppAlert("Google Sign-In cancelled or failed."); }

            // Get user info
            const ur = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': 'Bearer ' + tok } });
            if (!ur.ok) throw new Error("Could not verify Google account.");
            const user = await ur.json();

            // Verify identity
            const isOwner = await _ownerVerify(user.email || '');

            if (!isOwner) {
                // Non-owner must enter Client ID to proceed
                showLoader(false);
                showAppPrompt("Enter your Client ID to use Google Drive Sync:", false, async (clientId) => {
                    if (!clientId || clientId.trim().length < 3) {
                        return showAppAlert("Invalid Client ID. Access Denied.");
                    }
                    // Store with client ID tag
                    localStorage.setItem('gdrive_connected', 'true');
                    localStorage.setItem('gdrive_user_email', user.email || '');
                    localStorage.setItem('gdrive_user_name', user.name || '');
                    localStorage.setItem('gdrive_client_id', clientId.trim());
                    initGdriveUI();
                    await checkGdriveBackupStatus();
                });
                return;
            }

            // Owner - direct access
            localStorage.setItem('gdrive_connected', 'true');
            localStorage.setItem('gdrive_user_email', user.email || '');
            localStorage.setItem('gdrive_user_name', user.name || '');

            showLoader(false);
            initGdriveUI();
            // Auto check what's on cloud after connecting
            await checkGdriveBackupStatus();
        } catch(e) {
            showLoader(false);
            showAppAlert("Connection Failed: " + e.message);
        }
    }

    // ── Check what exists on Drive & update status card ──
    async function checkGdriveBackupStatus() {
        const statusBody = document.getElementById('gdrive-cloud-status-body');
        const hintBox = document.getElementById('gdrive-new-device-hint');
        const hintDate = document.getElementById('gdrive-hint-date');
        const restoreBtn = document.getElementById('gdrive-restore-btn');
        if (!statusBody) return;

        statusBody.innerHTML = '<div style="color:var(--text-muted);font-size:0.78rem;">Checking Drive...</div>';

        try {
            const tok = await getGdriveToken();
            if (!tok) { statusBody.innerHTML = '<div style="color:var(--danger);font-size:0.78rem;">Session expired. Please reconnect.</div>'; return; }

            const file = await findGdriveBackupFile(tok);
            _gdriveCloudInfo = file;

            if (file) {
                // Cloud backup exists — show details
                const modDate = new Date(file.modifiedTime);
                const dateStr = modDate.toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
                const sizeKB = file.size ? (file.size / 1024).toFixed(1) + ' KB' : '';
                const savedKey = 'gdrive_last_sync';
                localStorage.setItem(savedKey, dateStr);

                statusBody.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <svg style="width:18px;height:18px;stroke:var(--success);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        <div>
                            <div style="font-size:0.8rem;font-weight:700;color:var(--text-main);">Backup found on Drive</div>
                            <div style="font-size:0.7rem;color:var(--text-muted);">Saved: <b>${dateStr}</b>${sizeKB ? ' · ' + sizeKB : ''}</div>
                        </div>
                    </div>`;

                // Check if local data exists
                const localKeys = await localforage.keys();
                const hasLocalData = localKeys.some(k => k.startsWith('audit_'));
                if (!hasLocalData) {
                    // New device — no local data, show hint
                    if (hintBox) hintBox.style.display = 'block';
                    if (hintDate) hintDate.innerText = dateStr;
                    // Highlight restore button
                    if (restoreBtn) {
                        restoreBtn.style.background = '#10b981';
                        restoreBtn.style.borderColor = '#10b981';
                        restoreBtn.style.color = 'white';
                        restoreBtn.innerHTML = restoreBtn.innerHTML.replace('Restore from Drive', 'Restore from Drive');
                    }
                } else {
                    if (hintBox) hintBox.style.display = 'none';
                }
            } else {
                // No backup on Drive
                statusBody.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;">
                        <svg style="width:18px;height:18px;stroke:var(--text-muted);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;" viewBox="0 0 24 24"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                        <div>
                            <div style="font-size:0.8rem;font-weight:700;color:var(--text-main);">No backup on Drive yet</div>
                            <div style="font-size:0.7rem;color:var(--text-muted);">Click <b>"Backup to Drive"</b> from your main device first.</div>
                        </div>
                    </div>`;
                if (hintBox) hintBox.style.display = 'none';
                // Disable restore if no cloud file
                if (restoreBtn) {
                    restoreBtn.disabled = true;
                    restoreBtn.style.opacity = '0.4';
                    restoreBtn.title = 'No backup found on Drive. Upload first.';
                }
            }
        } catch(e) {
            statusBody.innerHTML = `<div style="color:var(--danger);font-size:0.78rem;">Error checking Drive: ${e.message}</div>`;
        }
    }

    // ── Backup to Drive ──
    async function uploadToGoogleDrive() {
        if (!isGdriveConnected()) return showAppAlert("Not connected to Google Drive.");
        showLoader(true);
        try {
            const tok = await getGdriveToken();
            if (!tok) { showLoader(false); return showAppAlert("Google session expired. Please reconnect."); }

            // Build full backup payload
            let bk = {};
            const ks = await localforage.keys();
            for (let k of ks) bk[k] = await localforage.getItem(k);
            bk['_secConfig'] = localStorage.getItem('auditor_sec') || '{}';
            bk['_theme'] = localStorage.getItem('auditor_theme') || 'light';
            bk['_customCodes'] = localStorage.getItem('auditor_custom_codes') || '{}';
            bk['_savedAt'] = new Date().toISOString(); // timestamp inside backup

            const content = JSON.stringify(bk);
            const ds = new Date().toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

            // Check if file already exists — update vs create
            const existingFile = _gdriveCloudInfo || await findGdriveBackupFile(tok);
            let uploadRes;

            if (existingFile) {
                // PATCH — update existing file content
                uploadRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${existingFile.id}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': 'Bearer ' + tok, 'Content-Type': 'application/json' },
                    body: content
                });
            } else {
                // POST — create new file in appDataFolder (hidden, private)
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify({ name: GDRIVE_BACKUP_FILENAME, parents: ['appDataFolder'] })], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/json' }));
                uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + tok }, body: form
                });
            }

            if (!uploadRes.ok) { const err = await uploadRes.json(); throw new Error(err.error?.message || 'Upload failed'); }
            const uploaded = await uploadRes.json();
            localStorage.setItem('gdrive_file_id', uploaded.id || existingFile?.id);
            localStorage.setItem('gdrive_last_sync', ds);
            _gdriveCloudInfo = null; // reset cache so next check is fresh

            showLoader(false);
            await checkGdriveBackupStatus(); // refresh status card
            showToast(`Backup saved to Google Drive — ${ds}`, 'success', 4000);
        } catch(e) {
            showLoader(false);
            showAppAlert("Upload Failed: " + e.message);
        }
    }

    // ── Restore from Drive — with pre-checks ──
    async function restoreFromGoogleDrive() {
        if (!isGdriveConnected()) return showAppAlert("Not connected to Google Drive.");

        // Check cloud first if we don't have cached info
        if (!_gdriveCloudInfo) {
            showLoader(true);
            try {
                const tok = await getGdriveToken();
                if (!tok) { showLoader(false); return showAppAlert("Google session expired. Please reconnect."); }
                _gdriveCloudInfo = await findGdriveBackupFile(tok);
                showLoader(false);
            } catch(e) { showLoader(false); return showAppAlert("Could not check Drive: " + e.message); }
        }

        if (!_gdriveCloudInfo) {
            return showAppAlert("No backup found on Google Drive. Upload from your main device first.");
        }

        // Show what will be restored
        const modDate = new Date(_gdriveCloudInfo.modifiedTime);
        const dateStr = modDate.toLocaleString('en-IN', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

        showAppConfirm(
            `Restore from Google Drive?\n\nBackup date: ${dateStr}\n\nThis will overwrite all local data on this device.`,
            async () => {
                showLoader(true);
                try {
                    const tok = await getGdriveToken();
                    if (!tok) { showLoader(false); return showAppAlert("Google session expired."); }

                    const dlRes = await fetch(`https://www.googleapis.com/drive/v3/files/${_gdriveCloudInfo.id}?alt=media`, {
                        headers: { 'Authorization': 'Bearer ' + tok }
                    });
                    if (!dlRes.ok) throw new Error("Could not download backup.");
                    const data = JSON.parse(await dlRes.text());

                    // Restore all data
                    await localforage.clear();
                    for (let k in data) {
                        if (k === '_secConfig') localStorage.setItem('auditor_sec', data[k]);
                        else if (k === '_theme') { localStorage.setItem('auditor_theme', data[k]); applyTheme(data[k]); }
                        else if (k === '_customCodes') localStorage.setItem('auditor_custom_codes', data[k]);
                        else if (k === '_savedAt' || k === '_autosync') { /* skip internal meta */ }
                        else await localforage.setItem(k, data[k]);
                    }
                    // Keep gdrive connection on this device
                    localStorage.setItem('gdrive_connected', 'true');
                    showLoader(false);
                    showAppAlert(`Restore complete. Data from ${dateStr} has been loaded. Reloading...`);
                    setTimeout(() => window.location.reload(), 2000);
                } catch(e) {
                    showLoader(false);
                    showAppAlert("Restore Failed: " + e.message);
                }
            }
        );
    }

    function disconnectGoogleDrive() {
        showAppConfirm("Disconnect Google Drive?\n\nYour cloud backup stays safe. Only this device's connection is removed.", () => {
            ['gdrive_connected', 'gdrive_user_email', 'gdrive_user_name', 'gdrive_file_id', 'gdrive_last_sync'].forEach(k => localStorage.removeItem(k));
            _gdriveToken = null; _gdriveTokenExpiry = 0; _gdriveCloudInfo = null;
            initGdriveUI();
            showAppAlert("Disconnected from Google Drive.");
        });
    }

    function initGdriveUI() {
        const setup = document.getElementById('gdrive-setup-section');
        const conn = document.getElementById('gdrive-connected-section');
        const dot = document.getElementById('gdrive-status-dot');
        if (!setup || !conn || !dot) return;

        if (isGdriveConnected()) {
            setup.style.display = 'none';
            conn.style.display = 'block';
            dot.innerText = 'Connected';
            dot.style.background = 'rgba(16,185,129,0.1)';
            dot.style.color = 'var(--success)';
            const email = localStorage.getItem('gdrive_user_email') || '';
            const name = localStorage.getItem('gdrive_user_name') || '';
            const infoEl = document.getElementById('gdrive-info-text');
            if (infoEl) infoEl.innerHTML = `Signed in as: <b>${name}</b><br><span style="font-family:monospace;color:var(--accent);font-size:0.78rem;">${email}</span>`;
            // Auto-check cloud status every time this screen opens
            setTimeout(checkGdriveBackupStatus, 300);
        } else {
            setup.style.display = 'block';
            conn.style.display = 'none';
            dot.innerText = 'Not Connected';
            dot.style.background = 'rgba(100,116,139,0.1)';
            dot.style.color = 'var(--text-muted)';
        }
    }

    const _oSSv3 = showScreen;
    showScreen = function(id) { _oSSv3(id); if (id === 'screen-backup') setTimeout(initGdriveUI, 80); };
    setTimeout(initGdriveUI, 900);
</script>
</body>
</html>